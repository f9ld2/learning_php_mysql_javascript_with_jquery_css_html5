---
layout: default
---

  <h2 class="title">Partitioning and Sharding</h2>
  <p class="para">
   Database clustering is done for various reasons. Clusters can improve availability,
   fault tolerance, and increase performance by applying a divide and conquer approach
   as work is distributed over many machines. Clustering is sometimes combined with
   partitioning and sharding to further break up a large complex task into
   smaller, more manageable units.
  </p>
  <p class="para">
   The mysqlnd_ms plugin aims to support a wide variety of MySQL database clusters. Some flavors of
   MySQL database clusters have built-in methods for partitioning and sharding,
   which could be transparent to use. The plugin supports the two most
   common approaches: MySQL Replication table filtering, and Sharding
   (application based partitioning).
  </p>
  <p class="para">
   MySQL Replication supports partitioning as filters that allow you to
   create slaves that replicate all or specific databases of the master, or tables.
   It is then in the responsibility of the application
   to choose a slave according to the filter rules. You can either use the
   mysqlnd_ms <em><a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.filter-node-groups" class="link">node_groups</a></em>
   filter to manually support this, or use the experimental table filter.
 </p>
 <p class="para">
   Manual partitioning or sharding is supported through the
   node grouping filter, and SQL hints as of 1.5.0. The node_groups filter
   lets you assign a symbolic name to a group of master and slave servers.
   In the example, the master <em>master_0</em> and <em>slave_0</em>
   form a group with the name <em>Partition_A</em>. It is entirely
   up to you to decide what makes up a group. For example, you may use node
   groups for sharding, and use the group names to address shards
   like <em>Shard_A_Range_0_100</em>.
 </p>
 <p class="para">
   <div class="example" id="example-2024">
    <p><strong>Example #1 Cluster node groups</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
  &quot;myapp&quot;: {
       &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;simulate_slave_failure&quot;,
                &quot;port&quot;: &quot;0&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;127.0.0.1&quot;,
                &quot;port&quot;: 3311
            }
        },
        &quot;filters&quot;: {
            &quot;node_groups&quot;: {
                &quot;Partition_A&quot; : {
                    &quot;master&quot;: [&quot;master_0&quot;],
                    &quot;slave&quot;: [&quot;slave_0&quot;]
                }
            },
           &quot;roundrobin&quot;: []
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-2025">
    <p><strong>Example #2 Manual partitioning using SQL hints</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$msg</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$hint&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&apos;&apos;</span><span style="color: #007700">)<br>{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Note:&#xA0;weak&#xA0;test,&#xA0;two&#xA0;connections&#xA0;to&#xA0;two&#xA0;servers&#xA0;may&#xA0;have&#xA0;the&#xA0;same&#xA0;thread&#xA0;id&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$sql&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;CONNECTION_ID()&#xA0;AS&#xA0;_thread,&#xA0;&apos;%s&apos;&#xA0;AS&#xA0;_hint&#xA0;FROM&#xA0;DUAL&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$msg</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$hint</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$sql&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$hint&#xA0;</span><span style="color: #007700">.&#xA0;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!(</span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$row&#xA0;</span><span style="color: #007700">=&#xA0;&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;%d&#xA0;-&#xA0;%s&#xA0;-&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_thread&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_hint&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;user&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;All&#xA0;slaves&#xA0;allowed&#xA0;*/<br></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;slave_0&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;slave_1&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">/*&#xA0;only&#xA0;servers&#xA0;of&#xA0;node&#xA0;group&#xA0;&quot;Partition_A&quot;&#xA0;allowed&#xA0;*/<br></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;slave_1&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;/*Partition_A*/&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;slave_1&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;/*Partition_A*/&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents screen">
<div class="cdata"><pre>
6804 - slave_0 - SELECT CONNECTION_ID() AS _thread, &apos;slave1&apos; AS _hint FROM DUAL
2442 - slave_1 - SELECT CONNECTION_ID() AS _thread, &apos;slave2&apos; AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, &apos;slave1&apos; AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, &apos;slave1&apos; AS _hint FROM DUAL
</pre></div>
    </div>
   </div>
  </p>
 <p class="para">
   By default, the plugin will use all configured master and slave servers for
   query execution. But if a query begins with a SQL hint like
   <em>/*node_group*/</em>, the plugin will only consider the servers
   listed in the <em>node_group</em> for query execution. Thus,
   <em>SELECT</em> queries prefixed with <em>/*Partition_A*/</em>
   will only be executed on <em>slave_0</em>.
  </p>

 