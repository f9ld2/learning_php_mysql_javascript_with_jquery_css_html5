---
layout: default
---

 <div class="refnamediv">
  <h1 class="refname">EventHttpConnection::setCloseCallback</h1>
  <p class="verinfo">(PECL event &gt;= 1.8.0)</p><p class="refpurpose"><span class="refname">EventHttpConnection::setCloseCallback</span> &#x2014; <span class="dc-title">Set callback for connection close</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-eventhttpconnection.setclosecallback-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span>
   <span class="type"><span class="type void">void</span></span> 
   <span class="methodname"><strong>EventHttpConnection::setCloseCallback</strong></span>
    ( <span class="methodparam">
    <span class="type"><a href="language.types.callable.html" class="type callable">callable</a></span>
     <code class="parameter">$callback</code>
   </span>
   [, <span class="methodparam">
    <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span>
     <code class="parameter">$data</code>
   </span>
  ] )</div>

  <p class="para rdfs-comment">
   Sets callback for connection close.
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-eventhttpconnection.setclosecallback-parameters">
  <h3 class="title">Parameters</h3>
  <dl>

   
    <dt>

     <code class="parameter">callback</code>
    </dt>

    <dd>

     <p class="para">
      Callback which is called when connection is closed. Should match the
      following prototype:
     </p>
     <div class="methodsynopsis dc-description">
      <span class="type"><span class="type void">void</span></span> 
      <span class="methodname"><strong>callback</strong></span>
       ([ <span class="methodparam">
       <span class="type"><a href="class.eventhttpconnection.html" class="type EventHttpConnection">EventHttpConnection</a></span>
        <code class="parameter">$conn</code>
       <span class="initializer"> = <strong><code>NULL</code></strong></span>
      </span>
      [, <span class="methodparam">
       <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span>
        <code class="parameter">$arg</code>
       <span class="initializer"> = <strong><code>NULL</code></strong></span>
      </span>
     ]] )</div>

    </dd>

   
  </dl>

 </div>

 <div class="refsect1 returnvalues" id="refsect1-eventhttpconnection.setclosecallback-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   No value is returned.
  </p>
 </div>

 <div class="refsect1 examples" id="refsect1-eventhttpconnection.setclosecallback-examples">
  <h3 class="title">Examples</h3>
  <div class="example" id="example-4852">
   <p><strong>Example #1 
    <span class="methodname"><strong>EventHttpConnection::setCloseCallback()</strong></span> example</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Setting&#xA0;up&#xA0;close-connection&#xA0;callback<br>&#xA0;*<br>&#xA0;*&#xA0;The&#xA0;script&#xA0;handles&#xA0;closed&#xA0;connections&#xA0;using&#xA0;HTTP&#xA0;API.<br>&#xA0;*<br>&#xA0;*&#xA0;Usage:<br>&#xA0;*&#xA0;1)&#xA0;Launch&#xA0;the&#xA0;server:<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;examples/http_closecb.php&#xA0;4242<br>&#xA0;*<br>&#xA0;*&#xA0;2)&#xA0;Launch&#xA0;a&#xA0;client&#xA0;in&#xA0;another&#xA0;terminal.&#xA0;Telnet-like<br>&#xA0;*&#xA0;session&#xA0;should&#xA0;look&#xA0;like&#xA0;the&#xA0;following:<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;nc&#xA0;-t&#xA0;127.0.0.1&#xA0;4242<br>&#xA0;*&#xA0;GET&#xA0;/&#xA0;HTTP/1.0<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*<br>&#xA0;*&#xA0;The&#xA0;server&#xA0;will&#xA0;output&#xA0;something&#xA0;similar&#xA0;to&#xA0;the&#xA0;following:<br>&#xA0;*<br>&#xA0;*&#xA0;HTTP/1.0&#xA0;200&#xA0;OK<br>&#xA0;*&#xA0;Content-Type:&#xA0;multipart/x-mixed-replace;boundary=boundarydonotcross<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*<br>&#xA0;*&#xA0;&lt;html&gt;<br>&#xA0;*<br>&#xA0;*&#xA0;3)&#xA0;Terminate&#xA0;the&#xA0;client&#xA0;connection&#xA0;abruptly,<br>&#xA0;*&#xA0;i.e.&#xA0;kill&#xA0;the&#xA0;process,&#xA0;or&#xA0;just&#xA0;press&#xA0;Ctrl-C.<br>&#xA0;*<br>&#xA0;*&#xA0;4)&#xA0;Check&#xA0;if&#xA0;the&#xA0;server&#xA0;called&#xA0;_close_callback.<br>&#xA0;*&#xA0;The&#xA0;script&#xA0;should&#xA0;output&#xA0;&quot;_close_callback&quot;&#xA0;string&#xA0;to&#xA0;standard&#xA0;output.<br>&#xA0;*<br>&#xA0;*&#xA0;5)&#xA0;Check&#xA0;if&#xA0;the&#xA0;server&apos;s&#xA0;process&#xA0;has&#xA0;no&#xA0;orphaned&#xA0;connections,<br>&#xA0;*&#xA0;e.g.&#xA0;with&#xA0;`lsof`&#xA0;utility.<br>&#xA0;*/<br><br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">_close_callback</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">)<br>{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_default</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$dummy</span><span style="color: #007700">)<br>{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$conn&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCloseCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;_close_callback&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*<br>&#xA0;&#xA0;&#xA0;&#xA0;By&#xA0;enabling&#xA0;Event::READ&#xA0;we&#xA0;protect&#xA0;the&#xA0;server&#xA0;against&#xA0;unclosed&#xA0;conections.<br>&#xA0;&#xA0;&#xA0;&#xA0;This&#xA0;is&#xA0;a&#xA0;peculiarity&#xA0;of&#xA0;Libevent.&#xA0;The&#xA0;library&#xA0;disables&#xA0;Event::READ&#xA0;events<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;on&#xA0;this&#xA0;connection,&#xA0;and&#xA0;the&#xA0;server&#xA0;is&#xA0;not&#xA0;notified&#xA0;about&#xA0;terminated<br>&#xA0;&#xA0;&#xA0;&#xA0;connections.<br><br>&#xA0;&#xA0;&#xA0;&#xA0;So&#xA0;each&#xA0;time&#xA0;client&#xA0;terminates&#xA0;connection&#xA0;abruptly,&#xA0;we&#xA0;get&#xA0;an&#xA0;orphaned<br>&#xA0;&#xA0;&#xA0;&#xA0;connection.&#xA0;For&#xA0;instance,&#xA0;the&#xA0;following&#xA0;is&#xA0;a&#xA0;part&#xA0;of&#xA0;`lsof&#xA0;-p&#xA0;$PID&#xA0;|&#xA0;grep&#xA0;TCP`<br>&#xA0;&#xA0;&#xA0;&#xA0;command&#xA0;after&#xA0;client&#xA0;has&#xA0;terminated&#xA0;connection:<br><br>&#xA0;&#xA0;&#xA0;&#xA0;57-php&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;15057&#xA0;ruslan&#xA0;&#xA0;6u&#xA0;&#xA0;unix&#xA0;0xffff8802fb59c780&#xA0;&#xA0;&#xA0;0t0&#xA0;&#xA0;125187&#xA0;socket<br>&#xA0;&#xA0;&#xA0;&#xA0;58:php&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;15057&#xA0;ruslan&#xA0;&#xA0;7u&#xA0;&#xA0;IPv4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;125189&#xA0;&#xA0;&#xA0;0t0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;TCP&#xA0;*:4242&#xA0;(LISTEN)<br>&#xA0;&#xA0;&#xA0;&#xA0;59:php&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;15057&#xA0;ruslan&#xA0;&#xA0;8u&#xA0;&#xA0;IPv4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;124342&#xA0;&#xA0;&#xA0;0t0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;TCP&#xA0;localhost:4242-&gt;localhost:37375&#xA0;(CLOSE_WAIT)<br><br>&#xA0;&#xA0;&#xA0;&#xA0;where&#xA0;$PID&#xA0;is&#xA0;our&#xA0;process&#xA0;ID.<br><br>&#xA0;&#xA0;&#xA0;&#xA0;The&#xA0;following&#xA0;block&#xA0;of&#xA0;code&#xA0;fixes&#xA0;such&#xA0;kind&#xA0;of&#xA0;orphaned&#xA0;connections.<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getBufferEvent</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;We&#xA0;have&#xA0;to&#xA0;free&#xA0;it&#xA0;explicitly.&#xA0;See</span>
</span>
</code></div>
    <span class="methodname"><a href="eventhttprequest.getconnection.html" class="methodname">EventHttpRequest::getConnection()</a></span>
<div class="phpcode"><code><span style="color: #000000">
$bev-&gt;free();&#xA0;//&#xA0;we&#xA0;have&#xA0;to&#xA0;free&#xA0;it&#xA0;explicitly<br><br>&#xA0;&#xA0;&#xA0;&#xA0;$req-&gt;addHeader(<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&apos;Content-Type&apos;,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&apos;multipart/x-mixed-replace;boundary=boundarydonotcross&apos;,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;EventHttpRequest::OUTPUT_HEADER<br>&#xA0;&#xA0;&#xA0;&#xA0;);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;$buf&#xA0;=&#xA0;new&#xA0;EventBuffer();<br>&#xA0;&#xA0;&#xA0;&#xA0;$buf-&gt;add(&apos;&lt;html&gt;&apos;);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;$req-&gt;sendReply(200,&#xA0;&quot;OK&quot;);<br>&#xA0;&#xA0;&#xA0;&#xA0;$req-&gt;sendReplyChunk($buf);<br>}<br><br>$port&#xA0;=&#xA0;4242;<br>if&#xA0;($argc&#xA0;&gt;&#xA0;1)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;$port&#xA0;=&#xA0;(int)&#xA0;$argv[1];<br>}<br>if&#xA0;($port&#xA0;&lt;=&#xA0;0&#xA0;||&#xA0;$port&#xA0;&gt;&#xA0;65535)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(&quot;Invalid&#xA0;port&quot;);<br>}<br><br>$base&#xA0;=&#xA0;new&#xA0;EventBase();<br>$http&#xA0;=&#xA0;new&#xA0;EventHttp($base);<br><br>$http-&gt;setDefaultCallback(&quot;_http_default&quot;,&#xA0;NULL);<br>$http-&gt;bind(&quot;0.0.0.0&quot;,&#xA0;$port);<br>$base-&gt;loop();<br><br>?&gt;</span>
</code></div>
   </div>

  </div>
 </div>

