---
layout: default
---

  <h2 class="title">Beyond TTL: user-defined storage</h2>
  <p class="para">
   The query cache plugin supports the use of user-defined storage handler.
   User-defined storage handler can use arbitrarily complex invalidation
   algorithms and support arbitrary storage media.
  </p>
  <p class="para">
   All user-defined storage handlers have to provide a certain interface.
   The functions of the user-defined storage handler will be called by the
   core of the cache plugin. The necessary interface consists of seven
   public functions. Both procedural and object oriented user-defined storage
   handler must implement the same set of functions.
  </p>
  <p class="para">
   <div class="example" id="example-2103">
    <p><strong>Example #1 Using a user-defined storage handler</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*&#xA0;Enable&#xA0;default&#xA0;caching&#xA0;of&#xA0;all&#xA0;statements&#xA0;*/<br></span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;mysqlnd_qc.cache_by_default&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">/*&#xA0;Procedural&#xA0;user&#xA0;defined&#xA0;storage&#xA0;handler&#xA0;functions&#xA0;*/<br><br></span><span style="color: #0000BB">$__cache&#xA0;</span><span style="color: #007700">=&#xA0;array();<br><br>function&#xA0;</span><span style="color: #0000BB">get_hash</span><span style="color: #007700">(</span><span style="color: #0000BB">$host_info</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$db</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">md5</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;%s%s%s%s%s&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$host_info</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$db</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">));<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">find_query_in_cache</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(isset(</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$tmp&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">];<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$tmp</span><span style="color: #007700">[</span><span style="color: #DD0000">&quot;valid_until&quot;</span><span style="color: #007700">]&#xA0;&lt;&#xA0;</span><span style="color: #0000BB">time</span><span style="color: #007700">())&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unset(</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ret&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ret&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">][</span><span style="color: #DD0000">&quot;data&quot;</span><span style="color: #007700">];<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ret&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">return_to_cache</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Called&#xA0;on&#xA0;cache&#xA0;hit&#xA0;after&#xA0;cached&#xA0;data&#xA0;has&#xA0;been&#xA0;processed,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;may&#xA0;be&#xA0;used&#xA0;for&#xA0;reference&#xA0;counting<br>&#xA0;&#xA0;&#xA0;&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">add_query_to_cache_if_not_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ttl</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$run_time</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$store_time</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row_count</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]&#xA0;=&#xA0;array(<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;data&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;row_count&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$row_count</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;valid_until&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">time</span><span style="color: #007700">()&#xA0;+&#xA0;</span><span style="color: #0000BB">$ttl</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;hits&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;run_time&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$run_time</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;store_time&quot;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$store_time</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;cached_run_times&quot;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;array(),<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;cached_store_times&quot;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;array(),<br>&#xA0;&#xA0;&#xA0;&#xA0;);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">query_is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(&apos;%s&apos;):&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ret&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">stristr</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;SELECT&quot;</span><span style="color: #007700">)&#xA0;!==&#xA0;</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;cache&#xA0;for&#xA0;5&#xA0;seconds&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ret&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">5</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;%s\n&quot;</span><span style="color: #007700">,&#xA0;(</span><span style="color: #0000BB">FALSE&#xA0;</span><span style="color: #007700">===&#xA0;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">)&#xA0;?&#xA0;</span><span style="color: #DD0000">&quot;FALSE&quot;&#xA0;</span><span style="color: #007700">:&#xA0;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">update_query_run_time_stats</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$run_time</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$store_time</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(isset(</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;hits&apos;</span><span style="color: #007700">]++;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">][</span><span style="color: #DD0000">&quot;cached_run_times&quot;</span><span style="color: #007700">][]&#xA0;=&#xA0;</span><span style="color: #0000BB">$run_time</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">][</span><span style="color: #DD0000">&quot;cached_store_times&quot;</span><span style="color: #007700">][]&#xA0;=&#xA0;</span><span style="color: #0000BB">$store_time</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">get_stats</span><span style="color: #007700">(</span><span style="color: #0000BB">$key&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$key&#xA0;</span><span style="color: #007700">&amp;&amp;&#xA0;isset(</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$stats&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">];<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$stats&#xA0;</span><span style="color: #007700">=&#xA0;array();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;foreach&#xA0;(</span><span style="color: #0000BB">$__cache&#xA0;</span><span style="color: #007700">as&#xA0;</span><span style="color: #0000BB">$key&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$details</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]&#xA0;=&#xA0;array(<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&apos;hits&apos;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;hits&apos;</span><span style="color: #007700">],<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&apos;bytes&apos;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;data&apos;</span><span style="color: #007700">]),<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&apos;uncached_run_time&apos;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;run_time&apos;</span><span style="color: #007700">],<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&apos;cached_run_time&apos;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;(</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;cached_run_times&apos;</span><span style="color: #007700">]))<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;?&#xA0;</span><span style="color: #0000BB">array_sum</span><span style="color: #007700">(</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;cached_run_times&apos;</span><span style="color: #007700">])&#xA0;/&#xA0;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$details</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;cached_run_times&apos;</span><span style="color: #007700">])<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;:&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">clear_cache</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;global&#xA0;</span><span style="color: #0000BB">$__cache</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\t%s(%d)\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">func_num_args</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$__cache&#xA0;</span><span style="color: #007700">=&#xA0;array();<br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Install&#xA0;procedural&#xA0;user-defined&#xA0;storage&#xA0;handler&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">mysqlnd_qc_set_user_handlers</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;get_hash&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;find_query_in_cache&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;return_to_cache&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;add_query_to_cache_if_not_exists&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;query_is_select&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;update_query_run_time_stats&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;get_stats&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;clear_cache&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;install&#xA0;user-defined&#xA0;storage&#xA0;handler\n&quot;</span><span style="color: #007700">);<br>}<br><br><br></span><span style="color: #FF8000">/*&#xA0;Connect,&#xA0;create&#xA0;and&#xA0;populate&#xA0;test&#xA0;table&#xA0;*/<br></span><span style="color: #0000BB">$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;host&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;user&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;schema&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;port&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;socket&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;DROP&#xA0;TABLE&#xA0;IF&#xA0;EXISTS&#xA0;test&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;CREATE&#xA0;TABLE&#xA0;test(id&#xA0;INT)&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;INSERT&#xA0;INTO&#xA0;test(id)&#xA0;VALUES&#xA0;(1),&#xA0;(2)&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\nCache&#xA0;put/cache&#xA0;miss\n&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;id&#xA0;FROM&#xA0;test&#xA0;WHERE&#xA0;id&#xA0;=&#xA0;1&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br><br></span><span style="color: #FF8000">/*&#xA0;Delete&#xA0;record&#xA0;to&#xA0;verify&#xA0;we&#xA0;get&#xA0;our&#xA0;data&#xA0;from&#xA0;the&#xA0;cache&#xA0;*/<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;DELETE&#xA0;FROM&#xA0;test&#xA0;WHERE&#xA0;id&#xA0;=&#xA0;1&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\nCache&#xA0;hit\n&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;id&#xA0;FROM&#xA0;test&#xA0;WHERE&#xA0;id&#xA0;=&#xA0;1&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br><br></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\nDisplay&#xA0;cache&#xA0;statistics\n&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">mysqlnd_qc_get_cache_info</span><span style="color: #007700">());<br><br></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;\nFlushing&#xA0;cache,&#xA0;cache&#xA0;put/cache&#xA0;miss&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">mysqlnd_qc_clear_cache</span><span style="color: #007700">());<br><br></span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;id&#xA0;FROM&#xA0;test&#xA0;WHERE&#xA0;id&#xA0;=&#xA0;1&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above examples will output
something similar to:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
        query_is_select(&apos;DROP TABLE IF EXISTS test&apos;): FALSE
        query_is_select(&apos;CREATE TABLE test(id INT)&apos;): FALSE
        query_is_select(&apos;INSERT INTO test(id) VALUES (1), (2)&apos;): FALSE

Cache put/cache miss
        query_is_select(&apos;SELECT id FROM test WHERE id = 1&apos;): 5
        get_hash(5)
        find_query_in_cache(1)
        add_query_to_cache_if_not_exists(6)
array(1) {
  [&quot;id&quot;]=&gt;
  string(1) &quot;1&quot;
}
        query_is_select(&apos;DELETE FROM test WHERE id = 1&apos;): FALSE

Cache hit
        query_is_select(&apos;SELECT id FROM test WHERE id = 1&apos;): 5
        get_hash(5)
        find_query_in_cache(1)
        return_to_cache(1)
        update_query_run_time_stats(3)
array(1) {
  [&quot;id&quot;]=&gt;
  string(1) &quot;1&quot;
}

Display cache statistics
        get_stats(0)
array(4) {
  [&quot;num_entries&quot;]=&gt;
  int(1)
  [&quot;handler&quot;]=&gt;
  string(4) &quot;user&quot;
  [&quot;handler_version&quot;]=&gt;
  string(5) &quot;1.0.0&quot;
  [&quot;data&quot;]=&gt;
  array(1) {
    [&quot;18683c177dc89bb352b29965d112fdaa&quot;]=&gt;
    array(4) {
      [&quot;hits&quot;]=&gt;
      int(1)
      [&quot;bytes&quot;]=&gt;
      int(71)
      [&quot;uncached_run_time&quot;]=&gt;
      int(398)
      [&quot;cached_run_time&quot;]=&gt;
      int(4)
    }
  }
}

Flushing cache, cache put/cache miss    clear_cache(0)
bool(true)
        query_is_select(&apos;SELECT id FROM test WHERE id = 1&apos;): 5
        get_hash(5)
        find_query_in_cache(1)
        add_query_to_cache_if_not_exists(6)
NULL

</pre></div>
    </div>
   </div>
  </p>
 