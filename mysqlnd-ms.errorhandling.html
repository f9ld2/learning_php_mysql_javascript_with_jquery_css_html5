---
layout: default
---

  <h2 class="title">Error handling</h2>
  <p class="para">
   Applications using PECL/mysqlnd_ms should implement proper error handling
   for all user API calls. And because the plugin changes the semantics
   of a connection handle, API calls may return unexpected errors. If using
   the plugin on a connection handle that no longer represents an individual network
   connection, but a connection pool, an error code and error message will
   be set on the connection handle whenever an error occurs on any of the network
   connections behind.
  </p>
  <p class="para">
   If using lazy connections, which is the default, connections are not
   opened until they are needed for query execution. Therefore,
   an API call for a statement execution may return a connection error.
   In the example below, an error is provoked when trying to run a statement on a slave.
   Opening a slave connection fails because the plugin configuration file
   lists an invalid host name for the slave.
  </p>
  <p class="para">
   <div class="example" id="example-2028">
    <p><strong>Example #1 Provoking a connection error</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;invalid_host_name&quot;,
            }
        },
        &quot;lazy_connections&quot;: 1
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   The explicit activation of lazy connections is for demonstration purpose only.
  </p>
  <p class="para">
   <div class="example" id="example-2029">
    <p><strong>Example #2 Connection error on query execution</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;username&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br>&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;1,&#xA0;connection&#xA0;bound&#xA0;SQL&#xA0;user&#xA0;variable,&#xA0;no&#xA0;SELECT&#xA0;thus&#xA0;run&#xA0;on&#xA0;master&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SET&#xA0;@myrole=&apos;master&apos;&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;2,&#xA0;run&#xA0;on&#xA0;slave&#xA0;because&#xA0;SELECT,&#xA0;provoke&#xA0;connection&#xA0;error&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!(</span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;@myrole&#xA0;AS&#xA0;_role&quot;</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}&#xA0;else&#xA0;{<br>&#xA0;</span><span style="color: #0000BB">$row&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br>&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;@myrole&#xA0;=&#xA0;&apos;%s&apos;\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_role&apos;</span><span style="color: #007700">]);<br>}<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

<div class="example-contents"><p>The above example will output
something similar to:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
[2002] php_network_getaddresses: getaddrinfo failed: Name or service not known
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Applications are expected to handle possible connection errors by
   implementing proper error handling.
  </p>
  <p class="para">
   Depending on the use case, applications may want to handle connection errors
   differently from other errors.  Typical connection errors are
   <em>2002 (CR_CONNECTION_ERROR) - Can&apos;t connect to local MySQL server through socket &apos;%s&apos; (%d)</em>,
   <em>2003 (CR_CONN_HOST_ERROR) - Can&apos;t connect to MySQL server on &apos;%s&apos; (%d)</em> and
   <em>2005 (CR_UNKNOWN_HOST) - Unknown MySQL server host &apos;%s&apos; (%d)</em>.
   For example, the application may test for the error codes and manually
   perform a fail over. The plugins philosophy is not to offer automatic fail over,
   beyond master fail over, because fail over is not a transparent operation.
  </p>
  <p class="para">
   <div class="example" id="example-2030">
    <p><strong>Example #3 Provoking a connection error</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;invalid_host_name&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;
            }
        },
        &quot;lazy_connections&quot;: 1,
        &quot;filters&quot;: {
            &quot;roundrobin&quot;: [

            ]
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   Explicitly activating lazy connections is done for demonstration purposes,
   as is round robin load balancing as opposed to the default <em>random once</em>
   type.
  </p>
  <p class="para">
   <div class="example" id="example-2031">
    <p><strong>Example #4 Most basic failover</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;username&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br>&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;1,&#xA0;connection&#xA0;bound&#xA0;SQL&#xA0;user&#xA0;variable,&#xA0;no&#xA0;SELECT&#xA0;thus&#xA0;run&#xA0;on&#xA0;master&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SET&#xA0;@myrole=&apos;master&apos;&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;2,&#xA0;first&#xA0;slave&#xA0;*/<br></span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;VERSION()&#xA0;AS&#xA0;_version&quot;</span><span style="color: #007700">);<br></span><span style="color: #FF8000">/*&#xA0;Hackish&#xA0;manual&#xA0;fail&#xA0;over&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(</span><span style="color: #0000BB">2002&#xA0;</span><span style="color: #007700">==&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">2003&#xA0;</span><span style="color: #007700">==&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">2004&#xA0;</span><span style="color: #007700">==&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;3,&#xA0;first&#xA0;slave&#xA0;connection&#xA0;failed,&#xA0;trying&#xA0;next&#xA0;slave&#xA0;*/<br>&#xA0;&#xA0;</span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;VERSION()&#xA0;AS&#xA0;_version&quot;</span><span style="color: #007700">);<br>}<br><br>if&#xA0;(!</span><span style="color: #0000BB">$res</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;ERROR,&#xA0;[%d]&#xA0;&apos;%s&apos;\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}&#xA0;else&#xA0;{<br>&#xA0;</span><span style="color: #FF8000">/*&#xA0;Error&#xA0;messages&#xA0;are&#xA0;taken&#xA0;from&#xA0;connection&#xA0;3,&#xA0;thus&#xA0;no&#xA0;error&#xA0;*/<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SUCCESS,&#xA0;[%d]&#xA0;&apos;%s&apos;\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>&#xA0;</span><span style="color: #0000BB">$row&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br>&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br>&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;version&#xA0;=&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_version&apos;</span><span style="color: #007700">]);<br>}<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

<div class="example-contents"><p>The above example will output
something similar to:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
[1045] Access denied for user &apos;username&apos;@&apos;localhost&apos; (using password: YES)
PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
SUCCESS, [0] &apos;&apos;
version = 5.6.2-m5-log
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   In some cases, it may not be easily possible to retrieve all errors that
   occur on all network connections through a connection handle. For example, let&apos;s assume a
   connection handle represents a pool of three open connections. One connection
   to a master and two connections to the slaves. The application changes the
   current database using the user API call <span class="function"><a href="mysqli.select-db.html" class="function">mysqli_select_db()</a></span>,
   which then calls the mysqlnd library function to change the schemata.
   mysqlnd_ms monitors the function, and tries to change the current
   database on all connections to harmonize their state. Now, assume the master succeeds
   in changing the database, and both slaves fail. Upon the initial error
   from the first slave, the plugin will set an appropriate error on the
   connection handle. The same is done when the second slave fails to change the
   database. The error message from the first slave is lost.
  </p>
  <p class="para">
   Such cases can be debugged by either checking for errors of the type
   <em>E_WARNING</em> (see above) or, if no other option, investigation
   of the <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.debugging" class="link">mysqlnd_ms debug and trace log</a>.
  </p>
 