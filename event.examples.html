---
layout: default
---

 <h1>Examples</h1>

 <div class="example" id="example-4816">
  <p><strong>Example #1 Simple HTTP client</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&#xA0;Read&#xA0;callback<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">readcb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//$input&#xA0;=&#xA0;$bev-&gt;input;&#xA0;//$bev-&gt;getInput();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;//$pos&#xA0;=&#xA0;$input-&gt;search(&quot;TTP&quot;);<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$pos&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">search</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;TTP&quot;</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;((</span><span style="color: #0000BB">$n&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">remove</span><span style="color: #007700">(</span><span style="color: #0000BB">$buf</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">1024</span><span style="color: #007700">))&#xA0;&gt;&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Event&#xA0;callback<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">eventcb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">CONNECTED</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Connected.\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;elseif&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;(</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">EOF</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;DNS&#xA0;error:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getDnsErrorString</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Closing\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Done\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">!=&#xA0;</span><span style="color: #0000BB">3</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;&lt;&lt;&lt;EOS<br></span><span style="color: #DD0000">Trivial&#xA0;HTTP&#xA0;0.x&#xA0;client<br>Syntax:&#xA0;php&#xA0;</span><span style="color: #007700">{</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]}</span><span style="color: #DD0000">&#xA0;[hostname]&#xA0;[resource]<br>Example:&#xA0;php&#xA0;</span><span style="color: #007700">{</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]}</span><span style="color: #DD0000">&#xA0;www.google.com&#xA0;/<br><br></span><span style="color: #007700">EOS;<br>&#xA0;&#xA0;&#xA0;&#xA0;exit();<br>}<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br><br></span><span style="color: #0000BB">$dns_base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventDnsBase</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">);&#xA0;</span><span style="color: #FF8000">//&#xA0;We&apos;ll&#xA0;use&#xA0;async&#xA0;DNS&#xA0;resolving<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$dns_base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;init&#xA0;DNS&#xA0;Base\n&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$bev&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #FF8000">/*&#xA0;use&#xA0;internal&#xA0;socket&#xA0;*/&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_DEFER_CALLBACKS</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;readcb&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #FF8000">/*&#xA0;writecb&#xA0;*/&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;eventcb&quot;<br></span><span style="color: #007700">);<br>if&#xA0;(!</span><span style="color: #0000BB">$bev</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;bufferevent&#xA0;socket\n&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">//$bev-&gt;setCallbacks(&quot;readcb&quot;,&#xA0;/*&#xA0;writecb&#xA0;*/&#xA0;NULL,&#xA0;&quot;eventcb&quot;,&#xA0;$base);<br></span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">WRITE</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$output&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">output</span><span style="color: #007700">;&#xA0;</span><span style="color: #FF8000">//$bev-&gt;getOutput();<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$output</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;GET&#xA0;</span><span style="color: #007700">{</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">2</span><span style="color: #007700">]}</span><span style="color: #DD0000">&#xA0;HTTP/1.0\r\n&quot;</span><span style="color: #007700">.<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;Host:&#xA0;</span><span style="color: #007700">{</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]}</span><span style="color: #DD0000">\r\n&quot;</span><span style="color: #007700">.<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;Connection:&#xA0;Close\r\n\r\n&quot;<br></span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;adding&#xA0;request&#xA0;to&#xA0;output&#xA0;buffer\n&quot;</span><span style="color: #007700">);<br>}<br><br>if&#xA0;(!</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connectHost</span><span style="color: #007700">(</span><span style="color: #0000BB">$dns_base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">80</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">AF_UNSPEC</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Can&apos;t&#xA0;connect&#xA0;to&#xA0;host&#xA0;</span><span style="color: #007700">{</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]}</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <div class="example-contents"><p>The above example will output
something similar to:</p></div>
  <div class="example-contents screen">
<div class="cdata"><pre>
Connected.
HTTP/1.1 301 Moved Permanently
Date: Fri, 01 Mar 2013 18:47:48 GMT
Location: http://www.google.co.uk/
Content-Type: text/html; charset=UTF-8
Cache-Control: public, max-age=2592000
Server: gws
Content-Length: 221
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
Age: 133438
Expires: Sat, 30 Mar 2013 05:39:28 GMT
Connection: close

&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;301 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;http://www.google.co.uk/&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
Closing
Done
</pre></div>
  </div>
 </div>
 <div class="example" id="example-4817">
  <p><strong>Example #2 HTTP client using asynchronous DNS resolver</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;1.&#xA0;Connect&#xA0;to&#xA0;127.0.0.1&#xA0;at&#xA0;port&#xA0;80<br>&#xA0;*&#xA0;by&#xA0;means&#xA0;of&#xA0;EventBufferEvent::connect().<br>&#xA0;*<br>&#xA0;*&#xA0;2.&#xA0;Request&#xA0;/index.cphp&#xA0;via&#xA0;HTTP/1.0<br>&#xA0;*&#xA0;using&#xA0;the&#xA0;output&#xA0;buffer.<br>&#xA0;*<br>&#xA0;*&#xA0;3.&#xA0;Asyncronously&#xA0;read&#xA0;the&#xA0;response&#xA0;and&#xA0;print&#xA0;it&#xA0;to&#xA0;stdout.<br>&#xA0;*/<br><br>//&#xA0;Read&#xA0;callback<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">readcb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$input&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInput</span><span style="color: #007700">();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;((</span><span style="color: #0000BB">$n&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$input</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">remove</span><span style="color: #007700">(</span><span style="color: #0000BB">$buf</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">1024</span><span style="color: #007700">))&#xA0;&gt;&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Event&#xA0;callback<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">eventcb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">CONNECTED</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Connected.\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;elseif&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;(</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">EOF</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;DNS&#xA0;error:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getDnsErrorString</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Closing\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Done\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;1\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$bev&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #FF8000">/*&#xA0;use&#xA0;internal&#xA0;socket&#xA0;*/&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_DEFER_CALLBACKS</span><span style="color: #007700">);<br>if&#xA0;(!</span><span style="color: #0000BB">$bev</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;bufferevent&#xA0;socket\n&quot;</span><span style="color: #007700">);<br>}<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;2\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;readcb&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #FF8000">/*&#xA0;writecb&#xA0;*/&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;eventcb&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">WRITE</span><span style="color: #007700">);<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;3\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #FF8000">//&#xA0;Send&#xA0;request<br></span><span style="color: #0000BB">$output&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOutput</span><span style="color: #007700">();<br>if&#xA0;(!</span><span style="color: #0000BB">$output</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;GET&#xA0;/index.cphp&#xA0;HTTP/1.0\r\n&quot;</span><span style="color: #007700">.<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;Connection:&#xA0;Close\r\n\r\n&quot;<br></span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;adding&#xA0;request&#xA0;to&#xA0;output&#xA0;buffer\n&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Connect&#xA0;to&#xA0;the&#xA0;host&#xA0;syncronously.<br>We&#xA0;know&#xA0;the&#xA0;IP,&#xA0;and&#xA0;don&apos;t&#xA0;need&#xA0;to&#xA0;resolve&#xA0;DNS.&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;127.0.0.1:80&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Can&apos;t&#xA0;connect&#xA0;to&#xA0;host\n&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Dispatch&#xA0;pending&#xA0;events<br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4818">
  <p><strong>Example #3 Echo server</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Simple&#xA0;echo&#xA0;server&#xA0;based&#xA0;on&#xA0;libevent&apos;s&#xA0;connection&#xA0;listener.<br>&#xA0;*<br>&#xA0;*&#xA0;Usage:<br>&#xA0;*&#xA0;1)&#xA0;In&#xA0;one&#xA0;terminal&#xA0;window&#xA0;run:<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;listener.php&#xA0;9881<br>&#xA0;*<br>&#xA0;*&#xA0;2)&#xA0;In&#xA0;another&#xA0;terminal&#xA0;window&#xA0;open&#xA0;up&#xA0;connection,&#xA0;e.g.:<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;nc&#xA0;127.0.0.1&#xA0;9881<br>&#xA0;*<br>&#xA0;*&#xA0;3)&#xA0;start&#xA0;typing.&#xA0;The&#xA0;server&#xA0;should&#xA0;repeat&#xA0;the&#xA0;input.<br>&#xA0;*/<br><br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">MyListenerConnection&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;private&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;echoReadCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;echoEventCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;enable&#xA0;READ\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;return;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">echoReadCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;Copy&#xA0;all&#xA0;the&#xA0;data&#xA0;from&#xA0;the&#xA0;input&#xA0;buffer&#xA0;to&#xA0;the&#xA0;output&#xA0;buffer<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;//&#xA0;Variant&#xA0;#1<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">output</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addBuffer</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Variant&#xA0;#2&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;/*<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$input&#xA0;&#xA0;&#xA0;&#xA0;=&#xA0;$bev-&gt;getInput();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$output&#xA0;=&#xA0;$bev-&gt;getOutput();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$output-&gt;addBuffer($input);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">echoEventCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Error&#xA0;from&#xA0;bufferevent\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;(</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">EOF&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//$bev-&gt;free();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>class&#xA0;</span><span style="color: #0000BB">MyListener&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$socket</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;private&#xA0;</span><span style="color: #0000BB">$conn&#xA0;</span><span style="color: #007700">=&#xA0;array();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;foreach&#xA0;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">conn&#xA0;</span><span style="color: #007700">as&#xA0;&amp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">)&#xA0;</span><span style="color: #0000BB">$c&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$port</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;open&#xA0;event&#xA0;base&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;Variant&#xA0;#1<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;/*<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$this-&gt;socket&#xA0;=&#xA0;socket_create(AF_INET,&#xA0;SOCK_STREAM,&#xA0;SOL_TCP);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!socket_bind($this-&gt;socket,&#xA0;&apos;0.0.0.0&apos;,&#xA0;$port))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;&quot;Unable&#xA0;to&#xA0;bind&#xA0;socket\n&quot;;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(1);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$this-&gt;listener&#xA0;=&#xA0;new&#xA0;EventListener($this-&gt;base,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array($this,&#xA0;&quot;acceptConnCallback&quot;),&#xA0;$this-&gt;base,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;EventListener::OPT_CLOSE_ON_FREE&#xA0;|&#xA0;EventListener::OPT_REUSEABLE,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;-1,&#xA0;$this-&gt;socket);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;*/<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;//&#xA0;Variant&#xA0;#2<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;acceptConnCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_REUSEABLE</span><span style="color: #007700">,&#xA0;-</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;0.0.0.0:</span><span style="color: #0000BB">$port</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;create&#xA0;listener&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;accept_error_cb&quot;</span><span style="color: #007700">));<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;there&#xA0;is&#xA0;data&#xA0;to&#xA0;read&#xA0;on&#xA0;$bev<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">public&#xA0;function&#xA0;</span><span style="color: #0000BB">acceptConnCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;We&#xA0;got&#xA0;a&#xA0;new&#xA0;connection!&#xA0;Set&#xA0;up&#xA0;a&#xA0;bufferevent&#xA0;for&#xA0;it.&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">conn</span><span style="color: #007700">[]&#xA0;=&#xA0;new&#xA0;</span><span style="color: #0000BB">MyListenerConnection</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">fprintf</span><span style="color: #007700">(</span><span style="color: #0000BB">STDERR</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;Got&#xA0;an&#xA0;error&#xA0;%d&#xA0;(%s)&#xA0;on&#xA0;the&#xA0;listener.&#xA0;&quot;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;Shutting&#xA0;down.\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketErrno</span><span style="color: #007700">(),<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketError</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">9808</span><span style="color: #007700">;<br><br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br>}<br>if&#xA0;(</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">0&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">65535</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Invalid&#xA0;port&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$l&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">MyListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$port</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$l</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4819">
  <p><strong>Example #4 SSL echo server</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;SSL&#xA0;echo&#xA0;server<br>&#xA0;*<br>&#xA0;*&#xA0;To&#xA0;test:<br>&#xA0;*&#xA0;1)&#xA0;Run:<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;examples/ssl-echo-server/server.php&#xA0;9998<br>&#xA0;*<br>&#xA0;*&#xA0;2)&#xA0;in&#xA0;another&#xA0;terminal&#xA0;window&#xA0;run:<br>&#xA0;*&#xA0;$&#xA0;socat&#xA0;-&#xA0;SSL:127.0.0.1:9998,verify=1,cafile=examples/ssl-echo-server/cert.pem<br>&#xA0;*/<br><br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">MySslEchoServer&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct&#xA0;</span><span style="color: #007700">(</span><span style="color: #0000BB">$port</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$host&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;127.0.0.1&quot;</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">init_ssl</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;SSL&#xA0;context\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;open&#xA0;event&#xA0;base\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;ssl_accept_cb&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_REUSEABLE</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;-</span><span style="color: #0000BB">1</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;</span><span style="color: #0000BB">$host</span><span style="color: #DD0000">:</span><span style="color: #0000BB">$port</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;create&#xA0;listener\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;accept_error_cb&quot;</span><span style="color: #007700">));<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;function&#xA0;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;there&#xA0;is&#xA0;data&#xA0;to&#xA0;read&#xA0;on&#xA0;$bev.<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">ssl_read_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$in&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">;&#xA0;</span><span style="color: #FF8000">//$bev-&gt;getInput();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Received&#xA0;%zu&#xA0;bytes\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$in</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;-----&#xA0;data&#xA0;----\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;%ld:\t%s\n&quot;</span><span style="color: #007700">,&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$in</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$in</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">pullup</span><span style="color: #007700">(-</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">writeBuffer</span><span style="color: #007700">(</span><span style="color: #0000BB">$in</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;some&#xA0;even&#xA0;occurs&#xA0;on&#xA0;the&#xA0;event&#xA0;listener,<br>&#xA0;&#xA0;&#xA0;&#xA0;//&#xA0;e.g.&#xA0;connection&#xA0;closed,&#xA0;or&#xA0;an&#xA0;error&#xA0;occured<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">ssl_event_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;Fetch&#xA0;errors&#xA0;from&#xA0;the&#xA0;SSL&#xA0;error&#xA0;stack<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">while&#xA0;(</span><span style="color: #0000BB">$err&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sslError</span><span style="color: #007700">())&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">fprintf</span><span style="color: #007700">(</span><span style="color: #0000BB">STDERR</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;Bufferevent&#xA0;error&#xA0;%s.\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$err</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;(</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">EOF&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;a&#xA0;client&#xA0;accepts&#xA0;new&#xA0;connection<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">ssl_accept_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;We&#xA0;got&#xA0;a&#xA0;new&#xA0;connection!&#xA0;Set&#xA0;up&#xA0;a&#xA0;bufferevent&#xA0;for&#xA0;it.<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">sslSocket</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">SSL_ACCEPTING</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;ssl&#xA0;buffer\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;ssl_read_cb&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;ssl_event_cb&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;we&#xA0;failed&#xA0;to&#xA0;setup&#xA0;new&#xA0;connection&#xA0;for&#xA0;a&#xA0;client<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">fprintf</span><span style="color: #007700">(</span><span style="color: #0000BB">STDERR</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;Got&#xA0;an&#xA0;error&#xA0;%d&#xA0;(%s)&#xA0;on&#xA0;the&#xA0;listener.&#xA0;&quot;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;Shutting&#xA0;down.\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketErrno</span><span style="color: #007700">(),<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketError</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;Initialize&#xA0;SSL&#xA0;structures,&#xA0;create&#xA0;an&#xA0;EventSslContext<br>&#xA0;&#xA0;&#xA0;&#xA0;//&#xA0;Optionally&#xA0;create&#xA0;self-signed&#xA0;certificates<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">init_ssl</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;We&#xA0;*must*&#xA0;have&#xA0;entropy.&#xA0;Otherwise&#xA0;there&apos;s&#xA0;no&#xA0;point&#xA0;to&#xA0;crypto.<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">sslRandPoll</span><span style="color: #007700">())&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;EventUtil::sslRandPoll&#xA0;failed\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$local_cert&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;/cert.pem&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$local_pk&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;/privkey.pem&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$local_cert</span><span style="color: #007700">)&#xA0;||&#xA0;!</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$local_pk</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;read&#xA0;</span><span style="color: #0000BB">$local_cert</span><span style="color: #DD0000">&#xA0;or&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #DD0000">&#xA0;file.&#xA0;&#xA0;To&#xA0;generate&#xA0;a&#xA0;key\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;and&#xA0;self-signed&#xA0;certificate,&#xA0;run:\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;&#xA0;&#xA0;openssl&#xA0;genrsa&#xA0;-out&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #DD0000">&#xA0;2048\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;&#xA0;&#xA0;openssl&#xA0;req&#xA0;-new&#xA0;-key&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #DD0000">&#xA0;-out&#xA0;cert.req\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;&#xA0;&#xA0;openssl&#xA0;x509&#xA0;-req&#xA0;-days&#xA0;365&#xA0;-in&#xA0;cert.req&#xA0;-signkey&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #DD0000">&#xA0;-out&#xA0;</span><span style="color: #0000BB">$local_cert</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ctx&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">(</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">SSLv3_SERVER_METHOD</span><span style="color: #007700">,&#xA0;array&#xA0;(<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_CERT&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$local_cert</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_PK&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE&#xA0;&#xA0;=&gt;&#xA0;&quot;echo&#xA0;server&quot;,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_VERIFY_PEER&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">true</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_ALLOW_SELF_SIGNED&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">false</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;));<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Allow&#xA0;to&#xA0;override&#xA0;the&#xA0;port<br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">9999</span><span style="color: #007700">;<br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br>}<br>if&#xA0;(</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">0&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">65535</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Invalid&#xA0;port\n&quot;</span><span style="color: #007700">);<br>}<br><br><br></span><span style="color: #0000BB">$l&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">MySslEchoServer</span><span style="color: #007700">(</span><span style="color: #0000BB">$port</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$l</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4820">
  <p><strong>Example #5 Signal handler</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>Launch&#xA0;it&#xA0;in&#xA0;a&#xA0;terminal&#xA0;window:<br><br>$&#xA0;php&#xA0;examples/signal.php<br><br>In&#xA0;another&#xA0;terminal&#xA0;window&#xA0;find&#xA0;out&#xA0;the&#xA0;pid&#xA0;and&#xA0;send&#xA0;SIGTERM,&#xA0;e.g.:<br><br>$&#xA0;ps&#xA0;aux&#xA0;|&#xA0;grep&#xA0;examp<br>ruslan&#xA0;&#xA0;&#xA0;&#xA0;3976&#xA0;&#xA0;0.2&#xA0;&#xA0;0.0&#xA0;139896&#xA0;11256&#xA0;pts/1&#xA0;&#xA0;&#xA0;&#xA0;S+&#xA0;&#xA0;&#xA0;10:25&#xA0;&#xA0;&#xA0;0:00&#xA0;php&#xA0;examples/signal.php<br>ruslan&#xA0;&#xA0;&#xA0;&#xA0;3978&#xA0;&#xA0;0.0&#xA0;&#xA0;0.0&#xA0;&#xA0;&#xA0;9572&#xA0;&#xA0;&#xA0;864&#xA0;pts/2&#xA0;&#xA0;&#xA0;&#xA0;S+&#xA0;&#xA0;&#xA0;10:26&#xA0;&#xA0;&#xA0;0:00&#xA0;grep&#xA0;--color=auto&#xA0;examp<br>$&#xA0;kill&#xA0;-TERM&#xA0;3976<br><br>At&#xA0;the&#xA0;first&#xA0;terminal&#xA0;window&#xA0;you&#xA0;should&#xA0;catch&#xA0;the&#xA0;following:<br><br>Caught&#xA0;signal&#xA0;15<br>*/<br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">MyEventSignal&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;private&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;function&#xA0;</span><span style="color: #0000BB">eventSighandler</span><span style="color: #007700">(</span><span style="color: #0000BB">$no</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$c</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Caught&#xA0;signal&#xA0;</span><span style="color: #0000BB">$no</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">event_base_loopexit</span><span style="color: #007700">(</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">event_base_new</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$c&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">MyEventSignal</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$no&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">SIGTERM</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$ev&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">evsignal_new</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$no</span><span style="color: #007700">,&#xA0;array(</span><span style="color: #0000BB">$c</span><span style="color: #007700">,</span><span style="color: #DD0000">&apos;eventSighandler&apos;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">$c</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">evsignal_add</span><span style="color: #007700">(</span><span style="color: #0000BB">$ev</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">event_base_loop</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4821">
  <p><strong>Example #6 Use libevent&apos;s loop to process requests of `eio&apos; extension</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&#xA0;Callback&#xA0;for&#xA0;eio_nop()<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">my_nop_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$d</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$r</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;6\n&quot;</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">$dir&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;/tmp/abc-eio-temp&quot;</span><span style="color: #007700">;<br>if&#xA0;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$dir</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">rmdir</span><span style="color: #007700">(</span><span style="color: #0000BB">$dir</span><span style="color: #007700">);<br>}<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;1\n&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;2\n&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">eio_init</span><span style="color: #007700">();<br><br></span><span style="color: #0000BB">eio_mkdir</span><span style="color: #007700">(</span><span style="color: #0000BB">$dir</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">0750</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EIO_PRI_DEFAULT</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;my_nop_cb&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$event&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">eio_get_event_stream</span><span style="color: #007700">(),<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">PERSIST</span><span style="color: #007700">,&#xA0;function&#xA0;(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;5\n&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;(</span><span style="color: #0000BB">eio_nreqs</span><span style="color: #007700">())&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">eio_poll</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">stop</span><span style="color: #007700">();<br>},&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;3\n&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">();<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;step&#xA0;4\n&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;Done\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4822">
  <p><strong>Example #7 Miscellaneous</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*&#xA0;{{{&#xA0;Config&#xA0;&amp;&#xA0;supported&#xA0;stuff&#xA0;*/<br></span><span style="color: #007700">echo&#xA0;</span><span style="color: #DD0000">&quot;Supported&#xA0;methods:\n&quot;</span><span style="color: #007700">;<br>foreach&#xA0;(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">getSupportedMethods</span><span style="color: #007700">()&#xA0;as&#xA0;</span><span style="color: #0000BB">$m</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$m</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Avoiding&#xA0;&quot;select&quot;&#xA0;method<br></span><span style="color: #0000BB">$cfg&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">();<br>if&#xA0;(</span><span style="color: #0000BB">$cfg</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">avoidMethod</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;select&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;`select&apos;&#xA0;method&#xA0;avoided\n&quot;</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #FF8000">//&#xA0;Create&#xA0;event_base&#xA0;associated&#xA0;with&#xA0;the&#xA0;config<br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">(</span><span style="color: #0000BB">$cfg</span><span style="color: #007700">);<br>echo&#xA0;</span><span style="color: #DD0000">&quot;Event&#xA0;method&#xA0;used:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getMethod</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;Features:\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$features&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getFeatures</span><span style="color: #007700">();<br>(</span><span style="color: #0000BB">$features&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">::</span><span style="color: #0000BB">FEATURE_ET</span><span style="color: #007700">)&#xA0;and&#xA0;print(</span><span style="color: #DD0000">&quot;ET&#xA0;-&#xA0;edge-triggered&#xA0;IO\n&quot;</span><span style="color: #007700">);<br>(</span><span style="color: #0000BB">$features&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">::</span><span style="color: #0000BB">FEATURE_O1</span><span style="color: #007700">)&#xA0;and&#xA0;print(</span><span style="color: #DD0000">&quot;O1&#xA0;-&#xA0;O(1)&#xA0;operation&#xA0;for&#xA0;adding/deletting&#xA0;events\n&quot;</span><span style="color: #007700">);<br>(</span><span style="color: #0000BB">$features&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">::</span><span style="color: #0000BB">FEATURE_FDS</span><span style="color: #007700">)&#xA0;and&#xA0;print(</span><span style="color: #DD0000">&quot;FDS&#xA0;-&#xA0;arbitrary&#xA0;file&#xA0;descriptor&#xA0;types,&#xA0;and&#xA0;not&#xA0;just&#xA0;sockets\n&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">//&#xA0;Require&#xA0;FDS&#xA0;feature<br></span><span style="color: #007700">if&#xA0;(</span><span style="color: #0000BB">$cfg</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">requireFeatures</span><span style="color: #007700">(</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">::</span><span style="color: #0000BB">FEATURE_FDS</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;FDS&#xA0;feature&#xA0;is&#xA0;now&#xA0;requried\n&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">(</span><span style="color: #0000BB">$cfg</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;(</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getFeatures</span><span style="color: #007700">()&#xA0;&amp;&#xA0;</span><span style="color: #0000BB">EventConfig</span><span style="color: #007700">::</span><span style="color: #0000BB">FEATURE_FDS</span><span style="color: #007700">)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;and&#xA0;print(</span><span style="color: #DD0000">&quot;FDS&#xA0;-&#xA0;arbitrary&#xA0;file&#xA0;descriptor&#xA0;types,&#xA0;and&#xA0;not&#xA0;just&#xA0;sockets\n&quot;</span><span style="color: #007700">);<br>}<br></span><span style="color: #FF8000">/*&#xA0;}}}&#xA0;*/<br><br>/*&#xA0;{{{&#xA0;Base&#xA0;*/<br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$event&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">STDIN</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">PERSIST</span><span style="color: #007700">,&#xA0;function&#xA0;(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$arg</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$max_iterations&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(++</span><span style="color: #0000BB">$max_iterations&#xA0;</span><span style="color: #007700">&gt;=&#xA0;</span><span style="color: #0000BB">5</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;exit&#xA0;after&#xA0;5&#xA0;iterations&#xA0;with&#xA0;timeout&#xA0;of&#xA0;2.33&#xA0;seconds&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">echo&#xA0;</span><span style="color: #DD0000">&quot;Stopping...\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$arg</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">2.33</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">fgets</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">);<br>},&#xA0;array&#xA0;(&amp;</span><span style="color: #0000BB">$base</span><span style="color: #007700">));<br><br></span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loop</span><span style="color: #007700">();<br></span><span style="color: #FF8000">/*&#xA0;Base&#xA0;}}}&#xA0;*/<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4823">
  <p><strong>Example #8 Simple HTTP server</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Simple&#xA0;HTTP&#xA0;server.<br>&#xA0;*<br>&#xA0;*&#xA0;To&#xA0;test&#xA0;it:<br>&#xA0;*&#xA0;1)&#xA0;Run&#xA0;it&#xA0;on&#xA0;a&#xA0;port&#xA0;of&#xA0;your&#xA0;choice,&#xA0;e.g.:<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;examples/http.php&#xA0;8010<br>&#xA0;*&#xA0;2)&#xA0;In&#xA0;another&#xA0;terminal&#xA0;connect&#xA0;to&#xA0;some&#xA0;address&#xA0;on&#xA0;this&#xA0;port<br>&#xA0;*&#xA0;and&#xA0;make&#xA0;GET&#xA0;or&#xA0;POST&#xA0;request(others&#xA0;are&#xA0;turned&#xA0;off&#xA0;here),&#xA0;e.g.:<br>&#xA0;*&#xA0;$&#xA0;nc&#xA0;-t&#xA0;127.0.0.1&#xA0;8010<br>&#xA0;*&#xA0;POST&#xA0;/about&#xA0;HTTP/1.0<br>&#xA0;*&#xA0;Content-Type:&#xA0;text/plain<br>&#xA0;*&#xA0;Content-Length:&#xA0;4<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*&#xA0;(press&#xA0;Enter)<br>&#xA0;*<br>&#xA0;*&#xA0;It&#xA0;will&#xA0;output<br>&#xA0;*&#xA0;a=12<br>&#xA0;*&#xA0;HTTP/1.0&#xA0;200&#xA0;OK<br>&#xA0;*&#xA0;Content-Type:&#xA0;text/html;&#xA0;charset=ISO-8859-1<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;nc&#xA0;-t&#xA0;127.0.0.1&#xA0;8010<br>&#xA0;*&#xA0;GET&#xA0;/dump&#xA0;HTTP/1.0<br>&#xA0;*&#xA0;Content-Type:&#xA0;text/plain<br>&#xA0;*&#xA0;Content-Encoding:&#xA0;UTF-8<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*&#xA0;(press&#xA0;Enter)<br>&#xA0;*<br>&#xA0;*&#xA0;It&#xA0;will&#xA0;output:<br>&#xA0;*&#xA0;HTTP/1.0&#xA0;200&#xA0;OK<br>&#xA0;*&#xA0;Content-Type:&#xA0;text/html;&#xA0;charset=ISO-8859-1<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*&#xA0;(press&#xA0;Enter)<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;nc&#xA0;-t&#xA0;127.0.0.1&#xA0;8010<br>&#xA0;*&#xA0;GET&#xA0;/unknown&#xA0;HTTP/1.0<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*<br>&#xA0;*&#xA0;It&#xA0;will&#xA0;output:<br>&#xA0;*&#xA0;HTTP/1.0&#xA0;200&#xA0;OK<br>&#xA0;*&#xA0;Content-Type:&#xA0;text/html;&#xA0;charset=ISO-8859-1<br>&#xA0;*&#xA0;Connection:&#xA0;close<br>&#xA0;*<br>&#xA0;*&#xA0;3)&#xA0;See&#xA0;what&#xA0;the&#xA0;server&#xA0;outputs&#xA0;on&#xA0;the&#xA0;previous&#xA0;terminal&#xA0;window.<br>&#xA0;*/<br><br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">_http_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$counter&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$max_requests&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">2</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(++</span><span style="color: #0000BB">$counter&#xA0;</span><span style="color: #007700">&gt;=&#xA0;</span><span style="color: #0000BB">$max_requests</span><span style="color: #007700">)&#xA0;&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Counter&#xA0;reached&#xA0;max&#xA0;requests&#xA0;</span><span style="color: #0000BB">$max_requests</span><span style="color: #DD0000">.&#xA0;Exiting\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;&#xA0;called\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;request:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;data:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n=====&#xA0;DUMP&#xA0;=====\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Command:&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getCommand</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Input&#xA0;headers:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputHeaders</span><span style="color: #007700">());<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Output&#xA0;headers:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOutputHeaders</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Reading&#xA0;input&#xA0;buffer&#xA0;...\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$buf&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputBuffer</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;(</span><span style="color: #0000BB">$s&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">readLine</span><span style="color: #007700">(</span><span style="color: #0000BB">EventBuffer</span><span style="color: #007700">::</span><span style="color: #0000BB">EOL_ANY</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$s</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;No&#xA0;more&#xA0;data&#xA0;in&#xA0;the&#xA0;buffer\n&quot;</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_about</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_default</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">8010</span><span style="color: #007700">;<br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br>}<br>if&#xA0;(</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">0&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">65535</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Invalid&#xA0;port&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$http&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttp</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setAllowedMethods</span><span style="color: #007700">(</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_GET&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_POST</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/dump&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;_http_dump&quot;</span><span style="color: #007700">,&#xA0;array(</span><span style="color: #0000BB">4</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">8</span><span style="color: #007700">));<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/about&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;_http_about&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setDefaultCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;_http_default&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;custom&#xA0;data&#xA0;value&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bind</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;0.0.0.0&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">8010</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loop</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

   <div class="example-contents"><p>The above example will output
something similar to:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
a=12
HTTP/1.0 200 OK
Content-Type: text/html; charset=ISO-8859-1
Connection: close

HTTP/1.0 200 OK
Content-Type: text/html; charset=ISO-8859-1
Connection: close
(press Enter)

HTTP/1.0 200 OK
Content-Type: text/html; charset=ISO-8859-1
Connection: close
</pre></div>
  </div>
 </div>
 <div class="example" id="example-4824">
  <p><strong>Example #9 Simple HTTPS server</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Simple&#xA0;HTTPS&#xA0;server.<br>&#xA0;*<br>&#xA0;*&#xA0;1)&#xA0;Run&#xA0;the&#xA0;server:&#xA0;`php&#xA0;examples/https.php&#xA0;9999`<br>&#xA0;*&#xA0;2)&#xA0;Test&#xA0;it:&#xA0;`php&#xA0;examples/ssl-connection.php&#xA0;9999`<br>&#xA0;*/<br><br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">_http_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$counter&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$max_requests&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">200</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(++</span><span style="color: #0000BB">$counter&#xA0;</span><span style="color: #007700">&gt;=&#xA0;</span><span style="color: #0000BB">$max_requests</span><span style="color: #007700">)&#xA0;&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Counter&#xA0;reached&#xA0;max&#xA0;requests&#xA0;</span><span style="color: #0000BB">$max_requests</span><span style="color: #DD0000">.&#xA0;Exiting\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;&#xA0;called\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;request:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;data:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n=====&#xA0;DUMP&#xA0;=====\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Command:&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getCommand</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Input&#xA0;headers:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputHeaders</span><span style="color: #007700">());<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Output&#xA0;headers:&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOutputHeaders</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$buf&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputBuffer</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Reading&#xA0;input&#xA0;buffer&#xA0;(&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;)&#xA0;...\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;(</span><span style="color: #0000BB">$s&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">1024</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$s</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\nNo&#xA0;more&#xA0;data&#xA0;in&#xA0;the&#xA0;buffer\n&quot;</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_about</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_default</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__METHOD__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;URI:&#xA0;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getUri</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;\n&#xA0;&gt;&gt;&#xA0;Sending&#xA0;reply&#xA0;...&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendReply</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;OK&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;OK\n&quot;</span><span style="color: #007700">;<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_http_400</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendError</span><span style="color: #007700">(</span><span style="color: #0000BB">400</span><span style="color: #007700">);<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_init_ssl</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$local_cert&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;/ssl-echo-server/cert.pem&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$local_pk&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;/ssl-echo-server/privkey.pem&quot;</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ctx&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">(</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">SSLv3_SERVER_METHOD</span><span style="color: #007700">,&#xA0;array&#xA0;(<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_CERT&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$local_cert</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_PK&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">$local_pk</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE&#xA0;&#xA0;=&gt;&#xA0;&quot;test&quot;,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_ALLOW_SELF_SIGNED&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">true</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;));<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">9999</span><span style="color: #007700">;<br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br>}<br>if&#xA0;(</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">0&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">65535</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Invalid&#xA0;port&quot;</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">$ip&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&apos;0.0.0.0&apos;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$ctx&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">_init_ssl</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$http&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttp</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setAllowedMethods</span><span style="color: #007700">(</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_GET&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_POST</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/dump&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;_http_dump&quot;</span><span style="color: #007700">,&#xA0;array(</span><span style="color: #0000BB">4</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">8</span><span style="color: #007700">));<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/about&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;_http_about&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/err400&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;_http_400&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setDefaultCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;_http_default&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;custom&#xA0;data&#xA0;value&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$http</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bind</span><span style="color: #007700">(</span><span style="color: #0000BB">$ip</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4825">
  <p><strong>Example #10 OpenSSL connection</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Sample&#xA0;OpenSSL&#xA0;client.<br>&#xA0;*<br>&#xA0;*&#xA0;Usage:<br>&#xA0;*&#xA0;1)&#xA0;Launch&#xA0;a&#xA0;server,&#xA0;e.g.:<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;examples/https.php&#xA0;9999<br>&#xA0;*<br>&#xA0;*&#xA0;2)&#xA0;Launch&#xA0;the&#xA0;client&#xA0;in&#xA0;another&#xA0;terminal:<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;examples/ssl-connection.php&#xA0;9999<br>&#xA0;*/<br><br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">_request_handler</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Timed&#xA0;out\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getResponseCode</span><span style="color: #007700">();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">==&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Connection&#xA0;refused\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;elseif&#xA0;(</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">!=&#xA0;</span><span style="color: #0000BB">200</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Unexpected&#xA0;response:&#xA0;</span><span style="color: #0000BB">$response_code</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Success:&#xA0;</span><span style="color: #0000BB">$response_code</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$buf&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputBuffer</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Body:\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;(</span><span style="color: #0000BB">$s&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">readLine</span><span style="color: #007700">(</span><span style="color: #0000BB">EventBuffer</span><span style="color: #007700">::</span><span style="color: #0000BB">EOL_ANY</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$s</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>}<br><br>function&#xA0;</span><span style="color: #0000BB">_init_ssl</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$ctx&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">(</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">SSLv3_CLIENT_METHOD</span><span style="color: #007700">,&#xA0;array&#xA0;());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">;<br>}<br><br><br></span><span style="color: #FF8000">//&#xA0;Allow&#xA0;to&#xA0;override&#xA0;the&#xA0;port<br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">9999</span><span style="color: #007700">;<br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;(int)&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br>}<br>if&#xA0;(</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">0&#xA0;</span><span style="color: #007700">||&#xA0;</span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">65535</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Invalid&#xA0;port\n&quot;</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">$host&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&apos;127.0.0.1&apos;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$ctx&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">_init_ssl</span><span style="color: #007700">();<br>if&#xA0;(!</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;SSL&#xA0;context&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">E_USER_ERROR</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br>if&#xA0;(!</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;initialize&#xA0;event&#xA0;base&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">E_USER_ERROR</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$conn&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttpConnection</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$host</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setTimeout</span><span style="color: #007700">(</span><span style="color: #0000BB">50</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$req&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;_request_handler&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Host&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$host</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">OUTPUT_HEADER</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$buf&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOutputBuffer</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;&lt;html&gt;HTML&#xA0;TEST&lt;/html&gt;&quot;</span><span style="color: #007700">);<br></span><span style="color: #FF8000">//$req-&gt;addHeader(&quot;Content-Length&quot;,&#xA0;$buf-&gt;length,&#xA0;EventHttpRequest::OUTPUT_HEADER);<br>//$req-&gt;addHeader(&quot;Connection&quot;,&#xA0;&quot;close&quot;,&#xA0;EventHttpRequest::OUTPUT_HEADER);<br></span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">makeRequest</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_POST</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;/dump&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br>echo&#xA0;</span><span style="color: #DD0000">&quot;END\n&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4826">
  <p><strong>Example #11 
   <span class="function"><a href="eventhttpconnection.makerequest.html" class="function">EventHttpConnection::makeRequest()</a></span> example</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function&#xA0;</span><span style="color: #0000BB">_request_handler</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Timed&#xA0;out\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getResponseCode</span><span style="color: #007700">();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">==&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Connection&#xA0;refused\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;elseif&#xA0;(</span><span style="color: #0000BB">$response_code&#xA0;</span><span style="color: #007700">!=&#xA0;</span><span style="color: #0000BB">200</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Unexpected&#xA0;response:&#xA0;</span><span style="color: #0000BB">$response_code</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Success:&#xA0;</span><span style="color: #0000BB">$response_code</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$buf&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getInputBuffer</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Body:\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;while&#xA0;(</span><span style="color: #0000BB">$s&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">readLine</span><span style="color: #007700">(</span><span style="color: #0000BB">EventBuffer</span><span style="color: #007700">::</span><span style="color: #0000BB">EOL_ANY</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #0000BB">$s</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #0000BB">$address&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;127.0.0.1&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$port&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">80</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br></span><span style="color: #0000BB">$conn&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttpConnection</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$port</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setTimeout</span><span style="color: #007700">(</span><span style="color: #0000BB">5</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$req&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;_request_handler&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Host&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">OUTPUT_HEADER</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Content-Length&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;0&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">OUTPUT_HEADER</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">makeRequest</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #0000BB">CMD_GET</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;/index.cphp&quot;</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loop</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

   <div class="example-contents"><p>The above example will output
something similar to:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
_request_handler
Success: 200
Body:
PHP, date:
2013-03-13T20:27:52+05:00
</pre></div>
  </div>
 </div>
 <div class="example" id="example-4827">
  <p><strong>Example #12 
   Connection listener based on a UNIX domain socket</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Simple&#xA0;echo&#xA0;server&#xA0;based&#xA0;on&#xA0;libevent&apos;s&#xA0;connection&#xA0;listener.<br>&#xA0;*<br>&#xA0;*&#xA0;Usage:<br>&#xA0;*&#xA0;1)&#xA0;In&#xA0;one&#xA0;terminal&#xA0;window&#xA0;run:<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;php&#xA0;unix-domain-listener.php&#xA0;[path-to-socket]<br>&#xA0;*<br>&#xA0;*&#xA0;2)&#xA0;In&#xA0;another&#xA0;terminal&#xA0;window&#xA0;open&#xA0;up&#xA0;connection<br>&#xA0;*&#xA0;to&#xA0;the&#xA0;socket,&#xA0;e.g.:<br>&#xA0;*<br>&#xA0;*&#xA0;$&#xA0;socat&#xA0;-&#xA0;GOPEN:/tmp/1.sock<br>&#xA0;*<br>&#xA0;*&#xA0;3)&#xA0;Start&#xA0;typing.&#xA0;The&#xA0;server&#xA0;should&#xA0;repeat&#xA0;the&#xA0;input.<br>&#xA0;*/<br><br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">MyListenerConnection&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;private&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;echoReadCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;echoEventCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;enable&#xA0;READ\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;return;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">echoReadCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;Copy&#xA0;all&#xA0;the&#xA0;data&#xA0;from&#xA0;the&#xA0;input&#xA0;buffer&#xA0;to&#xA0;the&#xA0;output&#xA0;buffer<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">output</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addBuffer</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">echoEventCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$bev</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$events</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Error&#xA0;from&#xA0;bufferevent\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$events&#xA0;</span><span style="color: #007700">&amp;&#xA0;(</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">EOF&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">ERROR</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$bev&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>class&#xA0;</span><span style="color: #0000BB">MyListener&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$socket</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;private&#xA0;</span><span style="color: #0000BB">$conn&#xA0;</span><span style="color: #007700">=&#xA0;array();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;foreach&#xA0;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">conn&#xA0;</span><span style="color: #007700">as&#xA0;&amp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">)&#xA0;</span><span style="color: #0000BB">$c&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$sock_path</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;open&#xA0;event&#xA0;base&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$sock_path</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$sock_path</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;acceptConnCallback&quot;</span><span style="color: #007700">),&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_REUSEABLE</span><span style="color: #007700">,&#xA0;-</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&quot;unix:</span><span style="color: #0000BB">$sock_path</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;create&#xA0;listener&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">E_USER_ERROR</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;accept_error_cb&quot;</span><span style="color: #007700">));<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;This&#xA0;callback&#xA0;is&#xA0;invoked&#xA0;when&#xA0;there&#xA0;is&#xA0;data&#xA0;to&#xA0;read&#xA0;on&#xA0;$bev<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">public&#xA0;function&#xA0;</span><span style="color: #0000BB">acceptConnCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;We&#xA0;got&#xA0;a&#xA0;new&#xA0;connection!&#xA0;Set&#xA0;up&#xA0;a&#xA0;bufferevent&#xA0;for&#xA0;it.&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">conn</span><span style="color: #007700">[]&#xA0;=&#xA0;new&#xA0;</span><span style="color: #0000BB">MyListenerConnection</span><span style="color: #007700">(</span><span style="color: #0000BB">$base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">fprintf</span><span style="color: #007700">(</span><span style="color: #0000BB">STDERR</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;Got&#xA0;an&#xA0;error&#xA0;%d&#xA0;(%s)&#xA0;on&#xA0;the&#xA0;listener.&#xA0;&quot;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;Shutting&#xA0;down.\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketErrno</span><span style="color: #007700">(),<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketError</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>if&#xA0;(</span><span style="color: #0000BB">$argc&#xA0;</span><span style="color: #007700">&lt;=&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Socket&#xA0;path&#xA0;is&#xA0;not&#xA0;provided\n&quot;</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">$sock_path&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$argv</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br><br></span><span style="color: #0000BB">$l&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">MyListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$sock_path</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$l</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

 </div>
 <div class="example" id="example-4828">
  <p><strong>Example #13 Simple SMTP server</strong></p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>&#xA0;</span><span style="color: #FF8000">/*<br>&#xA0;*&#xA0;Author:&#xA0;Andrew&#xA0;Rose&#xA0;&lt;hello&#xA0;at&#xA0;andrewrose&#xA0;dot&#xA0;co&#xA0;dot&#xA0;uk&gt;<br>&#xA0;*<br>&#xA0;*&#xA0;Usage:<br>&#xA0;*&#xA0;1)&#xA0;Prepare&#xA0;cert.pem&#xA0;certificate&#xA0;and&#xA0;privkey.pem&#xA0;private&#xA0;key&#xA0;files.<br>&#xA0;*&#xA0;2)&#xA0;Launch&#xA0;the&#xA0;server&#xA0;script<br>&#xA0;*&#xA0;3)&#xA0;Open&#xA0;TLS&#xA0;connection,&#xA0;e.g.:<br>&#xA0;*&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;$&#xA0;openssl&#xA0;s_client&#xA0;-connect&#xA0;localhost:25&#xA0;-starttls&#xA0;smtp&#xA0;-crlf<br>&#xA0;*&#xA0;4)&#xA0;Start&#xA0;testing&#xA0;the&#xA0;commands&#xA0;listed&#xA0;in&#xA0;`cmd`&#xA0;method&#xA0;below.<br>&#xA0;*/<br><br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">Handler&#xA0;</span><span style="color: #007700">{<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$domainName&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$connections&#xA0;</span><span style="color: #007700">=&#xA0;[];<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$buffers&#xA0;</span><span style="color: #007700">=&#xA0;[];<br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;</span><span style="color: #0000BB">$maxRead&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">256000</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">()&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">(</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">SSLv3_SERVER_METHOD</span><span style="color: #007700">,&#xA0;[<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_CERT&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #DD0000">&apos;cert.pem&apos;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_LOCAL_PK&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #DD0000">&apos;privkey.pem&apos;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE&#xA0;&#xA0;=&gt;&#xA0;&apos;&apos;,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_VERIFY_PEER&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">false</span><span style="color: #007700">,&#xA0;</span><span style="color: #FF8000">//&#xA0;change&#xA0;to&#xA0;true&#xA0;with&#xA0;authentic&#xA0;cert<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventSslContext</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_ALLOW_SELF_SIGNED&#xA0;</span><span style="color: #007700">=&gt;&#xA0;</span><span style="color: #0000BB">true&#xA0;</span><span style="color: #FF8000">//&#xA0;change&#xA0;to&#xA0;false&#xA0;with&#xA0;authentic&#xA0;cert<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">]);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBase</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;open&#xA0;event&#xA0;base\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&apos;ev_accept&apos;</span><span style="color: #007700">],<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">EventListener</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_REUSEABLE</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;-</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #DD0000">&apos;0.0.0.0:25&apos;</span><span style="color: #007700">))<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #DD0000">&quot;Couldn&apos;t&#xA0;create&#xA0;listener\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">listener</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setErrorCallback</span><span style="color: #007700">([</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&apos;ev_error&apos;</span><span style="color: #007700">]);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dispatch</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">ev_accept</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;static&#xA0;</span><span style="color: #0000BB">$id&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$id&#xA0;</span><span style="color: #007700">+=&#xA0;</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">]&#xA0;=&#xA0;</span><span style="color: #DD0000">&apos;&apos;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]&#xA0;=&#xA0;new&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">])&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&quot;Failed&#xA0;creating&#xA0;buffer\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">([</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;ev_read&quot;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&apos;ev_error&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">WRITE</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&apos;220&#xA0;&apos;</span><span style="color: #007700">.</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">domainName</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;&#xA0;wazzzap?\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;function&#xA0;</span><span style="color: #0000BB">ev_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$listener</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$ctx</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$errno&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketErrno</span><span style="color: #007700">();<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">fprintf</span><span style="color: #007700">(</span><span style="color: #0000BB">STDERR</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;Got&#xA0;an&#xA0;error&#xA0;%d&#xA0;(%s)&#xA0;on&#xA0;the&#xA0;listener.&#xA0;Shutting&#xA0;down.\n&quot;</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">EventUtil</span><span style="color: #007700">::</span><span style="color: #0000BB">getLastSocketError</span><span style="color: #007700">());<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if&#xA0;(</span><span style="color: #0000BB">$errno&#xA0;</span><span style="color: #007700">!=&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exit</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exit();<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">ev_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">disable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">WRITE</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unset(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">]);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;protected&#xA0;function&#xA0;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$string</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&apos;S(&apos;</span><span style="color: #007700">.</span><span style="color: #0000BB">$id</span><span style="color: #007700">.</span><span style="color: #DD0000">&apos;):&#xA0;&apos;</span><span style="color: #007700">.</span><span style="color: #0000BB">$string</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$string</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">ev_read</span><span style="color: #007700">(</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$id</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;while(</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length&#xA0;</span><span style="color: #007700">&gt;&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">]&#xA0;.=&#xA0;</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">input</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">maxRead</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$clientDataLen&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">]);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">][</span><span style="color: #0000BB">$clientDataLen</span><span style="color: #007700">-</span><span style="color: #0000BB">1</span><span style="color: #007700">]&#xA0;==&#xA0;</span><span style="color: #DD0000">&quot;\n&quot;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">&amp;&amp;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">][</span><span style="color: #0000BB">$clientDataLen</span><span style="color: #007700">-</span><span style="color: #0000BB">2</span><span style="color: #007700">]&#xA0;==&#xA0;</span><span style="color: #DD0000">&quot;\r&quot;</span><span style="color: #007700">)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">//&#xA0;remove&#xA0;the&#xA0;trailing&#xA0;\r\n<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$line&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">0</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">])&#xA0;-&#xA0;</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;clientData&apos;</span><span style="color: #007700">]&#xA0;=&#xA0;</span><span style="color: #DD0000">&apos;&apos;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cmd</span><span style="color: #007700">(</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br><br>&#xA0;&#xA0;&#xA0;&#xA0;protected&#xA0;function&#xA0;</span><span style="color: #0000BB">cmd</span><span style="color: #007700">(</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;switch&#xA0;(</span><span style="color: #0000BB">$line</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;case&#xA0;</span><span style="color: #0000BB">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;EHLO&#xA0;&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">4</span><span style="color: #007700">):<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;250-STARTTLS\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;250&#xA0;OK&#xA0;ehlo\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;break;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;case&#xA0;</span><span style="color: #0000BB">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;HELO&#xA0;&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">4</span><span style="color: #007700">):<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;250-STARTTLS\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;250&#xA0;OK&#xA0;helo\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;break;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;case&#xA0;</span><span style="color: #0000BB">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;QUIT&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">3</span><span style="color: #007700">):<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;250&#xA0;OK&#xA0;quit\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;break;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;case&#xA0;</span><span style="color: #0000BB">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;STARTTLS&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">3</span><span style="color: #007700">):<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ev_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;220&#xA0;Ready&#xA0;to&#xA0;start&#xA0;TLS\r\n&quot;</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]&#xA0;=&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">sslFilter</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">base</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ctx</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">SSL_ACCEPTING</span><span style="color: #007700">,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">setCallbacks</span><span style="color: #007700">([</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;ev_read&quot;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">,&#xA0;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&apos;ev_error&apos;</span><span style="color: #007700">],&#xA0;</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connections</span><span style="color: #007700">[</span><span style="color: #0000BB">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">&apos;cnx&apos;</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ&#xA0;</span><span style="color: #007700">|&#xA0;</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">WRITE</span><span style="color: #007700">);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;break;<br><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;default:<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo&#xA0;</span><span style="color: #DD0000">&apos;unknown&#xA0;command:&#xA0;&apos;</span><span style="color: #007700">.</span><span style="color: #0000BB">$line</span><span style="color: #007700">.</span><span style="color: #DD0000">&quot;\n&quot;</span><span style="color: #007700">;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;break;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}<br>&#xA0;&#xA0;&#xA0;&#xA0;}<br>}<br><br>new&#xA0;</span><span style="color: #0000BB">Handler</span><span style="color: #007700">();</span>
</span>
</code></div>
  </div>

 </div>
