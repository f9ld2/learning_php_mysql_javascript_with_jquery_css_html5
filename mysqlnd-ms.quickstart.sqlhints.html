---
layout: default
---

  <h2 class="title">SQL Hints</h2>
  <p class="para">
   SQL hints can force a query to choose a specific server from the connection pool.
   It gives the plugin a hint to use a designated server, which can solve
   issues caused by connection switches and connection state.
  </p>
  <p class="para">
   SQL hints are standard compliant SQL comments. Because
   SQL comments are supposed to be ignored by SQL processing systems, they
   do not interfere with other programs such as the MySQL Server, the MySQL Proxy,
   or a firewall.
  </p>
  <p class="para">
   Three SQL hints are supported by the plugin: The
   <strong><code>MYSQLND_MS_MASTER_SWITCH</code></strong> hint makes the plugin run a
   statement on the master, <strong><code>MYSQLND_MS_SLAVE_SWITCH</code></strong>
   enforces the use of the slave, and
   <strong><code>MYSQLND_MS_LAST_USED_SWITCH</code></strong> will run a statement on
   the same server that was used for the previous statement.
  </p>
  <p class="para">
   The plugin scans the beginning of a statement for the existence of an SQL
   hint. SQL hints are only recognized if they appear at the beginning of
   the statement.
  </p>
   <p class="para">
   <div class="example" id="example-1993">
    <p><strong>Example #1 Plugin config with one slave and one master</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-1994">
    <p><strong>Example #2 SQL hints to prevent connection switches</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;username&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;1,&#xA0;connection&#xA0;bound&#xA0;SQL&#xA0;user&#xA0;variable,&#xA0;no&#xA0;SELECT&#xA0;thus&#xA0;run&#xA0;on&#xA0;master&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SET&#xA0;@myrole=&apos;master&apos;&quot;</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Connection&#xA0;1,&#xA0;run&#xA0;on&#xA0;master&#xA0;because&#xA0;of&#xA0;SQL&#xA0;hint&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!(</span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/*%s*/SELECT&#xA0;@myrole&#xA0;AS&#xA0;_role&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">MYSQLND_MS_LAST_USED_SWITCH</span><span style="color: #007700">))))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$row&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;@myrole&#xA0;=&#xA0;&apos;%s&apos;\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_role&apos;</span><span style="color: #007700">]);<br>}<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

<div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
@myrole = &apos;master&apos;
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   In the above example, using <strong><code>MYSQLND_MS_LAST_USED_SWITCH</code></strong> prevents
   session switching from the master to a slave when running the <em>SELECT</em>
   statement.
  </p>
  <p class="para">
   SQL hints can also be used to run <em>SELECT</em> statements
   on the MySQL master server. This may be desired if the MySQL slave servers
   are typically behind the master, but you need current data from the cluster.
  </p>
  <p class="para">
   In version 1.2.0 the concept of a service level has been introduced to address
   cases when current data is required. Using a service level requires less attention
   and removes the need of using SQL hints for this use case. Please, find more
   information below in the service level and consistency section.
  </p>
  <p class="para">
   <div class="example" id="example-1995">
    <p><strong>Example #3 Fighting replication lag</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;username&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Force&#xA0;use&#xA0;of&#xA0;master,&#xA0;master&#xA0;has&#xA0;always&#xA0;fresh&#xA0;and&#xA0;current&#xA0;data&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/*%s*/SELECT&#xA0;critical_data&#xA0;FROM&#xA0;important_table&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">MYSQLND_MS_MASTER_SWITCH</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   A use case may include the creation of tables on a slave.
   If an SQL hint is not given, then the plugin will send <em>CREATE</em>
   and <em>INSERT</em> statements to the master. Use the
   SQL hint <strong><code>MYSQLND_MS_SLAVE_SWITCH</code></strong> if you want to
   run any such statement on a slave, for example, to build temporary
   reporting tables.
  </p>
  <p class="para">
   <div class="example" id="example-1996">
    <p><strong>Example #4 Table creation on a slave</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;myapp&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;username&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;password&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;database&quot;</span><span style="color: #007700">);<br>if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #FF8000">/*&#xA0;Of&#xA0;course,&#xA0;your&#xA0;error&#xA0;handling&#xA0;is&#xA0;nicer...&#xA0;*/<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&#xA0;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br>}<br><br></span><span style="color: #FF8000">/*&#xA0;Force&#xA0;use&#xA0;of&#xA0;slave&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/*%s*/CREATE&#xA0;TABLE&#xA0;slave_reporting(id&#xA0;INT)&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">MYSQLND_MS_SLAVE_SWITCH</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br></span><span style="color: #FF8000">/*&#xA0;Continue&#xA0;using&#xA0;this&#xA0;particular&#xA0;slave&#xA0;connection&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/*%s*/INSERT&#xA0;INTO&#xA0;slave_reporting(id)&#xA0;VALUES&#xA0;(1),&#xA0;(2),&#xA0;(3)&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">MYSQLND_MS_LAST_USED_SWITCH</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br></span><span style="color: #FF8000">/*&#xA0;Don&apos;t&#xA0;use&#xA0;MYSQLND_MS_SLAVE_SWITCH&#xA0;which&#xA0;would&#xA0;allow&#xA0;switching&#xA0;to&#xA0;another&#xA0;slave!&#xA0;*/<br></span><span style="color: #007700">if&#xA0;(</span><span style="color: #0000BB">$res&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/*%s*/SELECT&#xA0;COUNT(*)&#xA0;AS&#xA0;_num&#xA0;FROM&#xA0;slave_reporting&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">MYSQLND_MS_LAST_USED_SWITCH</span><span style="color: #007700">)))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$row&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;There&#xA0;are&#xA0;%d&#xA0;rows&#xA0;in&#xA0;the&#xA0;table&#xA0;&apos;slave_reporting&apos;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;_num&apos;</span><span style="color: #007700">]);<br>}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;[%d]&#xA0;%s\n&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   The SQL hint <strong><code>MYSQLND_MS_LAST_USED</code></strong> forbids switching a
   connection, and forces use of the previously used connection.
  </p>
 