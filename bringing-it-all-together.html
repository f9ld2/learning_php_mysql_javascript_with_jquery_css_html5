---
layout: default
title: "Bringing It All Together"
---
<h2>Bringing It All Together</h2>
<span>Now that you&rsquo;ve reached the end of your journey into learning the hows, whys, and</span>
<span>wherefores of dynamic web programming, I want to leave you with a real example</span>
<span>that you can sink your teeth into. In fact, it&rsquo;s a collection of examples, because I&rsquo;ve put</span>
<span>together a simple social networking project comprising all the main features you&rsquo;d</span>
<span>expect from such a site.</span>
<br/>
<span>Across the various files, there are examples of MySQL table creation and database</span>
<span>access, CSS style sheets, file inclusion, session control, DOM access, Ajax calls, event</span>
<span>and error handling, file uploading, image manipulation, the HTML5 canvas, and a</span>
<span>whole lot more.</span>
<br/>
<span>Each example file is complete and self-contained, yet works with all the others to</span>
<span>build a fully working social networking site, even including a style sheet you can</span>
<span>modify to completely change the look and feel of the project. Being small and light,</span>
<span>the end product is particularly usable on mobile platforms such as a smartphone or</span>
<span>tablet, but will run equally well on a full-size desktop computer.</span>
<br/>
<span>I leave it up to you to take any pieces of code you think you can use and expand on</span>
<span>them for your own purposes. Perhaps you may even wish to build on these files to</span>
<span>create a social networking site of your own.</span>
<h3>Designing a Social Networking Site</h3>
<span>Before writing any code, I sat down and came up with several things that I decided</span>
<span>were essential to such a site. These included the following:</span>
<br/>
<span>&bull;</span>
<span>A sign-up process</span>
<br/>
<span>&bull;</span>
<span>A login form</span>
<br/>
<span>&bull;</span>
<span>A logout facility</span>
<br/>
<span>&bull;</span>
<span>Session control</span>
<br/>
<span>&bull;</span>
<span>User profiles with uploaded thumbnails</span>
<br/>
<span>&bull;</span>
<span>A member directory</span>
<br/>
<span>&bull;</span>
<span>Adding members as friends</span>
<br/>
<span>&bull;</span>
<span>Public and private messaging between members</span>
<br/>
<span>&bull;</span>
<span>How to style the project</span>
<br/>
<span>I decided to name the project</span>
<span>Robin&rsquo;s Nest</span>
<span>, but you have to modify only one line of</span>
<span>code (in</span>
<span>functions.php</span>
<span>) to change this to a name of your choice.</span>
<h3>On the Website</h3>
<span>All the examples in this chapter can be found on the companion website located at</span>
<span>http://lpmj.net</span>
<span>. You can also download the examples from there to your computer by</span>
<span>clicking the Download Examples link. This will download an archive file called</span>
<span>exam‐</span>
<span>ples.zip</span>
<span>, which you should extract to a suitable location on your computer.</span>
<br/>
<span>Of particular interest to this chapter, within the zip file you&rsquo;ll find there&rsquo;s a folder</span>
<span>called</span>
<span>robinsnest</span>
<span>, in which all the following examples have been saved with the correct</span>
<span>filenames required by this sample application. So you can easily copy them all to your</span>
<span>web development folder to try them out.</span>
<h3>functions.php</h3>
<span>Let&rsquo;s jump right into the project, starting with</span>
<span>&nbsp;Example 26-1</span>
<span>,</span>
<span>&nbsp;functions.php</span>
<span>, the</span>
<span>include file of the main functions. This file contains a little more than just the func‐</span>
<span>tions, though, because I have added the database login details here instead of using</span>
<span>yet another separate file. So the first half-dozen lines of code define the host, database</span>
<span>name, username, and password of the database to use.</span>
<br/>
<span>It doesn&rsquo;t matter what you call the database, as long as it already exists (see</span>
<span>Chapter 8</span>
<span>for instructions on how to create a new database). Also make sure to correctly assign</span>
<span>a MySQL username and password to</span>
<span>$dbuser</span>
<span>and</span>
<span>$dbpass</span>
<span>. With correct values, the</span>
<span>subsequent two lines will open a connection to MySQL and select the database. The</span>
<span>last of the initial instructions sets the name of the social networking site by assigning</span>
<span>the value</span>
<span>Robin's Nest</span>
<span>to the variable</span>
<span>$appname</span>
<span>. If you want to change the name,</span>
<span>this is the place to do so.</span>
<h4>The Functions</h4>
<span>The project uses five main functions:</span>
<br/>
<span>createTable</span>
<div class="t30">Checks whether a table already exists and, if not, creates it</div>
<span>queryMysql</span>
<div class="t30">Issues a query to MySQL, outputting an error message if it fails</div>
<span>destroySession</span>
<div class="t30">Destroys a PHP session and clears its data to log users out</div>
<span>sanitizeString</span>
<div class="t30">Removes potentially malicious code or tags from user input</div>
<span>showProfile</span>
<div class="t30">Displays a user&rsquo;s image and &ldquo;about me&rdquo; message if he has one</div>
<br/>
<span>All of these should be obvious in their action to you by now, with the possible excep‐</span>
<span>tion of</span>
<span>showProfile</span>
<span>, which looks for an image of the name</span>
<span>user.jpg</span>
<span>(where</span>
<span>user</span>
<span>is the</span>
<span>username of the current user), and if it finds it, displays it. It also displays any &ldquo;about</span>
<span>me&rdquo; text the user may have saved.</span>
<br/>
<span>I have ensured that error handling is in place for all the functions that need it, so that</span>
<span>they can catch any typographical or other errors you may introduce, and generate</span>
<span>error messages. However, if you use any of this code on a production server, you will</span>
<span>probably want to provide your own error-handling routines to make the code more</span>
<span>user-friendly.</span>
<br/>
<span>So type</span>
<span>Example 26-1</span>
<span>and save it as</span>
<span>functions.php</span>
<span>(or download it from the compan‐</span>
<span>ion website), and you&rsquo;ll be ready to move on to the next section.</span>
<br/>
<span>Example 26-1. functions.php</span>
<pre>
<code class="php">
&lt;?php
    $dbhost = 'localhost'; // Unlikely to require changing
    $dbname = 'robinsnest'; // Modify these...
    $dbuser = 'robinsnest'; // ...variables according
    $dbpass = 'rnpassword'; // ...to your installation
    $appname = "Robin's Nest"; // ...and preference
    $connection = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
    
    if ($connection-&gt;connect_error) die($connection-&gt;connect_error);
    
    function createTable($name, $query)
    {
        queryMysql("CREATE TABLE IF NOT EXISTS $name($query)");
        echo "Table '$name' created or already exists.&lt;br&gt;";
    }
    
    function queryMysql($query)
    {
        global $connection;
        $result = $connection-&gt;query($query);
        if (!$result) die($connection-&gt;error);
        return $result;
    }
    
    function destroySession()
    {
        $_SESSION=array();
        if (session_id() != "" || isset($_COOKIE[session_name()]))
            setcookie(session_name(), '', time()-2592000, '/');
        
        session_destroy();
    }
    
    function sanitizeString($var)
    {
        global $connection;
        $var = strip_tags($var);
        $var = htmlentities($var);
        $var = stripslashes($var);
        return $connection-&gt;real_escape_string($var);
    }
    
    function showProfile($user)
    {
        if (file_exists("$user.jpg"))
        
        echo "&lt;img src='$user.jpg' style='float:left;'&gt;";
        $result = queryMysql("SELECT * FROM profiles WHERE user='$user'");
        
        if ($result-&gt;num_rows)
        {
            $row = $result-&gt;fetch_array(MYSQLI_ASSOC);
            echo stripslashes($row['text']) . "&lt;br style='clear:left;'&gt;&lt;br&gt;";
        }
    }
?&gt;
</code>
</pre>
<span>If you read a previous edition of this book, in which these examples</span>
<span>used the old</span>
<span>mysql</span>
<span>extension, you should note that in order to ref‐</span>
<span>erence the MySQL database using</span>
<span>mysqli</span>
<span>, you must apply the</span>
<span>global</span>
<span>keyword in the</span>
<span>queryMysql</span>
<span>and</span>
<span>sanitizeString</span>
<span>functions,</span>
<span>to allow them to use the value in</span>
<span>$connection</span>
<span>.</span>
<h3>header.php</h3>
<span>For uniformity, each page of the project needs to have access to the same set of fea‐</span>
<span>tures. Therefore, I placed these things in</span>
<span>&nbsp;Example 26-2</span>
<span>,</span>
<span>&nbsp;header.php</span>
<span>. This is the file</span>
<span>that is actually included by the other files and it includes</span>
<span>functions.php</span>
<span>. This means</span>
<span>that only a single</span>
<span>require_once</span>
<span>is needed in each file.</span>
<br/>
<span>header.php</span>
<span>starts by calling the function</span>
<span>session_start</span>
<span>. As you&rsquo;ll recall from</span>
<span>Chap‐</span>
<span>ter 12</span>
<span>, this sets up a session that will remember certain values we want stored across</span>
<span>different PHP files.</span>
<br/>
<span>With the session started, the program then checks whether the session variable</span>
<span>user</span>
<span>is currently assigned a value. If so, a user has logged in and the variable</span>
<span>$loggedin</span>
<span>is</span>
<span>set to</span>
<span>TRUE</span>
<span>.</span>
<br/>
<span>After the main setup code in which a style sheet is loaded, a canvas element is created</span>
<span>for the logo, and a div is also created. The file</span>
<span>javascript.js</span>
<span>(see</span>
<span>Example 26-14</span>
<span>, later</span>
<span>on) is loaded to pull in the</span>
<span>O</span>
<span>,</span>
<span>S</span>
<span>, and</span>
<span>C</span>
<span>functions; these would normally be in the</span>
<span>OSC.js</span>
<span>file, but to keep the number of files down I&rsquo;ve added them to the JavaScript</span>
<span>used to create the logo.</span>
<br/>
<span>Using the value of</span>
<span>$loggedin</span>
<span>, an</span>
<span>if</span>
<span>block displays one of two sets of menus. The</span>
<span>non-logged-in set simply offers options of Home, Sign up, and Log in, whereas the</span>
<span>logged-in version offers full access to the project&rsquo;s features. Additionally, if a user is</span>
<span>logged in, his or her username is appended in brackets to the page title and placed</span>
<span>after the main heading. We can freely refer to</span>
<span>$user</span>
<span>wherever we want to put in the</span>
<span>name, because if the user is not logged in, that variable is empty and will have no</span>
<span>effect on the output.</span>
<br/>
<span>The styling applied to this file is in the file</span>
<span>styles.css</span>
<span>(</span>
<span>Example 26-13</span>
<span>, detailed at the</span>
<span>end of this chapter) and includes creating a wide heading with a colored background,</span>
<span>and turning the links in the lists to rounded buttons.</span>
<br/>
<span>Example 26-2. header.php</span>
<pre>
<code class="php">
&lt;?php
    session_start();
    echo "&lt;!DOCTYPE html&gt;\n&lt;html&gt;&lt;head&gt;";
    
    require_once 'functions.php';
    $userstr = ' (Guest)';
    
    if (isset($_SESSION['user']))
    {
        $user = $_SESSION['user'];
        $loggedin = TRUE;
        $userstr = " ($user)";
    }
    else $loggedin = FALSE;

    echo    "&lt;title&gt;$appname$userstr&lt;/title&gt;&lt;link rel='stylesheet' " .
            "href='styles.css' type='text/css'&gt;" .
            "&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;canvas id='logo' width='624' " .
            "height='96'&gt;$appname&lt;/canvas&gt;&lt;/center&gt;" .
            "&lt;div class='appname'&gt;$appname$userstr&lt;/div&gt;" .
            "&lt;script src='javascript.js'&gt;&lt;/script&gt;";
        
    if ($loggedin)
        echo    "&lt;br &gt;&lt;ul class='menu'&gt;" .
                "&lt;li&gt;&lt;a href='members.php?view=$user'&gt;Home&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='members.php'&gt;Members&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='friends.php'&gt;Friends&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='messages.php'&gt;Messages&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='profile.php'&gt;Edit Profile&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='logout.php'&gt;Log out&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br&gt;";
    else
        echo    ("&lt;br&gt;&lt;ul class='menu'&gt;" .
                "&lt;li&gt;&lt;a href='index.php'&gt;Home&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='signup.php'&gt;Sign up&lt;/a&gt;&lt;/li&gt;" .
                "&lt;li&gt;&lt;a href='login.php'&gt;Log in&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br&gt;" .
                "&lt;span class='info'&gt;&amp;#8658; You must be logged in to " .
                "view this page.&lt;/span&gt;&lt;br&gt;&lt;br&gt;");
?&gt;
</code>
</pre>
<span>Using the</span>
<span>&lt;br&gt;</span>
<span>tag, as in the preceding example, is a quick and</span>
<span>dirty way of creating spacing in page layout. In this instance it</span>
<span>works well, but generally you will probably want to use CSS mar‐</span>
<span>gins to fine-tune the spacing around elements.</span>
<h3>setup.php</h3>
<span>With the pair of included files written, it&rsquo;s now time to set up the MySQL tables they</span>
<span>will use. We do this with</span>
<span>Example 26-3</span>
<span>,</span>
<span>setup.php</span>
<span>, which you should type and load</span>
<span>into your browser before calling up any other files; otherwise, you&rsquo;ll get numerous</span>
<span>MySQL errors.</span>
<br/>
<span>The tables created are short and sweet, and have the following names and columns:</span>
<span>&bull;</span>
<span>members</span>
<span>: username</span>
<span>user</span>
<span>(indexed), password</span>
<span>pass</span>
<br/>
<span>&bull;</span>
<span>messages</span>
<span>: ID</span>
<span>id</span>
<span>(indexed), author</span>
<span>auth</span>
<span>(indexed), recipient</span>
<span>recip</span>
<span>, message type</span>
<span>pm</span>
<span>, message</span>
<span>message</span>
<br/>
<span>&bull;</span>
<span>friends</span>
<span>: username</span>
<span>user</span>
<span>(indexed), friend&rsquo;s username</span>
<span>friend</span>
<br/>
<span>&bull;</span>
<span>profiles</span>
<span>: username</span>
<span>user</span>
<span>(indexed), &ldquo;about me&rdquo;</span>
<span>text</span>
<br/>
<span>Because the function</span>
<span>createTable</span>
<span>first checks whether a table already exists, this</span>
<span>program can be safely called multiple times without generating any errors.</span>
<br/>
<span>It is very likely that you will need to add many more columns to these tables if you</span>
<span>choose to expand on this project. If so, you may need to issue a MySQL</span>
<span>DROP TABLE</span>
<span>command before re-creating a table.</span>
<span>Example 26-3. setup.php</span>
<pre>
<code class="php">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Setting up database&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h3&gt;Setting up...&lt;/h3&gt;
        &lt;?php

            require_once 'functions.php';

            createTable('members',
                        'user VARCHAR(16),
                        pass VARCHAR(16),
                        INDEX(user(6))');

            createTable('messages',
                        'id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                        auth VARCHAR(16),
                        recip VARCHAR(16),
                        pm CHAR(1),
                        time INT UNSIGNED,
                        message VARCHAR(4096),
                        INDEX(auth(6)),
                        INDEX(recip(6))');

            createTable('friends',
                        'user VARCHAR(16),
                        friend VARCHAR(16),
                        INDEX(user(6)),
                        INDEX(friend(6))');
                        createTable('profiles',
                        'user VARCHAR(16),
                        text VARCHAR(4096),
                        INDEX(user(6))');
        ?&gt;

        &lt;br&gt;...done.
    &lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<span>For this example to work, you must first ensure that you have</span>
<span>already created the database specified in the variable</span>
<span>$dbname</span>
<span>in</span>
<span>Example 26-1</span>
<span>, and also have granted access to it by the user given</span>
<span>the name in</span>
<span>$dbuser</span>
<span>, with the password in</span>
<span>$dbpass</span>
<span>.</span>
<h3>index.php</h3>
<span>This file is a trivial file but necessary nonetheless to give the project a home page. All</span>
<span>it does is display a simple welcome message. In a finished application, this would be</span>
<span>where you sell the virtues of your site to encourage sign-ups.</span>
<br/>
<span>Incidentally, seeing as all the MySQL tables have been created and the include files</span>
<span>saved, you can now load</span>
<span>Example 26-4</span>
<span>,</span>
<span>index.php</span>
<span>, into your browser to get your first</span>
<span>peek at the new application. It should look like</span>
<span>Figure 26-1</span>
<span>.</span>
<br/>
<span>Example 26-4. index.php</span>
<pre>
<code class="php">
    &lt;?php
        require_once 'header.php';
        echo "&lt;br&gt;&lt;span class='main'&gt;Welcome to $appname,";
        
        if ($loggedin) echo " $user, you are logged in.";
        else echo ' please sign up and/or log in to join in.';
    ?&gt;
    &lt;/span&gt;&lt;br&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.1.png"/></p>
<span>Figure 26-1. The main page of the site</span>
<h3>signup.php</h3>
<span>Now</span>
<span>we</span>
<span>need</span>
<span>a</span>
<span>module</span>
<span>to</span>
<span>enable</span>
<span>users</span>
<span>to</span>
<span>join</span>
<span>the</span>
<span>new</span>
<span>network,</span>
<span>and</span>
<span>that&rsquo;s</span>
<span>Example 26-5</span>
<span>,</span>
<span>&nbsp;signup.php</span>
<span>. This is a slightly longer program, but you&rsquo;ve seen all its</span>
<span>parts before.</span>
<br/>
<span>Let&rsquo;s start by looking at the end block of HTML. This is a simple form that allows a</span>
<span>username and password to be entered. But note the use of the empty</span>
<span>span</span>
<span>given the</span>
<span>id</span>
<span>of</span>
<span>'info'</span>
<span>. This will be the destination of the Ajax call in this program that checks</span>
<span>whether a desired username is available. See</span>
<span>Chapter 18</span>
<span>for a complete description of</span>
<span>how this works.</span>
<h4>Checking for Username Availability</h4>
<span>Now go back to the program start and you&rsquo;ll see a block of JavaScript that starts with</span>
<span>the function</span>
<span>checkUser</span>
<span>. This is called by the JavaScript</span>
<span>onBlur</span>
<span>event when focus is</span>
<span>removed from the username field of the form. First it sets the contents of the span I</span>
<span>mentioned (with the</span>
<span>id</span>
<span>of</span>
<span>info</span>
<span>) to an empty string, which clears it in case it previ‐</span>
<span>ously had a value.</span>
<br/>
<span>Next a request is made to the program</span>
<span>checkuser.php</span>
<span>, which reports whether the user‐</span>
<span>name</span>
<span>user</span>
<span>is available. The returned result of the Ajax call, a friendly message, is then</span>
<span>placed in the</span>
<span>info</span>
<span>span.</span>
<br/>
<span>After the JavaScript section comes some PHP code that you should recognize from</span>
<span>the</span>
<span>&nbsp;Chapter 16</span>
<span>&nbsp;discussion of form validation. This section also uses the</span>
<span>sanitize</span>
<span>String</span>
<span>function to remove potentially malicious characters before looking up the</span>
<span>username in the database and, if it&rsquo;s not already taken, inserting the new username</span>
<span>$user</span>
<span>and password</span>
<span>$pass</span>
<span>.</span>
<h4>Logging In</h4>
<span>Upon successfully signing up, the user is then prompted to log in. A more fluid</span>
<span>response at this point might be to automatically log in a newly created user, but, as I</span>
<span>don&rsquo;t want to overly complicate the code, I have kept the sign-up and login modules</span>
<span>separate from each other. You can easily implement this if you want to, however.</span>
<br/>
<span>This file uses the CSS class</span>
<span>fieldname</span>
<span>to arrange the form fields, aligning them neatly</span>
<span>under each other in columns. When loaded into a browser (and in conjunction with</span>
<span>checkuser.php</span>
<span>, shown later), this program will look like</span>
<span>&nbsp;Figure 26-2</span>
<span>, where you can</span>
<span>see that the Ajax call has identified that the username</span>
<span>Robin</span>
<span>is available. If you would</span>
<span>like the password field to show only asterisks, change its type from</span>
<span>text</span>
<span>to</span>
<span>password</span>
<span>.</span>
<br/>
<span>Example 26-5. signup.php</span>
<br/>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';

echo &lt;&lt;&lt;_END
    &lt;script&gt;
    function checkUser(user)
    {
        if (user.value == '')
        {
            O('info').innerHTML = ''
            return
        }
        
        params = "user=" + user.value
        request = new ajaxRequest()
        
        request.open("POST", "checkuser.php", true)
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
        request.setRequestHeader("Content-length", params.length)
        request.setRequestHeader("Connection", "close")
        
        request.onreadystatechange = function()
        {
            if (this.readyState == 4)
                if (this.status == 200)
                    if (this.responseText != null)
                        O('info').innerHTML = this.responseText
        }
        
        request.send(params)
    }
    
    function ajaxRequest()
    {
        try { var request = new XMLHttpRequest() }
        catch(e1) {
            try { request = new ActiveXObject("Msxml2.XMLHTTP") }
            catch(e2) {
                try { request = new ActiveXObject("Microsoft.XMLHTTP") }
                catch(e3) {
                    request = false
                } 
            } 
        }
        
        return request
    }
    &lt;/script&gt;
    &lt;div class='main'&gt;&lt;h3&gt;Please enter your details to sign up&lt;/h3&gt;
_END;

$error = $user = $pass = "";
if (isset($_SESSION['user'])) destroySession();

if (isset($_POST['user']))
{
    $user = sanitizeString($_POST['user']);
    $pass = sanitizeString($_POST['pass']);
    
    if ($user == "" || $pass == "")
        $error = "Not all fields were entered&lt;br&gt;&lt;br&gt;";
    else
    {
        $result = queryMysql("SELECT * FROM members WHERE user='$user'");
        
        if ($result-&gt;num_rows)
            $error = "That username already exists&lt;br&gt;&lt;br&gt;";
        else
        {
            queryMysql("INSERT INTO members VALUES('$user', '$pass')");
            die("&lt;h4&gt;Account created&lt;/h4&gt;Please Log in.&lt;br&gt;&lt;br&gt;");
        }
    }
}
echo &lt;&lt;&lt;_END
    &lt;form method='post' action='signup.php'&gt;$error
    &lt;span class='fieldname'&gt;Username&lt;/span&gt;
    &lt;input type='text' maxlength='16' name='user' value='$user'
    onBlur='checkUser(this)'&gt;&lt;span id='info'&gt;&lt;/span&gt;&lt;br&gt;
    &lt;span class='fieldname'&gt;Password&lt;/span&gt;
    &lt;input type='text' maxlength='16' name='pass'
    value='$pass'&gt;&lt;br&gt;
_END;

?&gt;
    &lt;span class='fieldname'&gt;&amp;nbsp;&lt;/span&gt;
    &lt;input type='submit' value='Sign up'&gt;
    &lt;/form&gt;&lt;/div&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.2.png"/></p>
<span>Figure 26-2. The sign-up page</span>
<span>On a production server, I wouldn&rsquo;t recommend storing user pass‐</span>
<span>words in the clear as I&rsquo;ve done here (for reasons of space and sim‐</span>
<span>plicity). Instead, you should salt them and store them as one-way</span>
<span>hash strings. See</span>
<span>Chapter 13</span>
<span>for more details on how to do this.</span>
<h3>checkuser.php</h3>
<span>To go with</span>
<span>signup.php</span>
<span>, here&rsquo;s</span>
<span>Example 26-6</span>
<span>,</span>
<span>checkuser.php</span>
<span>, which looks up a username</span>
<span>in the database and returns a string indicating whether it has already been taken.</span>
<span>Because it relies on the functions</span>
<span>sanitizeString</span>
<span>and</span>
<span>queryMysql</span>
<span>, the program first</span>
<span>includes the file</span>
<span>functions.php</span>
<span>.</span>
<br/>
<span>Then, if the</span>
<span>$_POST</span>
<span>variable</span>
<span>user</span>
<span>has a value, the function looks it up in the database</span>
<span>and, depending on whether it exists as a username, outputs either &ldquo;Sorry, this user‐</span>
<span>name</span>
<span>is</span>
<span>taken&rdquo;</span>
<span>or</span>
<span>&ldquo;</span>
<span>This</span>
<span>username</span>
<span>is</span>
<span>available.&rdquo;</span>
<span>Just</span>
<span>checking</span>
<span>the</span>
<span>function</span>
<span>mysql_num_rows</span>
<span>against the result is sufficient for this, as it will return</span>
<span>0</span>
<span>for not</span>
<span>found, or</span>
<span>1</span>
<span>if it is found.</span>
<br/>
<span>The HTML entities</span>
<span>&amp;#x2718;</span>
<span>and</span>
<span>&amp;#x2714;</span>
<span>are also used to preface the string with</span>
<span>either a cross or a checkmark.</span>
<br/>
<span>Example 26-6. checkuser.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'functions.php';
if (isset($_POST['user']))
{
    $user = sanitizeString($_POST['user']);
    $result = queryMysql("SELECT * FROM members WHERE user='$user'");
    if ($result-&gt;num_rows)
        echo "&lt;span class='taken'&gt;&amp;nbsp;&amp;#x2718; " .
                "This username is taken&lt;/span&gt;";
    else
        echo "&lt;span class='available'&gt;&amp;nbsp;&amp;#x2714; " .
                "This username is available&lt;/span&gt;";
}
?&gt;
</code>
</pre>
<h3>login.php</h3>
<span>With users now able to sign up to the site,</span>
<span>Example 26-7</span>
<span>,</span>
<span>login.php</span>
<span>, provides the code</span>
<span>needed to let them log in. Like the sign-up page, it features a simple HTML form and</span>
<span>some basic error checking, as well as using</span>
<span>sanitizeString</span>
<span>before querying the</span>
<span>MySQL database.</span>
<br/>
<span>The main thing to note here is that, upon successful verification of the username and</span>
<span>password, the session variables</span>
<span>user</span>
<span>and</span>
<span>pass</span>
<span>are given the username and password</span>
<span>values. As long as the current session remains active, these variables will be accessible</span>
<span>by all the programs in the project, allowing them to automatically provide access to</span>
<span>logged-in users.</span>
<br/>
<span>You may be interested in the use of the</span>
<span>die</span>
<span>function upon successfully logging in.</span>
<span>This is there because it combines an</span>
<span>echo</span>
<span>and an</span>
<span>exit</span>
<span>command in one, thus saving a</span>
<span>line of code. For styling, this (and most of the files) applies the class</span>
<span>main</span>
<span>to indent</span>
<span>the content from the left-hand edge.</span>
<br/>
<span>When you call this program up in your browser, it should look like</span>
<span>Figure 26-3</span>
<span>. Note</span>
<span>how the input type of</span>
<span>password</span>
<span>has been used here to mask the password with aster‐</span>
<span>isks to prevent it from being viewed by anyone looking over the user&rsquo;s shoulder.</span>
<br/>
<span>Example 26-7. login.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';
echo "&lt;div class='main'&gt;&lt;h3&gt;Please enter your details to log in&lt;/h3&gt;";

$error = $user = $pass = "";
if (isset($_POST['user']))
{
    $user = sanitizeString($_POST['user']);
    $pass = sanitizeString($_POST['pass']);
    if ($user == "" || $pass == "")
        $error = "Not all fields were entered&lt;br&gt;";
    else
    {
        $result = queryMySQL("SELECT user,pass FROM members WHERE user='$user' AND pass='$pass'");
        if ($result-&gt;num_rows == 0)
        {
            $error = "&lt;span class='error'&gt;Username/Password
            invalid&lt;/span&gt;&lt;br&gt;&lt;br&gt;";
        }
        else
        {
            $_SESSION['user'] = $user;
            $_SESSION['pass'] = $pass;
            die("You are now logged in. Please &lt;a href='members.php?view=$user'&gt;" .
            "click here&lt;/a&gt; to continue.&lt;br&gt;&lt;br&gt;");
        }
    }
}

echo &lt;&lt;&lt;_END
    &lt;form method='post' action='login.php'&gt;$error
    &lt;span class='fieldname'&gt;Username&lt;/span&gt;&lt;input type='text'
    maxlength='16' name='user' value='$user'&gt;&lt;br&gt;
    &lt;span class='fieldname'&gt;Password&lt;/span&gt;&lt;input type='password'
    maxlength='16' name='pass' value='$pass'&gt;
_END;
?&gt;
    &lt;br&gt;
    &lt;span class='fieldname'&gt;&amp;nbsp;&lt;/span&gt;
    &lt;input type='submit' value='Login'&gt;
    &lt;/form&gt;&lt;br&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.3.png"/></p>
<span>Figure 26-3. The login page</span>
<br/>
<h3>profile.php</h3>
<span>One of the first things that new users may want to do after signing up and logging</span>
<span>in is to create a profile, which can be done via</span>
<span>Example 26-8</span>
<span>,</span>
<span>profile.php</span>
<span>. I think you&rsquo;ll</span>
<span>find some interesting code here, such as routines to upload, resize, and sharpen</span>
<span>images.</span>
<br/>
<span>Let&rsquo;s start by looking at the main HTML at the end of the code. This is like the forms</span>
<span>you&rsquo;ve just seen, but this time it has the parameter</span>
<span>enctype='multipart/form-data'</span>
<span>.</span>
<span>This allows us to send more than one type of data at a time, enabling the posting of</span>
<span>an image as well as some text. There&rsquo;s also an input type of</span>
<span>file</span>
<span>, which creates a</span>
<span>Browse button that a user can press to select a file to be uploaded.</span>
<br/>
<span>When the form is submitted, the code at the start of the program is executed. The</span>
<span>first thing it does is ensure that a user is logged in before allowing program execution</span>
<span>to proceed. Only then is the page heading displayed.</span>
<h4>Adding the &ldquo;About Me&rdquo; Text</h4>
<span>Then the Post variable</span>
<span>text</span>
<span>is checked to see whether some text was posted to the</span>
<span>program. If so, it is sanitized and all long whitespace sequences (including returns</span>
<span>and line feeds) are replaced with a single space. This function incorporates a double</span>
<span>security check, ensuring that the user actually exists in the database and that no</span>
<span>attempted hacking can succeed before inserting this text into the database, where it</span>
<span>will become the user&rsquo;s &ldquo;about me&rdquo; details.</span>
<br/>
<span>If no text was posted, the database is queried to see whether any text already exists in</span>
<span>order to prepopulate the</span>
<span>textarea</span>
<span>for the user to edit it.</span>
<h4>Adding a Profile Image</h4>
<span>Next we move on to the section where the</span>
<span>$_FILES</span>
<span>system variable is checked to see</span>
<span>whether an image has been uploaded. If so, a string variable called</span>
<span>$saveto</span>
<span>is created,</span>
<span>based on the user&rsquo;s username followed by the extension</span>
<span>.jpg</span>
<span>. For example, user Jill will</span>
<span>cause</span>
<span>$saveto</span>
<span>to have the value</span>
<span>Jill.jpg</span>
<span>. This is the file where the uploaded image will</span>
<span>be saved for use in the user&rsquo;s profile.</span>
<br/>
<span>Following this, the uploaded image type is examined and is accepted only if it is a</span>
<span>jpeg</span>
<span>,</span>
<span>png</span>
<span>, or</span>
<span>gif</span>
<span>image. Upon success, the variable</span>
<span>$src</span>
<span>is populated with the uploaded</span>
<span>image using one of the</span>
<span>imagecreatefrom</span>
<span>functions according to the image type</span>
<span>uploaded. The image is now in a raw format that PHP can process. If the image is not</span>
<span>of an allowed type, the flag</span>
<span>$typeok</span>
<span>is set to</span>
<span>FALSE</span>
<span>, preventing the final section of</span>
<span>image upload code from being processed.</span>
<h4>Processing the Image</h4>
<span>First, we store the image&rsquo;s dimensions in</span>
<span>$w</span>
<span>and</span>
<span>$h</span>
<span>using the following statement,</span>
<span>which is a quick way of assigning values from an array to separate variables:</span>
<pre><code class="php">list($w, $h) = getimagesize($saveto);</code></pre>
<span>Then, using the value of</span>
<span>$max</span>
<span>(which is set to</span>
<span>100</span>
<span>), we calculate new dimensions that</span>
<span>will result in a new image of the same ratio, but with no dimension greater than 100</span>
<span>pixels. This results in giving the variables</span>
<span>$tw</span>
<span>and</span>
<span>$th</span>
<span>the new values needed. If you</span>
<span>want smaller or larger thumbnails, simply change the value of</span>
<span>$max</span>
<span>accordingly.</span>
<br/>
<span>Next, the function</span>
<span>imagecreatetruecolor</span>
<span>is called to create a new, blank canvas</span>
<span>$tw</span>
<span>wide and</span>
<span>$th</span>
<span>high in</span>
<span>$tmp</span>
<span>. Then</span>
<span>imagecopyresampled</span>
<span>is called to resample the image</span>
<span>from</span>
<span>$src</span>
<span>, to the new</span>
<span>$tmp</span>
<span>. Sometimes resampling images can result in a slightly</span>
<span>blurred copy, so the next piece of code uses the</span>
<span>imageconvolution</span>
<span>function to</span>
<span>sharpen the image up a bit.</span>
<br/>
<span>Finally, the image is saved as a</span>
<span>&nbsp;jpeg</span>
<span>&nbsp;file in the location defined by the variable</span>
<span>$saveto</span>
<span>, after which we remove both the original and the resized image canvases</span>
<span>from memory using the</span>
<span>imagedestroy</span>
<span>function, returning the memory that was</span>
<span>used.</span>
<h4>Displaying the Current Profile</h4>
<span>Last but not least, so that the user can see what the current profile looks like before</span>
<span>editing it, the</span>
<span>showProfile</span>
<span>function from</span>
<span>functions.php</span>
<span>is called prior to outputting</span>
<span>the form HTML. If no profile exists yet, nothing will be displayed.</span>
<br/>
<span>When a profile image is displayed, CSS is applied to it to provide a border, shadow,</span>
<span>and a margin to its right&mdash;to separate the profile text from the image. The result of</span>
<span>loading</span>
<span>Example 26-8</span>
<span>into a browser is shown in</span>
<span>Figure 26-4</span>
<span>, where you can see that</span>
<span>the</span>
<span>textarea</span>
<span>has been prepopulated with the &ldquo;about me&rdquo; text.</span>
<br/>
<span>Example 26-8.</span>
<span>profile.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';

if (!$loggedin) die();

echo "&lt;div class='main'&gt;&lt;h3&gt;Your Profile&lt;/h3&gt;";
$result = queryMysql("SELECT * FROM profiles WHERE user='$user'");

if (isset($_POST['text']))
{
    $text = sanitizeString($_POST['text']);
    $text = preg_replace('/\s\s+/', ' ', $text);
    
    if ($result-&gt;num_rows)
        queryMysql("UPDATE profiles SET text='$text' where user='$user'");
    else queryMysql("INSERT INTO profiles VALUES('$user', '$text')");
}
else
{
    if ($result-&gt;num_rows)
    {
        $row = $result-&gt;fetch_array(MYSQLI_ASSOC);
        $text = stripslashes($row['text']);
    }
    else $text = "";
}

$text = stripslashes(preg_replace('/\s\s+/', ' ', $text));
if (isset($_FILES['image']['name']))
{
    $saveto = "$user.jpg";
    move_uploaded_file($_FILES['image']['tmp_name'], $saveto);
    $typeok = TRUE;
    switch($_FILES['image']['type'])
    {
        case "image/gif": $src = imagecreatefromgif($saveto); break;
        case "image/jpeg": // Both regular and progressive jpegs
        case "image/pjpeg": $src = imagecreatefromjpeg($saveto); break;
        case "image/png": $src = imagecreatefrompng($saveto); break;
        default: $typeok = FALSE; break;
    }
    
    if ($typeok)
    {
        list($w, $h) = getimagesize($saveto);
        $max = 100;
        $tw = $w;
        $th = $h;
        if ($w &gt; $h &amp;&amp; $max &lt; $w)
        {
            $th = $max / $w * $h;
            $tw = $max;
        }
        elseif ($h &gt; $w &amp;&amp; $max &lt; $h)
        {
            $tw = $max / $h * $w;
            $th = $max;
        }
        elseif ($max &lt; $w)
        {
            $tw = $th = $max;
        }

        $tmp = imagecreatetruecolor($tw, $th);
        imagecopyresampled($tmp, $src, 0, 0, 0, 0, $tw, $th, $w, $h);
        imageconvolution($tmp, array(array(-1, -1, -1),
        array(-1, 16, -1), array(-1, -1, -1)), 8, 0);
        imagejpeg($tmp, $saveto);
        imagedestroy($tmp);
        imagedestroy($src);
    }
}

showProfile($user);
echo &lt;&lt;&lt;_END
    &lt;form method='post' action='profile.php' enctype='multipart/form-data'&gt;
    &lt;h3&gt;Enter or edit your details and/or upload an image&lt;/h3&gt;
    &lt;textarea name='text' cols='50' rows='3'&gt;$text&lt;/textarea&gt;&lt;br&gt;
_END;
?&gt;
    Image: &lt;input type='file' name='image' size='14'&gt;
    &lt;input type='submit' value='Save Profile'&gt;
    &lt;/form&gt;&lt;/div&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.4.png"/></p>
<span>Figure 26-4. Editing a user profile</span>
<br/>
<h3>members.php</h3>
<span>Using</span>
<span>Example 26-9</span>
<span>,</span>
<span>members.php</span>
<span>, your users will be able to find other members</span>
<span>and choose to add them as friends (or drop them if they are already friends). This</span>
<span>program has two modes. The first lists all members and their relationships to you,</span>
<span>and the second shows a user&rsquo;s profile.</span>
<h4>Viewing a User&rsquo;s Profile</h4>
<span>The code for the latter mode comes first, where a test is made for the Get variable</span>
<span>view</span>
<span>. If it exists, a user wants to view someone&rsquo;s profile, so the program does that</span>
<span>using the</span>
<span>showProfile</span>
<span>function, along with providing a couple of links to the user&rsquo;s</span>
<span>friends and messages.</span>
<h4>Adding and Dropping Friends</h4>
<span>After that, the two Get variables,</span>
<span>add</span>
<span>and</span>
<span>remove</span>
<span>, are tested. If one or the other has a</span>
<span>value, it will be the username of a user to either add or drop as a friend. We achieve</span>
<span>this by looking up the user in the MySQL</span>
<span>friends</span>
<span>table and either inserting a friend</span>
<span>username or removing it from the table.</span>
<br/>
<span>And, of course, every posted variable is first passed through</span>
<span>sanitizeString</span>
<span>to</span>
<span>ensure that it is safe to use with MySQL.</span>
<h4>Listing All Members</h4>
<span>The final section of code issues a SQL query to list all usernames. The code places the</span>
<span>number returned in the variable</span>
<span>$num</span>
<span>before outputting the page heading.</span>
<br/>
<span>A</span>
<span>for</span>
<span>loop then iterates through each and every member, fetching their details and</span>
<span>then looking them up in the</span>
<span>friends</span>
<span>table to see if they are either being followed by</span>
<span>or a follower of the user. If someone is both a follower and a followee, she is classed as</span>
<span>a mutual friend.</span>
<br/>
<span>The variable</span>
<span>$t1</span>
<span>is nonzero when the user is following another member, and</span>
<span>$t2</span>
<span>is</span>
<span>nonzero when another member is following the user. Depending on these values, text</span>
<span>is displayed after each username, showing the relationship (if any) to the current user.</span>
<br/>
<span>Icons are also displayed to show the relationships. A double pointing arrow means</span>
<span>that the users are mutual friends. A left-pointing arrow indicates the user is following</span>
<span>another member. And a right-pointing arrow indicates that another member is fol‐</span>
<span>lowing the user.</span>
<br/>
<span>Finally, depending on whether the user is following another member, a link is pro‐</span>
<span>vided to either add or drop that member as a friend.</span>
<span>When you call</span>
<span>Example 26-9</span>
<span>up in a browser, it will look like</span>
<span>Figure 26-5</span>
<span>. See how</span>
<span>the user is invited to &ldquo;follow&rdquo; a nonfollowing member, but if the member is already</span>
<span>following the user, a &ldquo;recip&rdquo; link to reciprocate the friendship is offered. In the case of</span>
<span>a user already following another member, the user can select &ldquo;drop&rdquo; to end the follow‐</span>
<span>ing.</span>
<br/>
<span>Example 26-9. members.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';
if (!$loggedin) die();

echo "&lt;div class='main'&gt;";

if (isset($_GET['view']))
{
    $view = sanitizeString($_GET['view']);
    
    if ($view == $user) $name = "Your";
    else $name = "$view's";
    
    echo "&lt;h3&gt;$name Profile&lt;/h3&gt;";
    showProfile($view);
    echo "&lt;a class='button' href='messages.php?view=$view'&gt;" .
         "View $name messages&lt;/a&gt;&lt;br&gt;&lt;br&gt;";
    die("&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;");
}

if (isset($_GET['add']))
{
    $add = sanitizeString($_GET['add']);
    $result = queryMysql("SELECT * FROM friends WHERE user='$add' AND friend='$user'");
    if (!$result-&gt;num_rows)
        queryMysql("INSERT INTO friends VALUES ('$add', '$user')");
    }
elseif (isset($_GET['remove']))
{
    $remove = sanitizeString($_GET['remove']);
    queryMysql("DELETE FROM friends WHERE user='$remove' AND friend='$user'");
}
    
$result = queryMysql("SELECT user FROM members ORDER BY user");
$num = $result-&gt;num_rows;
echo "&lt;h3&gt;Other Members&lt;/h3&gt;&lt;ul&gt;";

for ($j = 0 ; $j &lt; $num ; ++$j)
{
    $row = $result-&gt;fetch_array(MYSQLI_ASSOC);
    if ($row['user'] == $user) continue;
    echo "&lt;li&gt;&lt;a href='members.php?view=" . $row['user'] . "'&gt;" . $row['user'] . "&lt;/a&gt;";
    $follow = "follow";

    $result1 = queryMysql("SELECT * FROM friends WHERE user='" . $row['user'] . "' AND friend='$user'");
    $t1 = $result1-&gt;num_rows;

    $result1 = queryMysql("SELECT * FROM friends WHERE user='$user' AND friend='" . $row['user'] . "'");
    $t2 = $result1-&gt;num_rows;

    if (($t1 + $t2) &gt; 1) echo " &amp;harr; is a mutual friend";
    elseif ($t1) echo " &amp;larr; you are following";
    elseif ($t2) { 
        echo " &amp;rarr; is following you";
        $follow = "recip"; 
    }
    
    if (!$t1) echo " [&lt;a href='members.php?add=" .  $row['user'] . "'&gt;$follow&lt;/a&gt;]";
    else echo " [&lt;a href='members.php?remove=" . $row['user'] . "'&gt;drop&lt;/a&gt;]";
}
?&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.5.png"/></p>
<span>Figure 26-5. Using the members module</span>
<br/>
<span>On a production server, there could be thousands or even hun‐</span>
<span>dreds of thousands of users, so you would probably substantially</span>
<span>modify this program to include searching the &ldquo;about me&rdquo; text, sup‐</span>
<span>port paging of the output a screen at a time, and so on.</span>
<h3>friends.php</h3>
<span>The module that shows a user&rsquo;s friends and followers is</span>
<span>Example 26-10</span>
<span>,</span>
<span>friends.php</span>
<span>.</span>
<span>This interrogates the</span>
<span>friends</span>
<span>table just like the</span>
<span>members.php</span>
<span>program, but only for a</span>
<span>single user. It then shows all of that user&rsquo;s mutual friends and followers along with the</span>
<span>people he is following.</span>
<br/>
<span>All the followers are saved into an array called</span>
<span>$followers</span>
<span>, and all the people being</span>
<span>followed are placed in an array called</span>
<span>$following</span>
<span>. Then a neat piece of code is used</span>
<span>to extract all those who are both following and followed by the user, like this:</span>
<pre><code class="javascript">$mutual = array_intersect($followers, $following);</code></pre>
<span>The</span>
<span>array_intersect</span>
<span>function extracts all members common to both arrays and</span>
<span>returns a new array containing only those people. This array is then stored in</span>
<span>$mutual</span>
<span>. Now it&rsquo;s possible to use the</span>
<span>array_diff</span>
<span>function for each of the</span>
<span>$followers</span>
<span>and</span>
<span>$following</span>
<span>arrays to keep only those people who are</span>
<span>&nbsp;not</span>
<span>&nbsp;mutual friends, like</span>
<span>this:</span>
<pre>
<code class="php">
$followers = array_diff($followers, $mutual);
$following = array_diff($following, $mutual);
</code>
</pre>
<span>This results in the array</span>
<span>$mutual</span>
<span>containing only mutual friends,</span>
<span>$followers</span>
<span>con‐</span>
<span>taining only followers (and no mutual friends), and</span>
<span>$following</span>
<span>containing only peo‐</span>
<span>ple being followed (and no mutual friends).</span>
<br/>
<span>Now that we&rsquo;re armed with these arrays, it&rsquo;s a simple matter to separately display each</span>
<span>category of members, as can be seen in</span>
<span>&nbsp;Figure 26-6</span>
<span>. The PHP</span>
<span>sizeof</span>
<span>function</span>
<span>returns the number of elements in an array; here I use it just to trigger code when the</span>
<span>size is nonzero (that is, friends of that type exist). Note how, by using the variables</span>
<span>$name1</span>
<span>,</span>
<span>$name2</span>
<span>, and</span>
<span>$name3</span>
<span>in the relevant places, the code can tell when you&rsquo;re look‐</span>
<span>ing at your own friends list, using the words</span>
<span>Your</span>
<span>and</span>
<span>You are</span>
<span>, instead of simply dis‐</span>
<span>playing the username. The commented line can be uncommented if you wish to</span>
<span>display the user&rsquo;s profile information on this screen.</span>
<br/>
<span>Example 26-10. friends.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';
if (!$loggedin) die();

if (isset($_GET['view'])) $view = sanitizeString($_GET['view']);
else $view = $user;

if ($view == $user)
{
    $name1 = $name2 = "Your";
    $name3 = "You are";
}
else
{
    $name1 = "&lt;a href='members.php?view=$view'&gt;$view&lt;/a&gt;'s";
    $name2 = "$view's";
    $name3 = "$view is";
}

echo "&lt;div class='main'&gt;";
// Uncomment this line if you wish the user's profile to show here
// showProfile($view);

$followers = array();
$following = array();
$result = queryMysql("SELECT * FROM friends WHERE user='$view'");

$num = $result-&gt;num_rows;
for ($j = 0 ; $j &lt; $num ; ++$j)
{
    $row = $result-&gt;fetch_array(MYSQLI_ASSOC);
    $followers[$j] = $row['friend'];
}

$result = queryMysql("SELECT * FROM friends WHERE friend='$view'");
$num = $result-&gt;num_rows;
for ($j = 0 ; $j &lt; $num ; ++$j)
{
    $row = $result-&gt;fetch_array(MYSQLI_ASSOC);
    $following[$j] = $row['user'];
}

$mutual = array_intersect($followers, $following);
$followers = array_diff($followers, $mutual);
$following = array_diff($following, $mutual);
$friends = FALSE;

if (sizeof($mutual))
{
    echo "&lt;span class='subhead'&gt;$name2 mutual friends&lt;/span&gt;&lt;ul&gt;";
    
    foreach($mutual as $friend)
        echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";
    
    echo "&lt;/ul&gt;";
    $friends = TRUE;
}

if (sizeof($followers))
{
    echo "&lt;span class='subhead'&gt;$name2 followers&lt;/span&gt;&lt;ul&gt;";
    
    foreach($followers as $friend)
        echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";
    echo "&lt;/ul&gt;";
    
    $friends = TRUE;
}

if (sizeof($following))
{
    echo "&lt;span class='subhead'&gt;$name3 following&lt;/span&gt;&lt;ul&gt;";
    
    foreach($following as $friend)
        echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";
        
    echo "&lt;/ul&gt;";
    
    $friends = TRUE;
}

if (!$friends) echo "&lt;br&gt;You don't have any friends yet.&lt;br&gt;&lt;br&gt;";
    echo "&lt;a class='button' href='messages.php?view=$view'&gt;" . "View $name2 messages&lt;/a&gt;";
?&gt;
&lt;/div&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.6.png"/></p>
<span>Figure 26-6. Displaying a user&rsquo;s friends and followers</span>
<br/>
<h3>messages.php</h3>
<span>The last of the main modules is</span>
<span>Example 26-11</span>
<span>,</span>
<span>messages.php</span>
<span>. The program starts by</span>
<span>checking whether a message has been posted in variable</span>
<span>text</span>
<span>. If so, it is inserted into</span>
<span>the</span>
<span>messages</span>
<span>table. At the same time, the value of</span>
<span>pm</span>
<span>is also stored. This indicates</span>
<span>whether a message is private or public. A</span>
<span>0</span>
<span>represents a public message, and</span>
<span>1</span>
<span>is pri‐</span>
<span>vate.</span>
<br/>
<span>Next, the user&rsquo;s profile and a form for entering a message are displayed, along with</span>
<span>radio buttons to choose between a private or public message. After this, all the mes‐</span>
<span>sages are shown, depending on whether they are private or public. If they are public,</span>
<span>all users can see them, but private messages are visible only to the sender and recipi‐</span>
<span>ent. This is all handled by a couple of queries to the MySQL database. Additionally,</span>
<span>when a message is private, it is introduced by the word</span>
<span>whispered</span>
<span>and shown in italic.</span>
<br/>
<span>Finally, the program displays a couple of links to refresh the messages (in case</span>
<span>another user has posted one in the meantime) and to view the user&rsquo;s friends. The trick</span>
<span>using the variables</span>
<span>$name1</span>
<span>and</span>
<span>$name2</span>
<span>is again used so that when you view your own</span>
<span>profile, the word</span>
<span>Your</span>
<span>is displayed instead of the username.</span>
<br/>
<span>You can see the result of viewing this program with a browser in</span>
<span>Figure 26-7</span>
<span>. Note</span>
<span>how users viewing their own messages are provided with links to erase any they don&rsquo;t</span>
<span>want.</span>
<br/>
<span>Example 26-11. messages.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';
if (!$loggedin) die();

if (isset($_GET['view'])) $view = sanitizeString($_GET['view']);
else $view = $user;

if (isset($_POST['text']))
{
    $text = sanitizeString($_POST['text']);
    if ($text != "")
    {
        $pm = substr(sanitizeString($_POST['pm']),0,1);
        $time = time();
        queryMysql("INSERT INTO messages VALUES(NULL, '$user', '$view', '$pm', $time, '$text')");
    }
}

if ($view != "")
{
    if ($view == $user) $name1 = $name2 = "Your";
    else
    {
        $name1 = "&lt;a href='members.php?view=$view'&gt;$view&lt;/a&gt;'s";
        $name2 = "$view's";
    }
    
    echo "&lt;div class='main'&gt;&lt;h3&gt;$name1 Messages&lt;/h3&gt;";
    showProfile($view);
    echo &lt;&lt;&lt;_END
            &lt;form method='post' action='messages.php?view=$view'&gt;
            Type here to leave a message:&lt;br&gt;
            &lt;textarea name='text' cols='40' rows='3'&gt;&lt;/textarea&gt;&lt;br&gt;
            Public&lt;input type='radio' name='pm' value='0' checked='checked'&gt;
            Private&lt;input type='radio' name='pm' value='1'&gt;
            &lt;input type='submit' value='Post Message'&gt;&lt;/form&gt;&lt;br&gt;
_END;

if (isset($_GET['erase']))
{
    $erase = sanitizeString($_GET['erase']);
    queryMysql("DELETE FROM messages WHERE id=$erase AND recip='$user'");
}

$query = "SELECT * FROM messages WHERE recip='$view' ORDER BY time DESC";
$result = queryMysql($query);
$num = $result-&gt;num_rows;

for ($j = 0 ; $j &lt; $num ; ++$j)
{
    $row = $result-&gt;fetch_array(MYSQLI_ASSOC);

    if ($row['pm'] == 0 || $row['auth'] == $user || $row['recip'] == $user)
    {
        echo date('M jS \'y g:ia:', $row['time']);
        echo " &lt;a href='messages.php?view=" . $row['auth'] . "'&gt;" . $row['auth']. "&lt;/a&gt; ";

        if ($row['pm'] == 0)
            echo "wrote: &amp;quot;" . $row['message'] . "&amp;quot; ";
        else
            echo "whispered: &lt;span class='whisper'&gt;&amp;quot;" . $row['message'] . "&amp;quot;&lt;/span&gt; ";

        if ($row['recip'] == $user)
            echo "[&lt;a href='messages.php?view=$view" . "&amp;erase=" . $row['id'] . "'&gt;erase&lt;/a&gt;]";
            echo "&lt;br&gt;";
        }
    }
}

if (!$num) echo "&lt;br&gt;&lt;span class='info'&gt;No messages yet&lt;/span&gt;&lt;br&gt;&lt;br&gt;";
echo "&lt;br&gt;&lt;a class='button' href='messages.php?view=$view'&gt;Refresh messages&lt;/a&gt;";
?&gt;
&lt;/div&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.7.png"/></p>
<span>Figure 26-7. The messaging module</span>
<br/>
<h3>logout.php</h3>
<span>The final ingredient in our social networking recipe is</span>
<span>Example 26-12</span>
<span>,</span>
<span>logout.php</span>
<span>, the</span>
<span>logout page that closes a session and deletes any associated data and cookies. The</span>
<span>result of calling up this program is shown in</span>
<span>Figure 26-8</span>
<span>, where the user is now asked</span>
<span>to click a link that will take her to the un-logged-in home page and remove the</span>
<span>logged-in links from the top of the screen. Of course, you could write a JavaScript or</span>
<span>PHP redirect to do this (probably a good idea if you wish to keep logout looking</span>
<span>clean).</span>
<br/>
<span>Example 26-12. logout.php</span>
<pre>
<code class="php">
&lt;?php
require_once 'header.php';
if (isset($_SESSION['user']))
{
    destroySession();
    echo "&lt;div class='main'&gt;You have been logged out. Please " ."&lt;a href='index.php'&gt;click here&lt;/a&gt; to refresh the screen.";
}
else echo "&lt;div class='main'&gt;&lt;br&gt;" ."You cannot log out because you are not logged in";
?&gt;
    &lt;br&gt;&lt;br&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>
<p><img src="images/26.8.png"/></p>
<span>Figure 26-8. The logout page</span>
<br/>
<h3>styles.css</h3>
<span>The style sheet used for this project is shown in</span>
<span>Example 26-13</span>
<span>. There are a number</span>
<span>of sets of declarations, as follows:</span>
<br/>
<span>*</span>
<div class="t30">Sets the default font family and size for the project using the universal selector.</div>

<span>body</span>
<div class="t30">Sets the width of the project window, centers it horizontally, specifies a background color, and gives it a border.</div>

<span>html</span>
<div class="t30">Sets the background color of the HTML section.</div>

<span>img</span>
<div class="t30">Gives all images a border, shadow, and a righthand margin.</div>

<span>li a and .button</span>
<div class="t30">Remove underlines from hyperlinks in all &lt;a&gt; tags that are within a &lt;li&gt;
element, and all elements employing the button class.</div>

<span>li a:hover and .button:hover</span>
<div class="t30">Sets the color in which &lt;li&gt; elements and the button class should display text when hovered over.</div>

<span>.appname</span>
<div class="t30">Sets the properties for the heading (which uses the appname class), including center‐ing, background and text colors, the font family and size, and the padding.</div>

<span>.fieldname</span>
<div class="t30">Sets the width of elements using the fieldname class by first floating them.</div>

<span>.main</span>
<div class="t30">This class applies an indent to elements that use it.</div>

<span>.info</span>
<div class="t30">This class is used for displaying important information. It sets a background and foreground text color, applies a border and padding, and indents elements that employ it.</div>

<span>.menu li and .button</span>
<div class="t30">These declarations ensure that all &lt;li&gt; elements and the button
class display inline, have padding applied, and include a border, a background and foreground text color,
a right margin, rounded borders, and a shadow&mdash;resulting in a button effect.</div>

<span>.subhead</span>
<div class="t30">Emphasizes sections of text.</div>

<span>.taken, .available, .error, and .whisper</span>
<div class="t30">These declarations set the colors and font styles to be used for displaying different types of information.</div>

<span>#logo</span>
<div class="t30">These rules style the logo text as a fallback in case a non-HTML5 browser is in use and the canvas logo doesn&rsquo;t get created.</div>
<br/>
<span>Example 26-13. styles.css</span>
<pre>
<code class="css">
* {
    font-family:verdana,sans-serif;
    font-size :14pt;
}
body {
    width :700px;
    margin :20px auto;
    background:#f8f8f8;
    border :1px solid #888;
}
html {
    background:#fff
}
img {
    border :1px solid black;
    margin-right :15px;
    -moz-box-shadow :2px 2px 2px #888;
    -webkit-box-shadow:2px 2px 2px #888;
    box-shadow :2px 2px 2px #888;
}
li a, .button {
    text-decoration:none;
}
li a:hover, .button:hover {
    color:green;
}
.appname {
    text-align :center;
    background :#eb8;
    color :#40d;
    font-family:helvetica;
    font-size :20pt;
    padding :4px;
}
.fieldname {
    float:left;
    width:120px;
}
.main {
    margin-left:40px;
}
.info {
    background :lightgreen;
    color :blue;
    border :1px solid green;
    padding :5px 10px;
    margin-left:40px;
}
.menu li, .button {
    display :inline;
    padding :4px 6px;
    border :1px solid #777;
    background :#ddd;
    color :#d04;
    margin-right :8px;
    border-radius :5px;
    -moz-box-shadow :2px 2px 2px #888;
    -webkit-box-shadow:2px 2px 2px #888;
    box-shadow :2px 2px 2px #888;
}
.subhead {
    font-weight:bold;
}
.taken, .error {
    color:red;
}
.available {
    color:green;
}
.whisper {
    font-style:italic;
    color :#006600;
}
#logo {
    font-family:Georgia;
    font-weight:bold;
    font-style :italic;
    font-size :97px;
}
</code>
</pre>
<h3>javascript.js</h3>
<span>Finally, there&rsquo;s the JavaScript file (see</span>
<span>Example 26-14</span>
<span>), which contains the</span>
<span>O</span>
<span>,</span>
<span>S</span>
<span>, and</span>
<span>C</span>
<span>functions used throughout this book, along with some code to draw the logo for the</span>
<span>site using an HTML5 canvas, as explained in</span>
<span>Chapter 23</span>
<span>.</span>
<br/>
<span>Example 26-14. javascript.js</span>
<pre>
<code class="css">
canvas = O('logo')
context = canvas.getContext('2d')

context.font = 'bold italic 97px Georgia'
context.textBaseline = 'top'
image = new Image()
image.src = 'robin.gif'

image.onload = function()
{
    gradient = context.createLinearGradient(0, 0, 0, 89)
    gradient.addColorStop(0.00, '#faa')
    gradient.addColorStop(0.66, '#f00')
    
    context.fillStyle = gradient
    context.fillText( "R bin's Nest", 0, 0)
    context.strokeText("R bin's Nest", 0, 0)
    context.drawImage(image, 64, 32)
}

function O(obj)
{
    if (typeof obj == 'object') return obj
    else return document.getElementById(obj)
}

function S(obj)
{
    return O(obj).style
}

function C(name)
{
    var elements = document.getElementsByTagName('*')
    var objects = []
    for (var i = 0 ; i &lt; elements.length ; ++i)
        if (elements[i].className == name)
            objects.push(elements[i])
    return objects
}
</code>
</pre>
<span>And that, as they say, is that. If you write anything based on this code or any other</span>
<span>examples in this book, or have gained in any other way from it, then I am glad to have</span>
<span>been of help and thank you for reading this book.</span>
<br/>
<span>But before you go and try out your newly learned skills on the Web at large, please</span>
<span>browse through the appendixes that follow, as there&rsquo;s a lot of additional information</span>
<span>there you should find useful.</span>