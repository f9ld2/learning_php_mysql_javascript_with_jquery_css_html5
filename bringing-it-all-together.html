---
layout: default
title: "Bringing It All Together"
---
<h2>Bringing It All Together</h2>
<span>Now that you&rsquo;ve reached the end of your journey into learning the hows, whys, and</span>
<span>wherefores of dynamic web programming, I want to leave you with a real example</span>
<span>that you can sink your teeth into. In fact, it&rsquo;s a collection of examples, because I&rsquo;ve put</span>
<span>together a simple social networking project comprising all the main features you&rsquo;d</span>
<span>expect from such a site.</span>
<br/>
<span>Across the various files, there are examples of MySQL table creation and database</span>
<span>access, CSS style sheets, file inclusion, session control, DOM access, Ajax calls, event</span>
<span>and error handling, file uploading, image manipulation, the HTML5 canvas, and a</span>
<span>whole lot more.</span>
<br/>
<span>Each example file is complete and self-contained, yet works with all the others to</span>
<span>build a fully working social networking site, even including a style sheet you can</span>
<span>modify to completely change the look and feel of the project. Being small and light,</span>
<span>the end product is particularly usable on mobile platforms such as a smartphone or</span>
<span>tablet, but will run equally well on a full-size desktop computer.</span>
<br/>
<span>I leave it up to you to take any pieces of code you think you can use and expand on</span>
<span>them for your own purposes. Perhaps you may even wish to build on these files to</span>
<span>create a social networking site of your own.</span>
<h3>Designing a Social Networking Site</h3>
<span>Before writing any code, I sat down and came up with several things that I decided</span>
<span>were essential to such a site. These included the following:</span>
<br/>
<span>&bull;</span>
<span>A sign-up process</span>
<br/>
<span>&bull;</span>
<span>A login form</span>
<br/>
<span>&bull;</span>
<span>A logout facility</span>
<br/>
<span>&bull;</span>
<span>Session control</span>
<br/>
<span>&bull;</span>
<span>User profiles with uploaded thumbnails</span>
<br/>
<span>&bull;</span>
<span>A member directory</span>
<br/>
<span>&bull;</span>
<span>Adding members as friends</span>
<br/>
<span>&bull;</span>
<span>Public and private messaging between members</span>
<br/>
<span>&bull;</span>
<span>How to style the project</span>
<br/>
<span>I decided to name the project</span>
<span>Robin&rsquo;s Nest</span>
<span>, but you have to modify only one line of</span>
<span>code (in</span>
<span>functions.php</span>
<span>) to change this to a name of your choice.</span>
<h3>On the Website</h3>
<span>All the examples in this chapter can be found on the companion website located at</span>
<span>http://lpmj.net</span>
<span>. You can also download the examples from there to your computer by</span>
<span>clicking the Download Examples link. This will download an archive file called</span>
<span>exam‐</span>
<span>ples.zip</span>
<span>, which you should extract to a suitable location on your computer.</span>
<br/>
<span>Of particular interest to this chapter, within the zip file you&rsquo;ll find there&rsquo;s a folder</span>
<span>called</span>
<span>robinsnest</span>
<span>, in which all the following examples have been saved with the correct</span>
<span>filenames required by this sample application. So you can easily copy them all to your</span>
<span>web development folder to try them out.</span>
<h3>functions.php</h3>
<span>Let&rsquo;s jump right into the project, starting with</span>
<span>&nbsp;Example 26-1</span>
<span>,</span>
<span>&nbsp;functions.php</span>
<span>, the</span>
<span>include file of the main functions. This file contains a little more than just the func‐</span>
<span>tions, though, because I have added the database login details here instead of using</span>
<span>yet another separate file. So the first half-dozen lines of code define the host, database</span>
<span>name, username, and password of the database to use.</span>
<br/>
<span>It doesn&rsquo;t matter what you call the database, as long as it already exists (see</span>
<span>Chapter 8</span>
<span>for instructions on how to create a new database). Also make sure to correctly assign</span>
<span>a MySQL username and password to</span>
<span>$dbuser</span>
<span>and</span>
<span>$dbpass</span>
<span>. With correct values, the</span>
<span>subsequent two lines will open a connection to MySQL and select the database. The</span>
<span>last of the initial instructions sets the name of the social networking site by assigning</span>
<span>the value</span>
<span>Robin's Nest</span>
<span>to the variable</span>
<span>$appname</span>
<span>. If you want to change the name,</span>
<span>this is the place to do so.</span>
<h4>The Functions</h4>
<span>The project uses five main functions:</span>
<br/>
<span>createTable</span>
<span>Checks whether a table already exists and, if not, creates it</span>
<br/>
<span>queryMysql</span>
<span>Issues a query to MySQL, outputting an error message if it fails</span>
<br/>
<span>destroySession</span>
<span>Destroys a PHP session and clears its data to log users out</span>
<br/>
<span>sanitizeString</span>
<span>Removes potentially malicious code or tags from user input</span>
<br/>
<span>showProfile</span>
<span>Displays a user&rsquo;s image and &ldquo;about me&rdquo; message if he has one</span>
<br/>
<span>All of these should be obvious in their action to you by now, with the possible excep‐</span>
<span>tion of</span>
<span>showProfile</span>
<span>, which looks for an image of the name</span>
<span>user.jpg</span>
<span>(where</span>
<span>user</span>
<span>is the</span>
<span>username of the current user), and if it finds it, displays it. It also displays any &ldquo;about</span>
<span>me&rdquo; text the user may have saved.</span>
<br/>
<span>I have ensured that error handling is in place for all the functions that need it, so that</span>
<span>they can catch any typographical or other errors you may introduce, and generate</span>
<span>error messages. However, if you use any of this code on a production server, you will</span>
<span>probably want to provide your own error-handling routines to make the code more</span>
<span>user-friendly.</span>
<br/>
<span>So type</span>
<span>Example 26-1</span>
<span>and save it as</span>
<span>functions.php</span>
<span>(or download it from the compan‐</span>
<span>ion website), and you&rsquo;ll be ready to move on to the next section.</span>
<br/>
<span>Example 26-1. functions.php</span>
<br/>
<span>&lt;?php</span>
<span>$dbhost = 'localhost'; // Unlikely to require changing</span>
<span>$dbname = 'robinsnest'; // Modify these...</span>
<span>$dbuser = 'robinsnest'; // ...variables according</span>
<span>$dbpass = 'rnpassword'; // ...to your installation</span>
<span>$appname = "Robin's Nest"; // ...and preference</span>
<span>$connection = new mysqli($dbhost, $dbuser, $dbpass, $dbname);</span>
<span>if ($connection-&gt;connect_error) die($connection-&gt;connect_error);</span>
<span>function createTable($name, $query)</span>
<span>{</span>
<span>queryMysql("CREATE TABLE IF NOT EXISTS $name($query)");</span>
<span>echo "Table '$name' created or already exists.&lt;br&gt;";</span>
<span>}</span>
<span>function queryMysql($query)</span>
<span>{</span>
<span>global $connection;</span>
<span>$result = $connection-&gt;query($query);</span>
<span>if (!$result) die($connection-&gt;error);</span>
<span>return $result;</span>
<span>}</span>
<span>function destroySession()</span>
<span>{</span>
<span>$_SESSION=array();</span>
<span>if (session_id() != "" || isset($_COOKIE[session_name()]))</span>
<span>&nbsp;</span>
<span>setcookie(session_name(), '', time()-2592000, '/');</span>
<span>session_destroy();</span>
<span>}</span>
<span>function sanitizeString($var)</span>
<span>{</span>
<span>global $connection;</span>
<span>$var = strip_tags($var);</span>
<span>$var = htmlentities($var);</span>
<span>$var = stripslashes($var);</span>
<span>return $connection-&gt;real_escape_string($var);</span>
<span>}</span>
<span>function showProfile($user)</span>
<span>{</span>
<span>if (file_exists("$user.jpg"))</span>
<span>&nbsp;</span>
<span>echo "&lt;img src='$user.jpg' style='float:left;'&gt;";</span>
<span>$result = queryMysql("SELECT * FROM profiles WHERE user='$user'");</span>
<span>if ($result-&gt;num_rows)</span>
<span>{</span>
<span>&nbsp;</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>&nbsp;</span>
<span>echo stripslashes($row['text']) . "&lt;br style='clear:left;'&gt;&lt;br&gt;";</span>
<span>}</span>
<span>}</span>
<span>?&gt;</span>
<br/>
<span>If you read a previous edition of this book, in which these examples</span>
<span>used the old</span>
<span>mysql</span>
<span>extension, you should note that in order to ref‐</span>
<span>erence the MySQL database using</span>
<span>mysqli</span>
<span>, you must apply the</span>
<span>global</span>
<span>keyword in the</span>
<span>queryMysql</span>
<span>and</span>
<span>sanitizeString</span>
<span>functions,</span>
<span>to allow them to use the value in</span>
<span>$connection</span>
<span>.</span>
<h3>header.php</h3>
<span>For uniformity, each page of the project needs to have access to the same set of fea‐</span>
<span>tures. Therefore, I placed these things in</span>
<span>&nbsp;Example 26-2</span>
<span>,</span>
<span>&nbsp;header.php</span>
<span>. This is the file</span>
<span>that is actually included by the other files and it includes</span>
<span>functions.php</span>
<span>. This means</span>
<span>that only a single</span>
<span>require_once</span>
<span>is needed in each file.</span>
<br/>
<span>header.php</span>
<span>starts by calling the function</span>
<span>session_start</span>
<span>. As you&rsquo;ll recall from</span>
<span>Chap‐</span>
<span>ter 12</span>
<span>, this sets up a session that will remember certain values we want stored across</span>
<span>different PHP files.</span>
<br/>
<span>With the session started, the program then checks whether the session variable</span>
<span>user</span>
<span>is currently assigned a value. If so, a user has logged in and the variable</span>
<span>$loggedin</span>
<span>is</span>
<span>set to</span>
<span>TRUE</span>
<span>.</span>
<br/>
<span>After the main setup code in which a style sheet is loaded, a canvas element is created</span>
<span>for the logo, and a div is also created. The file</span>
<span>javascript.js</span>
<span>(see</span>
<span>Example 26-14</span>
<span>, later</span>
<span>on) is loaded to pull in the</span>
<span>O</span>
<span>,</span>
<span>S</span>
<span>, and</span>
<span>C</span>
<span>functions; these would normally be in the</span>
<span>OSC.js</span>
<span>file, but to keep the number of files down I&rsquo;ve added them to the JavaScript</span>
<span>used to create the logo.</span>
<br/>
<span>Using the value of</span>
<span>$loggedin</span>
<span>, an</span>
<span>if</span>
<span>block displays one of two sets of menus. The</span>
<span>non-logged-in set simply offers options of Home, Sign up, and Log in, whereas the</span>
<span>logged-in version offers full access to the project&rsquo;s features. Additionally, if a user is</span>
<span>logged in, his or her username is appended in brackets to the page title and placed</span>
<span>after the main heading. We can freely refer to</span>
<span>$user</span>
<span>wherever we want to put in the</span>
<span>name, because if the user is not logged in, that variable is empty and will have no</span>
<span>effect on the output.</span>
<br/>
<span>The styling applied to this file is in the file</span>
<span>styles.css</span>
<span>(</span>
<span>Example 26-13</span>
<span>, detailed at the</span>
<span>end of this chapter) and includes creating a wide heading with a colored background,</span>
<span>and turning the links in the lists to rounded buttons.</span>
<br/>
<span>Example 26-2. header.php</span>
<br/>
<span>&lt;?php</span>
<span>session_start();</span>
<span>echo "&lt;!DOCTYPE html&gt;\n&lt;html&gt;&lt;head&gt;";</span>
<span>require_once 'functions.php';</span>
<span>$userstr = ' (Guest)';</span>
<span>if (isset($_SESSION['user']))</span>
<span>{</span>
<span>$user = $_SESSION['user'];</span>
<span>$loggedin = TRUE;</span>
<span>$userstr = " ($user)";</span>
<span>}</span>
<span>else $loggedin = FALSE;</span>
<span>echo "&lt;title&gt;$appname$userstr&lt;/title&gt;&lt;link rel='stylesheet' " .</span>
<span>&nbsp;</span>
<span>"href='styles.css' type='text/css'&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;canvas id='logo' width='624' " .</span>
<span>&nbsp;</span>
<span>"height='96'&gt;$appname&lt;/canvas&gt;&lt;/center&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;div class='appname'&gt;$appname$userstr&lt;/div&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;script src='javascript.js'&gt;&lt;/script&gt;";</span>
<span>if ($loggedin)</span>
<span>echo "&lt;br &gt;&lt;ul class='menu'&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='members.php?view=$user'&gt;Home&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='members.php'&gt;Members&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='friends.php'&gt;Friends&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='messages.php'&gt;Messages&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='profile.php'&gt;Edit Profile&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='logout.php'&gt;Log out&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br&gt;";</span>
<span>else</span>
<span>echo ("&lt;br&gt;&lt;ul class='menu'&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='index.php'&gt;Home&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='signup.php'&gt;Sign up&lt;/a&gt;&lt;/li&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;li&gt;&lt;a href='login.php'&gt;Log in&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br&gt;" .</span>
<span>&nbsp;</span>
<span>"&lt;span class='info'&gt;&amp;#8658; You must be logged in to " .</span>
<span>&nbsp;</span>
<span>"view this page.&lt;/span&gt;&lt;br&gt;&lt;br&gt;");</span>
<span>?&gt;</span>
<span>Using the</span>
<span>&lt;br&gt;</span>
<span>tag, as in the preceding example, is a quick and</span>
<span>dirty way of creating spacing in page layout. In this instance it</span>
<span>works well, but generally you will probably want to use CSS mar‐</span>
<span>gins to fine-tune the spacing around elements.</span>
<h3>setup.php</h3>
<span>With the pair of included files written, it&rsquo;s now time to set up the MySQL tables they</span>
<span>will use. We do this with</span>
<span>Example 26-3</span>
<span>,</span>
<span>setup.php</span>
<span>, which you should type and load</span>
<span>into your browser before calling up any other files; otherwise, you&rsquo;ll get numerous</span>
<span>MySQL errors.</span>
<br/>
<span>The tables created are short and sweet, and have the following names and columns:</span>
<span>&bull;</span>
<span>members</span>
<span>: username</span>
<span>user</span>
<span>(indexed), password</span>
<span>pass</span>
<br/>
<span>&bull;</span>
<span>messages</span>
<span>: ID</span>
<span>id</span>
<span>(indexed), author</span>
<span>auth</span>
<span>(indexed), recipient</span>
<span>recip</span>
<span>, message type</span>
<span>pm</span>
<span>, message</span>
<span>message</span>
<br/>
<span>&bull;</span>
<span>friends</span>
<span>: username</span>
<span>user</span>
<span>(indexed), friend&rsquo;s username</span>
<span>friend</span>
<br/>
<span>&bull;</span>
<span>profiles</span>
<span>: username</span>
<span>user</span>
<span>(indexed), &ldquo;about me&rdquo;</span>
<span>text</span>
<br/>
<span>Because the function</span>
<span>createTable</span>
<span>first checks whether a table already exists, this</span>
<span>program can be safely called multiple times without generating any errors.</span>
<br/>
<span>It is very likely that you will need to add many more columns to these tables if you</span>
<span>choose to expand on this project. If so, you may need to issue a MySQL</span>
<span>DROP TABLE</span>
<span>command before re-creating a table.</span>
<span>Example 26-3. setup.php</span>
<span>&lt;!DOCTYPE html&gt;</span>
<span>&lt;html&gt;</span>
<span>&lt;head&gt;</span>
<span>&lt;title&gt;Setting up database&lt;/title&gt;</span>
<span>&lt;/head&gt;</span>
<span>&lt;body&gt;</span>
<span>&lt;h3&gt;Setting up...&lt;/h3&gt;</span>
<span>&lt;?php</span>
<span>require_once 'functions.php';</span>
<span>createTable('members',</span>
<span>&nbsp;</span>
<span>'user VARCHAR(16),</span>
<span>&nbsp;</span>
<span>pass VARCHAR(16),</span>
<span>&nbsp;</span>
<span>INDEX(user(6))');</span>
<span>createTable('messages',</span>
<span>&nbsp;</span>
<span>'id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span>
<span>&nbsp;</span>
<span>auth VARCHAR(16),</span>
<span>&nbsp;</span>
<span>recip VARCHAR(16),</span>
<span>&nbsp;</span>
<span>pm CHAR(1),</span>
<span>&nbsp;</span>
<span>time INT UNSIGNED,</span>
<span>&nbsp;</span>
<span>message VARCHAR(4096),</span>
<span>&nbsp;</span>
<span>INDEX(auth(6)),</span>
<span>&nbsp;</span>
<span>INDEX(recip(6))');</span>
<span>createTable('friends',</span>
<span>&nbsp;</span>
<span>'user VARCHAR(16),</span>
<span>&nbsp;</span>
<span>friend VARCHAR(16),</span>
<span>&nbsp;</span>
<span>INDEX(user(6)),</span>
<span>&nbsp;</span>
<span>INDEX(friend(6))');</span>
<span>createTable('profiles',</span>
<span>&nbsp;</span>
<span>'user VARCHAR(16),</span>
<span>&nbsp;</span>
<span>text VARCHAR(4096),</span>
<span>&nbsp;</span>
<span>INDEX(user(6))');</span>
<span>?&gt;</span>
<span>&lt;br&gt;...done.</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<span>For this example to work, you must first ensure that you have</span>
<span>already created the database specified in the variable</span>
<span>$dbname</span>
<span>in</span>
<span>Example 26-1</span>
<span>, and also have granted access to it by the user given</span>
<span>the name in</span>
<span>$dbuser</span>
<span>, with the password in</span>
<span>$dbpass</span>
<span>.</span>
<h3>index.php</h3>
<span>This file is a trivial file but necessary nonetheless to give the project a home page. All</span>
<span>it does is display a simple welcome message. In a finished application, this would be</span>
<span>where you sell the virtues of your site to encourage sign-ups.</span>
<br/>
<span>Incidentally, seeing as all the MySQL tables have been created and the include files</span>
<span>saved, you can now load</span>
<span>Example 26-4</span>
<span>,</span>
<span>index.php</span>
<span>, into your browser to get your first</span>
<span>peek at the new application. It should look like</span>
<span>Figure 26-1</span>
<span>.</span>
<br/>
<span>Example 26-4. index.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>echo "&lt;br&gt;&lt;span class='main'&gt;Welcome to $appname,";</span>
<span>if ($loggedin) echo " $user, you are logged in.";</span>
<span>else echo ' please sign up and/or log in to join in.';</span>
<span>?&gt;</span>
<span>&lt;/span&gt;&lt;br&gt;&lt;br&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.1.png"/></p>
<span>Figure 26-1. The main page of the site</span>
<h3>signup.php</h3>
<span>Now</span>
<span>we</span>
<span>need</span>
<span>a</span>
<span>module</span>
<span>to</span>
<span>enable</span>
<span>users</span>
<span>to</span>
<span>join</span>
<span>the</span>
<span>new</span>
<span>network,</span>
<span>and</span>
<span>that&rsquo;s</span>
<span>Example 26-5</span>
<span>,</span>
<span>&nbsp;signup.php</span>
<span>. This is a slightly longer program, but you&rsquo;ve seen all its</span>
<span>parts before.</span>
<br/>
<span>Let&rsquo;s start by looking at the end block of HTML. This is a simple form that allows a</span>
<span>username and password to be entered. But note the use of the empty</span>
<span>span</span>
<span>given the</span>
<span>id</span>
<span>of</span>
<span>'info'</span>
<span>. This will be the destination of the Ajax call in this program that checks</span>
<span>whether a desired username is available. See</span>
<span>Chapter 18</span>
<span>for a complete description of</span>
<span>how this works.</span>
<h4>Checking for Username Availability</h4>
<span>Now go back to the program start and you&rsquo;ll see a block of JavaScript that starts with</span>
<span>the function</span>
<span>checkUser</span>
<span>. This is called by the JavaScript</span>
<span>onBlur</span>
<span>event when focus is</span>
<span>removed from the username field of the form. First it sets the contents of the span I</span>
<span>mentioned (with the</span>
<span>id</span>
<span>of</span>
<span>info</span>
<span>) to an empty string, which clears it in case it previ‐</span>
<span>ously had a value.</span>
<br/>
<span>Next a request is made to the program</span>
<span>checkuser.php</span>
<span>, which reports whether the user‐</span>
<span>name</span>
<span>user</span>
<span>is available. The returned result of the Ajax call, a friendly message, is then</span>
<span>placed in the</span>
<span>info</span>
<span>span.</span>
<br/>
<span>After the JavaScript section comes some PHP code that you should recognize from</span>
<span>the</span>
<span>&nbsp;Chapter 16</span>
<span>&nbsp;discussion of form validation. This section also uses the</span>
<span>sanitize</span>
<span>String</span>
<span>function to remove potentially malicious characters before looking up the</span>
<span>username in the database and, if it&rsquo;s not already taken, inserting the new username</span>
<span>$user</span>
<span>and password</span>
<span>$pass</span>
<span>.</span>
<h4>Logging In</h4>
<span>Upon successfully signing up, the user is then prompted to log in. A more fluid</span>
<span>response at this point might be to automatically log in a newly created user, but, as I</span>
<span>don&rsquo;t want to overly complicate the code, I have kept the sign-up and login modules</span>
<span>separate from each other. You can easily implement this if you want to, however.</span>
<br/>
<span>This file uses the CSS class</span>
<span>fieldname</span>
<span>to arrange the form fields, aligning them neatly</span>
<span>under each other in columns. When loaded into a browser (and in conjunction with</span>
<span>checkuser.php</span>
<span>, shown later), this program will look like</span>
<span>&nbsp;Figure 26-2</span>
<span>, where you can</span>
<span>see that the Ajax call has identified that the username</span>
<span>Robin</span>
<span>is available. If you would</span>
<span>like the password field to show only asterisks, change its type from</span>
<span>text</span>
<span>to</span>
<span>password</span>
<span>.</span>
<br/>
<span>Example 26-5. signup.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>echo &lt;&lt;&lt;_END</span>
<span>&lt;script&gt;</span>
<span>&nbsp;</span>
<span>function checkUser(user)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>if (user.value == '')</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>O('info').innerHTML = ''</span>
<span>&nbsp;</span>
<span>return</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>params = "user=" + user.value</span>
<span>&nbsp;</span>
<span>request = new ajaxRequest()</span>
<span>&nbsp;</span>
<span>request.open("POST", "checkuser.php", true)</span>
<span>&nbsp;</span>
<span>request.setRequestHeader("Content-type",</span>
<span>&nbsp;</span>
<span>"application/x-www-form-urlencoded")</span>
<span>&nbsp;</span>
<span>request.setRequestHeader("Content-length", params.length)</span>
<span>&nbsp;</span>
<span>request.setRequestHeader("Connection", "close")</span>
<span>&nbsp;</span>
<span>request.onreadystatechange = function()</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>if (this.readyState == 4)</span>
<span>&nbsp;</span>
<span>if (this.status == 200)</span>
<span>&nbsp;</span>
<span>if (this.responseText != null)</span>
<span>&nbsp;</span>
<span>O('info').innerHTML = this.responseText</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>request.send(params)</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>function ajaxRequest()</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>try { var request = new XMLHttpRequest() }</span>
<span>&nbsp;</span>
<span>catch(e1) {</span>
<span>&nbsp;</span>
<span>try { request = new ActiveXObject("Msxml2.XMLHTTP") }</span>
<span>&nbsp;</span>
<span>catch(e2) {</span>
<span>&nbsp;</span>
<span>try { request = new ActiveXObject("Microsoft.XMLHTTP") }</span>
<span>&nbsp;</span>
<span>catch(e3) {</span>
<span>&nbsp;</span>
<span>request = false</span>
<span>&nbsp;</span>
<span>} } }</span>
<span>&nbsp;</span>
<span>return request</span>
<span>&nbsp;</span>
<span>}</span>
<span>&lt;/script&gt;</span>
<span>&lt;div class='main'&gt;&lt;h3&gt;Please enter your details to sign up&lt;/h3&gt;</span>
<span>_END;</span>
<span>$error = $user = $pass = "";</span>
<span>if (isset($_SESSION['user'])) destroySession();</span>
<span>if (isset($_POST['user']))</span>
<span>{</span>
<span>$user = sanitizeString($_POST['user']);</span>
<span>$pass = sanitizeString($_POST['pass']);</span>
<span>if ($user == "" || $pass == "")</span>
<span>&nbsp;</span>
<span>$error = "Not all fields were entered&lt;br&gt;&lt;br&gt;";</span>
<span>else</span>
<span>{</span>
<span>&nbsp;</span>
<span>$result = queryMysql("SELECT * FROM members WHERE user='$user'");</span>
<span>&nbsp;</span>
<span>if ($result-&gt;num_rows)</span>
<span>&nbsp;</span>
<span>$error = "That username already exists&lt;br&gt;&lt;br&gt;";</span>
<span>&nbsp;</span>
<span>else</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>queryMysql("INSERT INTO members VALUES('$user', '$pass')");</span>
<span>&nbsp;</span>
<span>die("&lt;h4&gt;Account created&lt;/h4&gt;Please Log in.&lt;br&gt;&lt;br&gt;");</span>
<span>&nbsp;</span>
<span>}</span>
<span>}</span>
<span>}</span>
<span>echo &lt;&lt;&lt;_END</span>
<span>&lt;form method='post' action='signup.php'&gt;$error</span>
<span>&lt;span class='fieldname'&gt;Username&lt;/span&gt;</span>
<span>&lt;input type='text' maxlength='16' name='user' value='$user'</span>
<span>&nbsp;</span>
<span>onBlur='checkUser(this)'&gt;&lt;span id='info'&gt;&lt;/span&gt;&lt;br&gt;</span>
<span>&lt;span class='fieldname'&gt;Password&lt;/span&gt;</span>
<span>&lt;input type='text' maxlength='16' name='pass'</span>
<span>&nbsp;</span>
<span>value='$pass'&gt;&lt;br&gt;</span>
<span>_END;</span>
<span>?&gt;</span>
<span>&lt;span class='fieldname'&gt;&amp;nbsp;&lt;/span&gt;</span>
<span>&lt;input type='submit' value='Sign up'&gt;</span>
<span>&lt;/form&gt;&lt;/div&gt;&lt;br&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<span>Figure 26-2. The sign-up page</span>
<span>On a production server, I wouldn&rsquo;t recommend storing user pass‐</span>
<span>words in the clear as I&rsquo;ve done here (for reasons of space and sim‐</span>
<span>plicity). Instead, you should salt them and store them as one-way</span>
<span>hash strings. See</span>
<span>Chapter 13</span>
<span>for more details on how to do this.</span>
<h3>checkuser.php</h3>
<span>To go with</span>
<span>signup.php</span>
<span>, here&rsquo;s</span>
<span>Example 26-6</span>
<span>,</span>
<span>checkuser.php</span>
<span>, which looks up a username</span>
<span>in the database and returns a string indicating whether it has already been taken.</span>
<span>Because it relies on the functions</span>
<span>sanitizeString</span>
<span>and</span>
<span>queryMysql</span>
<span>, the program first</span>
<span>includes the file</span>
<span>functions.php</span>
<span>.</span>
<br/>
<span>Then, if the</span>
<span>$_POST</span>
<span>variable</span>
<span>user</span>
<span>has a value, the function looks it up in the database</span>
<span>and, depending on whether it exists as a username, outputs either &ldquo;Sorry, this user‐</span>
<span>name</span>
<span>is</span>
<span>taken&rdquo;</span>
<span>or</span>
<span>&ldquo;</span>
<span>This</span>
<span>username</span>
<span>is</span>
<span>available.&rdquo;</span>
<span>Just</span>
<span>checking</span>
<span>the</span>
<span>function</span>
<span>mysql_num_rows</span>
<span>against the result is sufficient for this, as it will return</span>
<span>0</span>
<span>for not</span>
<span>found, or</span>
<span>1</span>
<span>if it is found.</span>
<br/>
<span>The HTML entities</span>
<span>&amp;#x2718;</span>
<span>and</span>
<span>&amp;#x2714;</span>
<span>are also used to preface the string with</span>
<span>either a cross or a checkmark.</span>
<br/>
<span>Example 26-6. checkuser.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'functions.php';</span>
<span>if (isset($_POST['user']))</span>
<span>{</span>
<span>$user = sanitizeString($_POST['user']);</span>
<span>$result = queryMysql("SELECT * FROM members WHERE user='$user'");</span>
<span>if ($result-&gt;num_rows)</span>
<span>&nbsp;</span>
<span>echo "&lt;span class='taken'&gt;&amp;nbsp;&amp;#x2718; " .</span>
<span>&nbsp;</span>
<span>"This username is taken&lt;/span&gt;";</span>
<span>else</span>
<span>&nbsp;</span>
<span>echo "&lt;span class='available'&gt;&amp;nbsp;&amp;#x2714; " .</span>
<span>&nbsp;</span>
<span>"This username is available&lt;/span&gt;";</span>
<span>}</span>
<span>?&gt;</span>
<h3>login.php</h3>
<span>With users now able to sign up to the site,</span>
<span>Example 26-7</span>
<span>,</span>
<span>login.php</span>
<span>, provides the code</span>
<span>needed to let them log in. Like the sign-up page, it features a simple HTML form and</span>
<span>some basic error checking, as well as using</span>
<span>sanitizeString</span>
<span>before querying the</span>
<span>MySQL database.</span>
<br/>
<span>The main thing to note here is that, upon successful verification of the username and</span>
<span>password, the session variables</span>
<span>user</span>
<span>and</span>
<span>pass</span>
<span>are given the username and password</span>
<span>values. As long as the current session remains active, these variables will be accessible</span>
<span>by all the programs in the project, allowing them to automatically provide access to</span>
<span>logged-in users.</span>
<br/>
<span>You may be interested in the use of the</span>
<span>die</span>
<span>function upon successfully logging in.</span>
<span>This is there because it combines an</span>
<span>echo</span>
<span>and an</span>
<span>exit</span>
<span>command in one, thus saving a</span>
<span>line of code. For styling, this (and most of the files) applies the class</span>
<span>main</span>
<span>to indent</span>
<span>the content from the left-hand edge.</span>
<br/>
<span>When you call this program up in your browser, it should look like</span>
<span>Figure 26-3</span>
<span>. Note</span>
<span>how the input type of</span>
<span>password</span>
<span>has been used here to mask the password with aster‐</span>
<span>isks to prevent it from being viewed by anyone looking over the user&rsquo;s shoulder.</span>
<br/>
<span>Example 26-7. login.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>echo "&lt;div class='main'&gt;&lt;h3&gt;Please enter your details to log in&lt;/h3&gt;";</span>
<span>$error = $user = $pass = "";</span>
<span>if (isset($_POST['user']))</span>
<span>{</span>
<span>$user = sanitizeString($_POST['user']);</span>
<span>$pass = sanitizeString($_POST['pass']);</span>
<span>if ($user == "" || $pass == "")</span>
<span>&nbsp;</span>
<span>$error = "Not all fields were entered&lt;br&gt;";</span>
<span>else</span>
<span>{</span>
<span>&nbsp;</span>
<span>$result = queryMySQL("SELECT user,pass FROM members</span>
<span>&nbsp;</span>
<span>WHERE user='$user' AND pass='$pass'");</span>
<span>&nbsp;</span>
<span>if ($result-&gt;num_rows == 0)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>$error = "&lt;span class='error'&gt;Username/Password</span>
<span>&nbsp;</span>
<span>invalid&lt;/span&gt;&lt;br&gt;&lt;br&gt;";</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>else</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>$_SESSION['user'] = $user;</span>
<span>&nbsp;</span>
<span>$_SESSION['pass'] = $pass;</span>
<span>&nbsp;</span>
<span>die("You are now logged in. Please &lt;a href='members.php?view=$user'&gt;" .</span>
<span>&nbsp;</span>
<span>"click here&lt;/a&gt; to continue.&lt;br&gt;&lt;br&gt;");</span>
<span>&nbsp;</span>
<span>}</span>
<span>}</span>
<span>}</span>
<span>echo &lt;&lt;&lt;_END</span>
<span>&lt;form method='post' action='login.php'&gt;$error</span>
<span>&lt;span class='fieldname'&gt;Username&lt;/span&gt;&lt;input type='text'</span>
<span>&nbsp;</span>
<span>maxlength='16' name='user' value='$user'&gt;&lt;br&gt;</span>
<span>&lt;span class='fieldname'&gt;Password&lt;/span&gt;&lt;input type='password'</span>
<span>&nbsp;</span>
<span>maxlength='16' name='pass' value='$pass'&gt;</span>
<span>_END;</span>
<span>?&gt;</span>
<span>&lt;br&gt;</span>
<span>&lt;span class='fieldname'&gt;&amp;nbsp;&lt;/span&gt;</span>
<span>&lt;input type='submit' value='Login'&gt;</span>
<span>&lt;/form&gt;&lt;br&gt;&lt;/div&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.3.png"/></p>
<span>Figure 26-3. The login page</span>
<br/>
<h3>profile.php</h3>
<span>One of the first things that new users may want to do after signing up and logging</span>
<span>in is to create a profile, which can be done via</span>
<span>Example 26-8</span>
<span>,</span>
<span>profile.php</span>
<span>. I think you&rsquo;ll</span>
<span>find some interesting code here, such as routines to upload, resize, and sharpen</span>
<span>images.</span>
<br/>
<span>Let&rsquo;s start by looking at the main HTML at the end of the code. This is like the forms</span>
<span>you&rsquo;ve just seen, but this time it has the parameter</span>
<span>enctype='multipart/form-data'</span>
<span>.</span>
<span>This allows us to send more than one type of data at a time, enabling the posting of</span>
<span>an image as well as some text. There&rsquo;s also an input type of</span>
<span>file</span>
<span>, which creates a</span>
<span>Browse button that a user can press to select a file to be uploaded.</span>
<br/>
<span>When the form is submitted, the code at the start of the program is executed. The</span>
<span>first thing it does is ensure that a user is logged in before allowing program execution</span>
<span>to proceed. Only then is the page heading displayed.</span>
<h4>Adding the &ldquo;About Me&rdquo; Text</h4>
<span>Then the Post variable</span>
<span>text</span>
<span>is checked to see whether some text was posted to the</span>
<span>program. If so, it is sanitized and all long whitespace sequences (including returns</span>
<span>and line feeds) are replaced with a single space. This function incorporates a double</span>
<span>security check, ensuring that the user actually exists in the database and that no</span>
<span>attempted hacking can succeed before inserting this text into the database, where it</span>
<span>will become the user&rsquo;s &ldquo;about me&rdquo; details.</span>
<br/>
<span>If no text was posted, the database is queried to see whether any text already exists in</span>
<span>order to prepopulate the</span>
<span>textarea</span>
<span>for the user to edit it.</span>
<h4>Adding a</h4>
<h4>Profile Image</h4>
<span>Next we move on to the section where the</span>
<span>$_FILES</span>
<span>system variable is checked to see</span>
<span>whether an image has been uploaded. If so, a string variable called</span>
<span>$saveto</span>
<span>is created,</span>
<span>based on the user&rsquo;s username followed by the extension</span>
<span>.jpg</span>
<span>. For example, user Jill will</span>
<span>cause</span>
<span>$saveto</span>
<span>to have the value</span>
<span>Jill.jpg</span>
<span>. This is the file where the uploaded image will</span>
<span>be saved for use in the user&rsquo;s profile.</span>
<br/>
<span>Following this, the uploaded image type is examined and is accepted only if it is a</span>
<span>jpeg</span>
<span>,</span>
<span>png</span>
<span>, or</span>
<span>gif</span>
<span>image. Upon success, the variable</span>
<span>$src</span>
<span>is populated with the uploaded</span>
<span>image using one of the</span>
<span>imagecreatefrom</span>
<span>functions according to the image type</span>
<span>uploaded. The image is now in a raw format that PHP can process. If the image is not</span>
<span>of an allowed type, the flag</span>
<span>$typeok</span>
<span>is set to</span>
<span>FALSE</span>
<span>, preventing the final section of</span>
<span>image upload code from being processed.</span>
<h4>Processing the Image</h4>
<span>First, we store the image&rsquo;s dimensions in</span>
<span>$w</span>
<span>and</span>
<span>$h</span>
<span>using the following statement,</span>
<span>which is a quick way of assigning values from an array to separate variables:</span>
<br/>
<span>list($w, $h) = getimagesize($saveto);</span>
<br/>
<span>Then, using the value of</span>
<span>$max</span>
<span>(which is set to</span>
<span>100</span>
<span>), we calculate new dimensions that</span>
<span>will result in a new image of the same ratio, but with no dimension greater than 100</span>
<span>pixels. This results in giving the variables</span>
<span>$tw</span>
<span>and</span>
<span>$th</span>
<span>the new values needed. If you</span>
<span>want smaller or larger thumbnails, simply change the value of</span>
<span>$max</span>
<span>accordingly.</span>
<br/>
<span>Next, the function</span>
<span>imagecreatetruecolor</span>
<span>is called to create a new, blank canvas</span>
<span>$tw</span>
<span>wide and</span>
<span>$th</span>
<span>high in</span>
<span>$tmp</span>
<span>. Then</span>
<span>imagecopyresampled</span>
<span>is called to resample the image</span>
<span>from</span>
<span>$src</span>
<span>, to the new</span>
<span>$tmp</span>
<span>. Sometimes resampling images can result in a slightly</span>
<span>blurred copy, so the next piece of code uses the</span>
<span>imageconvolution</span>
<span>function to</span>
<span>sharpen the image up a bit.</span>
<br/>
<span>Finally, the image is saved as a</span>
<span>&nbsp;jpeg</span>
<span>&nbsp;file in the location defined by the variable</span>
<span>$saveto</span>
<span>, after which we remove both the original and the resized image canvases</span>
<span>from memory using the</span>
<span>imagedestroy</span>
<span>function, returning the memory that was</span>
<span>used.</span>
<h4>Displaying the Current</h4>
<h4>Profile</h4>
<span>Last but not least, so that the user can see what the current profile looks like before</span>
<span>editing it, the</span>
<span>showProfile</span>
<span>function from</span>
<span>functions.php</span>
<span>is called prior to outputting</span>
<span>the form HTML. If no profile exists yet, nothing will be displayed.</span>
<br/>
<span>When a profile image is displayed, CSS is applied to it to provide a border, shadow,</span>
<span>and a margin to its right&mdash;to separate the profile text from the image. The result of</span>
<span>loading</span>
<span>Example 26-8</span>
<span>into a browser is shown in</span>
<span>Figure 26-4</span>
<span>, where you can see that</span>
<span>the</span>
<span>textarea</span>
<span>has been prepopulated with the &ldquo;about me&rdquo; text.</span>
<br/>
<span>Example 26-8.</span>
<span>profile.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>if (!$loggedin) die();</span>
<span>echo "&lt;div class='main'&gt;&lt;h3&gt;Your Profile&lt;/h3&gt;";</span>
<span>$result = queryMysql("SELECT * FROM profiles WHERE user='$user'");</span>
<span>if (isset($_POST['text']))</span>
<span>{</span>
<span>$text = sanitizeString($_POST['text']);</span>
<span>$text = preg_replace('/\s\s+/', ' ', $text);</span>
<span>if ($result-&gt;num_rows)</span>
<span>&nbsp;</span>
<span>queryMysql("UPDATE profiles SET text='$text' where user='$user'");</span>
<span>else queryMysql("INSERT INTO profiles VALUES('$user', '$text')");</span>
<span>}</span>
<span>else</span>
<span>{</span>
<span>if ($result-&gt;num_rows)</span>
<span>{</span>
<span>&nbsp;</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>&nbsp;</span>
<span>$text = stripslashes($row['text']);</span>
<span>}</span>
<span>else $text = "";</span>
<span>}</span>
<span>$text = stripslashes(preg_replace('/\s\s+/', ' ', $text));</span>
<span>if (isset($_FILES['image']['name']))</span>
<span>{</span>
<span>$saveto = "$user.jpg";</span>
<span>move_uploaded_file($_FILES['image']['tmp_name'], $saveto);</span>
<span>$typeok = TRUE;</span>
<span>switch($_FILES['image']['type'])</span>
<span>{</span>
<span>&nbsp;</span>
<span>case "image/gif": $src = imagecreatefromgif($saveto); break;</span>
<span>&nbsp;</span>
<span>case "image/jpeg": // Both regular and progressive jpegs</span>
<span>&nbsp;</span>
<span>case "image/pjpeg": $src = imagecreatefromjpeg($saveto); break;</span>
<span>&nbsp;</span>
<span>case "image/png": $src = imagecreatefrompng($saveto); break;</span>
<span>&nbsp;</span>
<span>default: $typeok = FALSE; break;</span>
<span>}</span>
<span>if ($typeok)</span>
<span>{</span>
<span>&nbsp;</span>
<span>list($w, $h) = getimagesize($saveto);</span>
<span>&nbsp;</span>
<span>$max = 100;</span>
<span>&nbsp;</span>
<span>$tw = $w;</span>
<span>&nbsp;</span>
<span>$th = $h;</span>
<span>&nbsp;</span>
<span>if ($w &gt; $h &amp;&amp; $max &lt; $w)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>$th = $max / $w * $h;</span>
<span>&nbsp;</span>
<span>$tw = $max;</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>elseif ($h &gt; $w &amp;&amp; $max &lt; $h)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>$tw = $max / $h * $w;</span>
<span>&nbsp;</span>
<span>$th = $max;</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>elseif ($max &lt; $w)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>$tw = $th = $max;</span>
<span>&nbsp;</span>
<span>}</span>
<span>&nbsp;</span>
<span>$tmp = imagecreatetruecolor($tw, $th);</span>
<span>&nbsp;</span>
<span>imagecopyresampled($tmp, $src, 0, 0, 0, 0, $tw, $th, $w, $h);</span>
<span>&nbsp;</span>
<span>imageconvolution($tmp, array(array(-1, -1, -1),</span>
<span>&nbsp;</span>
<span>array(-1, 16, -1), array(-1, -1, -1)), 8, 0);</span>
<span>&nbsp;</span>
<span>imagejpeg($tmp, $saveto);</span>
<span>&nbsp;</span>
<span>imagedestroy($tmp);</span>
<span>&nbsp;</span>
<span>imagedestroy($src);</span>
<span>}</span>
<span>}</span>
<span>showProfile($user);</span>
<span>echo &lt;&lt;&lt;_END</span>
<span>&lt;form method='post' action='profile.php' enctype='multipart/form-data'&gt;</span>
<span>&lt;h3&gt;Enter or edit your details and/or upload an image&lt;/h3&gt;</span>
<span>&lt;textarea name='text' cols='50' rows='3'&gt;$text&lt;/textarea&gt;&lt;br&gt;</span>
<span>_END;</span>
<span>?&gt;</span>
<span>Image: &lt;input type='file' name='image' size='14'&gt;</span>
<span>&lt;input type='submit' value='Save Profile'&gt;</span>
<span>&lt;/form&gt;&lt;/div&gt;&lt;br&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.4.png"/></p>
<span>Figure 26-4. Editing a user profile</span>
<br/>
<h3>members.php</h3>
<span>Using</span>
<span>Example 26-9</span>
<span>,</span>
<span>members.php</span>
<span>, your users will be able to find other members</span>
<span>and choose to add them as friends (or drop them if they are already friends). This</span>
<span>program has two modes. The first lists all members and their relationships to you,</span>
<span>and the second shows a user&rsquo;s profile.</span>
<h4>Viewing a User&rsquo;s</h4>
<h4>Profile</h4>
<span>The code for the latter mode comes first, where a test is made for the Get variable</span>
<span>view</span>
<span>. If it exists, a user wants to view someone&rsquo;s profile, so the program does that</span>
<span>using the</span>
<span>showProfile</span>
<span>function, along with providing a couple of links to the user&rsquo;s</span>
<span>friends and messages.</span>
<h4>Adding and Dropping Friends</h4>
<span>After that, the two Get variables,</span>
<span>add</span>
<span>and</span>
<span>remove</span>
<span>, are tested. If one or the other has a</span>
<span>value, it will be the username of a user to either add or drop as a friend. We achieve</span>
<span>this by looking up the user in the MySQL</span>
<span>friends</span>
<span>table and either inserting a friend</span>
<span>username or removing it from the table.</span>
<br/>
<span>And, of course, every posted variable is first passed through</span>
<span>sanitizeString</span>
<span>to</span>
<span>ensure that it is safe to use with MySQL.</span>
<h4>Listing All Members</h4>
<span>The final section of code issues a SQL query to list all usernames. The code places the</span>
<span>number returned in the variable</span>
<span>$num</span>
<span>before outputting the page heading.</span>
<br/>
<span>A</span>
<span>for</span>
<span>loop then iterates through each and every member, fetching their details and</span>
<span>then looking them up in the</span>
<span>friends</span>
<span>table to see if they are either being followed by</span>
<span>or a follower of the user. If someone is both a follower and a followee, she is classed as</span>
<span>a mutual friend.</span>
<br/>
<span>The variable</span>
<span>$t1</span>
<span>is nonzero when the user is following another member, and</span>
<span>$t2</span>
<span>is</span>
<span>nonzero when another member is following the user. Depending on these values, text</span>
<span>is displayed after each username, showing the relationship (if any) to the current user.</span>
<br/>
<span>Icons are also displayed to show the relationships. A double pointing arrow means</span>
<span>that the users are mutual friends. A left-pointing arrow indicates the user is following</span>
<span>another member. And a right-pointing arrow indicates that another member is fol‐</span>
<span>lowing the user.</span>
<br/>
<span>Finally, depending on whether the user is following another member, a link is pro‐</span>
<span>vided to either add or drop that member as a friend.</span>
<span>When you call</span>
<span>Example 26-9</span>
<span>up in a browser, it will look like</span>
<span>Figure 26-5</span>
<span>. See how</span>
<span>the user is invited to &ldquo;follow&rdquo; a nonfollowing member, but if the member is already</span>
<span>following the user, a &ldquo;recip&rdquo; link to reciprocate the friendship is offered. In the case of</span>
<span>a user already following another member, the user can select &ldquo;drop&rdquo; to end the follow‐</span>
<span>ing.</span>
<br/>
<span>Example 26-9. members.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>if (!$loggedin) die();</span>
<span>echo "&lt;div class='main'&gt;";</span>
<span>if (isset($_GET['view']))</span>
<span>{</span>
<span>$view = sanitizeString($_GET['view']);</span>
<span>if ($view == $user) $name = "Your";</span>
<span>else $name = "$view's";</span>
<span>echo "&lt;h3&gt;$name Profile&lt;/h3&gt;";</span>
<span>showProfile($view);</span>
<span>echo "&lt;a class='button' href='messages.php?view=$view'&gt;" .</span>
<span>&nbsp;</span>
<span>"View $name messages&lt;/a&gt;&lt;br&gt;&lt;br&gt;";</span>
<span>die("&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;");</span>
<span>}</span>
<span>if (isset($_GET['add']))</span>
<span>{</span>
<span>$add = sanitizeString($_GET['add']);</span>
<span>$result = queryMysql("SELECT * FROM friends WHERE user='$add'</span>
<span>&nbsp;</span>
<span>AND friend='$user'");</span>
<span>if (!$result-&gt;num_rows)</span>
<span>&nbsp;</span>
<span>queryMysql("INSERT INTO friends VALUES ('$add', '$user')");</span>
<span>}</span>
<span>elseif (isset($_GET['remove']))</span>
<span>{</span>
<span>$remove = sanitizeString($_GET['remove']);</span>
<span>queryMysql("DELETE FROM friends WHERE user='$remove' AND friend='$user'");</span>
<span>}</span>
<span>$result = queryMysql("SELECT user FROM members ORDER BY user");</span>
<span>$num = $result-&gt;num_rows;</span>
<span>echo "&lt;h3&gt;Other Members&lt;/h3&gt;&lt;ul&gt;";</span>
<span>for ($j = 0 ; $j &lt; $num ; ++$j)</span>
<span>{</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>if ($row['user'] == $user) continue;</span>
<span>echo "&lt;li&gt;&lt;a href='members.php?view=" .</span>
<span>&nbsp;</span>
<span>$row['user'] . "'&gt;" . $row['user'] . "&lt;/a&gt;";</span>
<span>$follow = "follow";</span>
<span>$result1 = queryMysql("SELECT * FROM friends WHERE</span>
<span>&nbsp;</span>
<span>user='" . $row['user'] . "' AND friend='$user'");</span>
<span>$t1 = $result1-&gt;num_rows;</span>
<span>$result1 = queryMysql("SELECT * FROM friends WHERE</span>
<span>&nbsp;</span>
<span>user='$user' AND friend='" . $row['user'] . "'");</span>
<span>$t2 = $result1-&gt;num_rows;</span>
<span>if (($t1 + $t2) &gt; 1) echo " &amp;harr; is a mutual friend";</span>
<span>elseif ($t1) echo " &amp;larr; you are following";</span>
<span>elseif ($t2) { echo " &amp;rarr; is following you";</span>
<span>&nbsp;</span>
<span>$follow = "recip"; }</span>
<span>if (!$t1) echo " [&lt;a href='members.php?add=" .</span>
<span>&nbsp;</span>
<span>$row['user'] . "'&gt;$follow&lt;/a&gt;]";</span>
<span>else echo " [&lt;a href='members.php?remove=" .</span>
<span>&nbsp;</span>
<span>$row['user'] . "'&gt;drop&lt;/a&gt;]";</span>
<span>}</span>
<span>?&gt;</span>
<span>&lt;/ul&gt;&lt;/div&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.5.png"/></p>
<span>Figure 26-5. Using the members module</span>
<br/>
<span>On a production server, there could be thousands or even hun‐</span>
<span>dreds of thousands of users, so you would probably substantially</span>
<span>modify this program to include searching the &ldquo;about me&rdquo; text, sup‐</span>
<span>port paging of the output a screen at a time, and so on.</span>
<h3>friends.php</h3>
<span>The module that shows a user&rsquo;s friends and followers is</span>
<span>Example 26-10</span>
<span>,</span>
<span>friends.php</span>
<span>.</span>
<span>This interrogates the</span>
<span>friends</span>
<span>table just like the</span>
<span>members.php</span>
<span>program, but only for a</span>
<span>single user. It then shows all of that user&rsquo;s mutual friends and followers along with the</span>
<span>people he is following.</span>
<br/>
<span>All the followers are saved into an array called</span>
<span>$followers</span>
<span>, and all the people being</span>
<span>followed are placed in an array called</span>
<span>$following</span>
<span>. Then a neat piece of code is used</span>
<span>to extract all those who are both following and followed by the user, like this:</span>
<br/>
<span>$mutual = array_intersect($followers, $following);</span>
<br/>
<span>The</span>
<span>array_intersect</span>
<span>function extracts all members common to both arrays and</span>
<span>returns a new array containing only those people. This array is then stored in</span>
<span>$mutual</span>
<span>. Now it&rsquo;s possible to use the</span>
<span>array_diff</span>
<span>function for each of the</span>
<span>$followers</span>
<span>and</span>
<span>$following</span>
<span>arrays to keep only those people who are</span>
<span>&nbsp;not</span>
<span>&nbsp;mutual friends, like</span>
<span>this:</span>
<br/>
<span>$followers = array_diff($followers, $mutual);</span>
<span>$following = array_diff($following, $mutual);</span>
<br/>
<span>This results in the array</span>
<span>$mutual</span>
<span>containing only mutual friends,</span>
<span>$followers</span>
<span>con‐</span>
<span>taining only followers (and no mutual friends), and</span>
<span>$following</span>
<span>containing only peo‐</span>
<span>ple being followed (and no mutual friends).</span>
<br/>
<span>Now that we&rsquo;re armed with these arrays, it&rsquo;s a simple matter to separately display each</span>
<span>category of members, as can be seen in</span>
<span>&nbsp;Figure 26-6</span>
<span>. The PHP</span>
<span>sizeof</span>
<span>function</span>
<span>returns the number of elements in an array; here I use it just to trigger code when the</span>
<span>size is nonzero (that is, friends of that type exist). Note how, by using the variables</span>
<span>$name1</span>
<span>,</span>
<span>$name2</span>
<span>, and</span>
<span>$name3</span>
<span>in the relevant places, the code can tell when you&rsquo;re look‐</span>
<span>ing at your own friends list, using the words</span>
<span>Your</span>
<span>and</span>
<span>You are</span>
<span>, instead of simply dis‐</span>
<span>playing the username. The commented line can be uncommented if you wish to</span>
<span>display the user&rsquo;s profile information on this screen.</span>
<br/>
<span>Example 26-10. friends.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>if (!$loggedin) die();</span>
<span>if (isset($_GET['view'])) $view = sanitizeString($_GET['view']);</span>
<span>else $view = $user;</span>
<span>if ($view == $user)</span>
<span>{</span>
<span>$name1 = $name2 = "Your";</span>
<span>$name3 = "You are";</span>
<span>}</span>
<span>else</span>
<span>{</span>
<span>$name1 = "&lt;a href='members.php?view=$view'&gt;$view&lt;/a&gt;'s";</span>
<span>$name2 = "$view's";</span>
<span>$name3 = "$view is";</span>
<span>}</span>
<span>echo "&lt;div class='main'&gt;";</span>
<span>// Uncomment this line if you wish the user's profile to show here</span>
<span>// showProfile($view);</span>
<span>$followers = array();</span>
<span>$following = array();</span>
<span>$result = queryMysql("SELECT * FROM friends WHERE user='$view'");</span>
<span>$num = $result-&gt;num_rows;</span>
<span>for ($j = 0 ; $j &lt; $num ; ++$j)</span>
<span>{</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>$followers[$j] = $row['friend'];</span>
<span>}</span>
<span>$result = queryMysql("SELECT * FROM friends WHERE friend='$view'");</span>
<span>$num = $result-&gt;num_rows;</span>
<span>for ($j = 0 ; $j &lt; $num ; ++$j)</span>
<span>{</span>
<span>&nbsp;</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>&nbsp;</span>
<span>$following[$j] = $row['user'];</span>
<span>}</span>
<span>$mutual = array_intersect($followers, $following);</span>
<span>$followers = array_diff($followers, $mutual);</span>
<span>$following = array_diff($following, $mutual);</span>
<span>$friends = FALSE;</span>
<span>if (sizeof($mutual))</span>
<span>{</span>
<span>echo "&lt;span class='subhead'&gt;$name2 mutual friends&lt;/span&gt;&lt;ul&gt;";</span>
<span>foreach($mutual as $friend)</span>
<span>&nbsp;</span>
<span>echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";</span>
<span>echo "&lt;/ul&gt;";</span>
<span>$friends = TRUE;</span>
<span>}</span>
<span>if (sizeof($followers))</span>
<span>{</span>
<span>echo "&lt;span class='subhead'&gt;$name2 followers&lt;/span&gt;&lt;ul&gt;";</span>
<span>foreach($followers as $friend)</span>
<span>&nbsp;</span>
<span>echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";</span>
<span>echo "&lt;/ul&gt;";</span>
<span>$friends = TRUE;</span>
<span>}</span>
<span>if (sizeof($following))</span>
<span>{</span>
<span>echo "&lt;span class='subhead'&gt;$name3 following&lt;/span&gt;&lt;ul&gt;";</span>
<span>foreach($following as $friend)</span>
<span>&nbsp;</span>
<span>echo "&lt;li&gt;&lt;a href='members.php?view=$friend'&gt;$friend&lt;/a&gt;";</span>
<span>echo "&lt;/ul&gt;";</span>
<span>$friends = TRUE;</span>
<span>}</span>
<span>if (!$friends) echo "&lt;br&gt;You don't have any friends yet.&lt;br&gt;&lt;br&gt;";</span>
<span>echo "&lt;a class='button' href='messages.php?view=$view'&gt;" .</span>
<span>&nbsp;</span>
<span>"View $name2 messages&lt;/a&gt;";</span>
<span>?&gt;</span>
<span>&lt;/div&gt;&lt;br&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.6.png"/></p>
<span>Figure 26-6. Displaying a user&rsquo;s friends and followers</span>
<br/>
<h3>messages.php</h3>
<span>The last of the main modules is</span>
<span>Example 26-11</span>
<span>,</span>
<span>messages.php</span>
<span>. The program starts by</span>
<span>checking whether a message has been posted in variable</span>
<span>text</span>
<span>. If so, it is inserted into</span>
<span>the</span>
<span>messages</span>
<span>table. At the same time, the value of</span>
<span>pm</span>
<span>is also stored. This indicates</span>
<span>whether a message is private or public. A</span>
<span>0</span>
<span>represents a public message, and</span>
<span>1</span>
<span>is pri‐</span>
<span>vate.</span>
<br/>
<span>Next, the user&rsquo;s profile and a form for entering a message are displayed, along with</span>
<span>radio buttons to choose between a private or public message. After this, all the mes‐</span>
<span>sages are shown, depending on whether they are private or public. If they are public,</span>
<span>all users can see them, but private messages are visible only to the sender and recipi‐</span>
<span>ent. This is all handled by a couple of queries to the MySQL database. Additionally,</span>
<span>when a message is private, it is introduced by the word</span>
<span>whispered</span>
<span>and shown in italic.</span>
<br/>
<span>Finally, the program displays a couple of links to refresh the messages (in case</span>
<span>another user has posted one in the meantime) and to view the user&rsquo;s friends. The trick</span>
<span>using the variables</span>
<span>$name1</span>
<span>and</span>
<span>$name2</span>
<span>is again used so that when you view your own</span>
<span>profile, the word</span>
<span>Your</span>
<span>is displayed instead of the username.</span>
<br/>
<span>You can see the result of viewing this program with a browser in</span>
<span>Figure 26-7</span>
<span>. Note</span>
<span>how users viewing their own messages are provided with links to erase any they don&rsquo;t</span>
<span>want.</span>
<br/>
<span>Example 26-11. messages.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>if (!$loggedin) die();</span>
<span>if (isset($_GET['view'])) $view = sanitizeString($_GET['view']);</span>
<span>else $view = $user;</span>
<span>if (isset($_POST['text']))</span>
<span>{</span>
<span>$text = sanitizeString($_POST['text']);</span>
<span>if ($text != "")</span>
<span>{</span>
<span>&nbsp;</span>
<span>$pm = substr(sanitizeString($_POST['pm']),0,1);</span>
<span>&nbsp;</span>
<span>$time = time();</span>
<span>&nbsp;</span>
<span>queryMysql("INSERT INTO messages VALUES(NULL, '$user',</span>
<span>&nbsp;</span>
<span>'$view', '$pm', $time, '$text')");</span>
<span>}</span>
<span>}</span>
<span>if ($view != "")</span>
<span>{</span>
<span>if ($view == $user) $name1 = $name2 = "Your";</span>
<span>else</span>
<span>{</span>
<span>&nbsp;</span>
<span>$name1 = "&lt;a href='members.php?view=$view'&gt;$view&lt;/a&gt;'s";</span>
<span>&nbsp;</span>
<span>$name2 = "$view's";</span>
<span>}</span>
<span>echo "&lt;div class='main'&gt;&lt;h3&gt;$name1 Messages&lt;/h3&gt;";</span>
<span>showProfile($view);</span>
<span>echo &lt;&lt;&lt;_END</span>
<span>&nbsp;</span>
<span>&lt;form method='post' action='messages.php?view=$view'&gt;</span>
<span>&nbsp;</span>
<span>Type here to leave a message:&lt;br&gt;</span>
<span>&nbsp;</span>
<span>&lt;textarea name='text' cols='40' rows='3'&gt;&lt;/textarea&gt;&lt;br&gt;</span>
<span>&nbsp;</span>
<span>Public&lt;input type='radio' name='pm' value='0' checked='checked'&gt;</span>
<span>&nbsp;</span>
<span>Private&lt;input type='radio' name='pm' value='1'&gt;</span>
<span>&nbsp;</span>
<span>&lt;input type='submit' value='Post Message'&gt;&lt;/form&gt;&lt;br&gt;</span>
<span>_END;</span>
<span>if (isset($_GET['erase']))</span>
<span>{</span>
<span>&nbsp;</span>
<span>$erase = sanitizeString($_GET['erase']);</span>
<span>&nbsp;</span>
<span>queryMysql("DELETE FROM messages WHERE id=$erase AND recip='$user'");</span>
<span>}</span>
<span>$query = "SELECT * FROM messages WHERE recip='$view' ORDER BY time DESC";</span>
<span>$result = queryMysql($query);</span>
<span>$num = $result-&gt;num_rows;</span>
<span>for ($j = 0 ; $j &lt; $num ; ++$j)</span>
<span>{</span>
<span>&nbsp;</span>
<span>$row = $result-&gt;fetch_array(MYSQLI_ASSOC);</span>
<span>&nbsp;</span>
<span>if ($row['pm'] == 0 || $row['auth'] == $user || $row['recip'] == $user)</span>
<span>&nbsp;</span>
<span>{</span>
<span>&nbsp;</span>
<span>echo date('M jS \'y g:ia:', $row['time']);</span>
<span>&nbsp;</span>
<span>echo " &lt;a href='messages.php?view=" . $row['auth'] . "'&gt;" .</span>
<span>&nbsp;</span>
<span>$row['auth']. "&lt;/a&gt; ";</span>
<span>&nbsp;</span>
<span>if ($row['pm'] == 0)</span>
<span>&nbsp;</span>
<span>echo "wrote: &amp;quot;" . $row['message'] . "&amp;quot; ";</span>
<span>&nbsp;</span>
<span>else</span>
<span>&nbsp;</span>
<span>echo "whispered: &lt;span class='whisper'&gt;&amp;quot;" .</span>
<span>&nbsp;</span>
<span>$row['message'] . "&amp;quot;&lt;/span&gt; ";</span>
<span>&nbsp;</span>
<span>if ($row['recip'] == $user)</span>
<span>&nbsp;</span>
<span>echo "[&lt;a href='messages.php?view=$view" .</span>
<span>&nbsp;</span>
<span>"&amp;erase=" . $row['id'] . "'&gt;erase&lt;/a&gt;]";</span>
<span>&nbsp;</span>
<span>echo "&lt;br&gt;";</span>
<span>&nbsp;</span>
<span>}</span>
<span>}</span>
<span>}</span>
<span>if (!$num) echo "&lt;br&gt;&lt;span class='info'&gt;No messages yet&lt;/span&gt;&lt;br&gt;&lt;br&gt;";</span>
<span>echo "&lt;br&gt;&lt;a class='button' href='messages.php?view=$view'&gt;Refresh messages&lt;/a&gt;";</span>
<span>?&gt;</span>
<span>&lt;/div&gt;&lt;br&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.7.png"/></p>
<span>Figure 26-7. The messaging module</span>
<br/>
<h3>logout.php</h3>
<span>The final ingredient in our social networking recipe is</span>
<span>Example 26-12</span>
<span>,</span>
<span>logout.php</span>
<span>, the</span>
<span>logout page that closes a session and deletes any associated data and cookies. The</span>
<span>result of calling up this program is shown in</span>
<span>Figure 26-8</span>
<span>, where the user is now asked</span>
<span>to click a link that will take her to the un-logged-in home page and remove the</span>
<span>logged-in links from the top of the screen. Of course, you could write a JavaScript or</span>
<span>PHP redirect to do this (probably a good idea if you wish to keep logout looking</span>
<span>clean).</span>
<br/>
<span>Example 26-12. logout.php</span>
<br/>
<span>&lt;?php</span>
<span>require_once 'header.php';</span>
<span>if (isset($_SESSION['user']))</span>
<span>{</span>
<span>destroySession();</span>
<span>echo "&lt;div class='main'&gt;You have been logged out. Please " .</span>
<span>&nbsp;</span>
<span>"&lt;a href='index.php'&gt;click here&lt;/a&gt; to refresh the screen.";</span>
<span>}</span>
<span>else echo "&lt;div class='main'&gt;&lt;br&gt;" .</span>
<span>&nbsp;</span>
<span>"You cannot log out because you are not logged in";</span>
<span>?&gt;</span>
<span>&lt;br&gt;&lt;br&gt;&lt;/div&gt;</span>
<span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
<br/>
<p><img src="images/26.8.png"/></p>
<span>Figure 26-8. The logout page</span>
<br/>
<h3>styles.css</h3>
<span>The style sheet used for this project is shown in</span>
<span>Example 26-13</span>
<span>. There are a number</span>
<span>of sets of declarations, as follows:</span>
<br/>
<span>*</span>
<span>Sets the default font family and size for the project using the universal selector.</span>
<br/>
<span>body</span>
<span>Sets the width of the project window, centers it horizontally, specifies a background</span>
<span>color, and gives it a border.</span>
<br/>
<span>html</span>
<span>Sets the background color of the HTML section.</span>
<br/>
<span>img</span>
<span>Gives all images a border, shadow, and a righthand margin.</span>
<br/>
<span>li a</span>
<span>and</span>
<span>.button</span>
<span>Remove underlines from hyperlinks in all</span>
<span>&lt;a&gt;</span>
<span>tags that are within a</span>
<span>&lt;li&gt;</span>
<span>element,</span>
<span>and all elements employing the</span>
<span>button</span>
<span>class.</span>
<br/>
<span>li a:hover</span>
<span>and</span>
<span>.button:hover</span>
<span>Sets the color in which</span>
<span>&lt;li&gt;</span>
<span>elements and the</span>
<span>button</span>
<span>class should display text when</span>
<span>hovered over.</span>
<br/>
<span>.appname</span>
<span>Sets the properties for the heading (which uses the</span>
<span>appname</span>
<span>class), including center‐</span>
<span>ing, background and text colors, the font family and size, and the padding.</span>
<br/>
<span>.fieldname</span>
<span>Sets the width of elements using the</span>
<span>fieldname</span>
<span>class by first floating them.</span>
<br/>
<span>.main</span>
<span>This class applies an indent to elements that use it.</span>
<br/>
<span>.info</span>
<span>This class is used for displaying important information. It sets a background and</span>
<span>foreground text color, applies a border and padding, and indents elements that</span>
<span>employ it.</span>
<br/>
<span>.menu li</span>
<span>and</span>
<span>.button</span>
<span>These declarations ensure that all</span>
<span>&lt;li&gt;</span>
<span>elements and the</span>
<span>button</span>
<span>class display inline,</span>
<span>have padding applied, and include a border, a background and foreground text color,</span>
<span>a right margin, rounded borders, and a shadow&mdash;resulting in a button effect.</span>
<br/>
<span>.subhead</span>
<span>Emphasizes sections of text.</span>
<br/>
<span>.taken</span>
<span>,</span>
<span>.available</span>
<span>,</span>
<span>.error</span>
<span>, and</span>
<span>.whisper</span>
<span>These declarations set the colors and font styles to be used for displaying different</span>
<span>types of information.</span>
<br/>
<span>#logo</span>
<span>These rules style the logo text as a fallback in case a non-HTML5 browser is in use</span>
<span>and the canvas logo doesn&rsquo;t get created.</span>
<br/>
<span>Example 26-13. styles.css</span>
<br/>
<span>* {</span>
<span>font-family:verdana,sans-serif;</span>
<span>font-size :14pt;</span>
<span>}</span>
<span>body {</span>
<span>width :700px;</span>
<span>margin :20px auto;</span>
<span>background:#f8f8f8;</span>
<span>border :1px solid #888;</span>
<span>}</span>
<span>html {</span>
<span>background:#fff</span>
<span>}</span>
<span>img {</span>
<span>border :1px solid black;</span>
<span>margin-right :15px;</span>
<span>-moz-box-shadow :2px 2px 2px #888;</span>
<span>-webkit-box-shadow:2px 2px 2px #888;</span>
<span>box-shadow :2px 2px 2px #888;</span>
<span>}</span>
<span>li a, .button {</span>
<span>text-decoration:none;</span>
<span>}</span>
<span>li a:hover, .button:hover {</span>
<span>color:green;</span>
<span>}</span>
<span>.appname {</span>
<span>text-align :center;</span>
<span>background :#eb8;</span>
<span>color :#40d;</span>
<span>font-family:helvetica;</span>
<span>font-size :20pt;</span>
<span>padding :4px;</span>
<span>}</span>
<span>.fieldname {</span>
<span>float:left;</span>
<span>width:120px;</span>
<span>}</span>
<span>.main {</span>
<span>margin-left:40px;</span>
<span>}</span>
<span>.info {</span>
<span>background :lightgreen;</span>
<span>color :blue;</span>
<span>border :1px solid green;</span>
<span>padding :5px 10px;</span>
<span>margin-left:40px;</span>
<span>}</span>
<span>.menu li, .button {</span>
<span>display :inline;</span>
<span>padding :4px 6px;</span>
<span>border :1px solid #777;</span>
<span>background :#ddd;</span>
<span>color :#d04;</span>
<span>margin-right :8px;</span>
<span>border-radius :5px;</span>
<span>-moz-box-shadow :2px 2px 2px #888;</span>
<span>-webkit-box-shadow:2px 2px 2px #888;</span>
<span>box-shadow :2px 2px 2px #888;</span>
<span>}</span>
<span>.subhead {</span>
<span>font-weight:bold;</span>
<span>}</span>
<span>.taken, .error {</span>
<span>color:red;</span>
<span>}</span>
<span>.available {</span>
<span>color:green;</span>
<span>}</span>
<span>.whisper {</span>
<span>font-style:italic;</span>
<span>color :#006600;</span>
<span>}</span>
<span>#logo {</span>
<span>font-family:Georgia;</span>
<span>font-weight:bold;</span>
<span>font-style :italic;</span>
<span>font-size :97px;</span>
<span>}</span>
<h3>javascript.js</h3>
<span>Finally, there&rsquo;s the JavaScript file (see</span>
<span>Example 26-14</span>
<span>), which contains the</span>
<span>O</span>
<span>,</span>
<span>S</span>
<span>, and</span>
<span>C</span>
<span>functions used throughout this book, along with some code to draw the logo for the</span>
<span>site using an HTML5 canvas, as explained in</span>
<span>Chapter 23</span>
<span>.</span>
<br/>
<span>Example 26-14. javascript.js</span>
<br/>
<span>canvas = O('logo')</span>
<span>context = canvas.getContext('2d')</span>
<span>context.font = 'bold italic 97px Georgia'</span>
<span>context.textBaseline = 'top'</span>
<span>image = new Image()</span>
<span>image.src = 'robin.gif'</span>
<span>image.onload = function()</span>
<span>{</span>
<span>gradient = context.createLinearGradient(0, 0, 0, 89)</span>
<span>gradient.addColorStop(0.00, '#faa')</span>
<span>gradient.addColorStop(0.66, '#f00')</span>
<span>context.fillStyle = gradient</span>
<span>context.fillText( "R bin's Nest", 0, 0)</span>
<span>context.strokeText("R bin's Nest", 0, 0)</span>
<span>context.drawImage(image, 64, 32)</span>
<span>}</span>
<span>function O(obj)</span>
<span>{</span>
<span>if (typeof obj == 'object') return obj</span>
<span>else return document.getElementById(obj)</span>
<span>}</span>
<span>function S(obj)</span>
<span>{</span>
<span>return O(obj).style</span>
<span>}</span>
<span>function C(name)</span>
<span>{</span>
<span>var elements = document.getElementsByTagName('*')</span>
<span>var objects = []</span>
<span>for (var i = 0 ; i &lt; elements.length ; ++i)</span>
<span>if (elements[i].className == name)</span>
<span>&nbsp;</span>
<span>objects.push(elements[i])</span>
<span>return objects</span>
<span>}</span>
<br/>
<span>And that, as they say, is that. If you write anything based on this code or any other</span>
<span>examples in this book, or have gained in any other way from it, then I am glad to have</span>
<span>been of help and thank you for reading this book.</span>
<br/>
<span>But before you go and try out your newly learned skills on the Web at large, please</span>
<span>browse through the appendixes that follow, as there&rsquo;s a lot of additional information</span>
<span>there you should find useful.</span>