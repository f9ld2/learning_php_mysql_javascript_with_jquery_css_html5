---
layout: default
---

   <h1>Filesystem Security</h1>
<h2>Table of Contents</h2><ul class="chunklist chunklist_chapter"><li><a href="security.filesystem.nullbytes.html">Null bytes related issues</a></li></ul>

   <p class="simpara">
    <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> is subject to the security built into most server systems with
    respect to permissions on a file and directory basis. This allows
    you to control which files in the filesystem may be read. Care
    should be taken with any files which are world readable to ensure
    that they are safe for reading by all users who have access to that
    filesystem.
   </p>
   <p class="simpara">
    Since <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> was designed to allow user level access to the filesystem,
    it&apos;s entirely possible to write a <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> script that will allow you
    to read system files such as /etc/passwd, modify your ethernet
    connections, send massive printer jobs out, etc. This has some
    obvious implications, in that you need to ensure that the files
    that you read from and write to are the appropriate ones.
   </p>
   <p class="simpara">
    Consider the following script, where a user indicates that they&apos;d
    like to delete a file in their home directory. This assumes a
    situation where a <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> web interface is regularly used for file
    management, so the Apache user is allowed to delete files in
    the user home directories.
   </p>
   <p class="para">
    <div class="example" id="context.curl.example-post">
     <p><strong>Example #1 Poor variable checking leads to....</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&#xA0;remove&#xA0;a&#xA0;file&#xA0;from&#xA0;the&#xA0;user&apos;s&#xA0;home&#xA0;directory<br></span><span style="color: #0000BB">$username&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_name&apos;</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$userfile&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_filename&apos;</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$homedir&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">);<br><br>echo&#xA0;</span><span style="color: #DD0000">&quot;The&#xA0;file&#xA0;has&#xA0;been&#xA0;deleted!&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   Since the username and the filename are postable from a user form, 
   they can submit a username and a filename belonging to someone else, 
   and delete it even if they&apos;re not supposed to be allowed to do so.
   In this case, you&apos;d want to use some other form of authentication.
   Consider what could happen if the variables submitted were
   &quot;../etc/&quot; and &quot;passwd&quot;. The code would then effectively read:
    <div class="example" id="context.zip.example-password">
     <p><strong>Example #2 ... A filesystem attack</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&#xA0;removes&#xA0;a&#xA0;file&#xA0;from&#xA0;anywhere&#xA0;on&#xA0;the&#xA0;hard&#xA0;drive&#xA0;that<br>//&#xA0;the&#xA0;PHP&#xA0;user&#xA0;has&#xA0;access&#xA0;to.&#xA0;If&#xA0;PHP&#xA0;has&#xA0;root&#xA0;access:<br></span><span style="color: #0000BB">$username&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_name&apos;</span><span style="color: #007700">];&#xA0;</span><span style="color: #FF8000">//&#xA0;&quot;../etc&quot;<br></span><span style="color: #0000BB">$userfile&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_filename&apos;</span><span style="color: #007700">];&#xA0;</span><span style="color: #FF8000">//&#xA0;&quot;passwd&quot;<br></span><span style="color: #0000BB">$homedir&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;&#xA0;</span><span style="color: #FF8000">//&#xA0;&quot;/home/../etc&quot;<br><br></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">);&#xA0;</span><span style="color: #FF8000">//&#xA0;&quot;/home/../etc/passwd&quot;<br><br></span><span style="color: #007700">echo&#xA0;</span><span style="color: #DD0000">&quot;The&#xA0;file&#xA0;has&#xA0;been&#xA0;deleted!&quot;</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
    There are two important measures you should take to prevent these
    issues.
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       Only allow limited permissions to the <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> web user binary.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       Check all variables which are submitted.
      </span>
     </li>
    </ul>
    Here is an improved script:
    <div class="example" id="wrappers.http.example.basic">
     <p><strong>Example #3 More secure file name checking</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&#xA0;removes&#xA0;a&#xA0;file&#xA0;from&#xA0;the&#xA0;hard&#xA0;drive&#xA0;that<br>//&#xA0;the&#xA0;PHP&#xA0;user&#xA0;has&#xA0;access&#xA0;to.<br></span><span style="color: #0000BB">$username&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;REMOTE_USER&apos;</span><span style="color: #007700">];&#xA0;</span><span style="color: #FF8000">//&#xA0;using&#xA0;an&#xA0;authentication&#xA0;mechanism<br></span><span style="color: #0000BB">$userfile&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">basename</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_filename&apos;</span><span style="color: #007700">]);<br></span><span style="color: #0000BB">$homedir&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$filepath&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;<br><br>if&#xA0;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">)&#xA0;&amp;&amp;&#xA0;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$logstring&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;Deleted&#xA0;</span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>}&#xA0;else&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #0000BB">$logstring&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;Failed&#xA0;to&#xA0;delete&#xA0;</span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n&quot;</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">$fp&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;/home/logging/filedelete.log&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;a&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br><br>echo&#xA0;</span><span style="color: #0000BB">htmlentities</span><span style="color: #007700">(</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">ENT_QUOTES</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
    However, even this is not without its flaws. If your authentication
    system allowed users to create their own user logins, and a user
    chose the login &quot;../etc/&quot;, the system is once again exposed. For
    this reason, you may prefer to write a more customized check:
    <div class="example" id="example-355">
     <p><strong>Example #4 More secure file name checking</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$username&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;REMOTE_USER&apos;</span><span style="color: #007700">];&#xA0;</span><span style="color: #FF8000">//&#xA0;using&#xA0;an&#xA0;authentication&#xA0;mechanisim<br></span><span style="color: #0000BB">$userfile&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">&apos;user_submitted_filename&apos;</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$homedir&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$filepath&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style="color: #007700">=&#xA0;</span><span style="color: #DD0000">&quot;</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">&quot;</span><span style="color: #007700">;<br><br>if&#xA0;(!</span><span style="color: #0000BB">ctype_alnum</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">)&#xA0;||&#xA0;!</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">&apos;/^(?:[a-z0-9_-]|\.(?!\.))+$/iD&apos;</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$userfile</span><span style="color: #007700">))&#xA0;{<br>&#xA0;&#xA0;&#xA0;&#xA0;die(</span><span style="color: #DD0000">&quot;Bad&#xA0;username/filename&quot;</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">//etc...<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
   <p class="para">
    Depending on your operating system, there are a wide variety of files
    which you should be concerned about, including device entries (/dev/
    or COM1), configuration files (/etc/ files and the .ini files),
    well known file storage areas (/home/, My Documents), etc. For this
    reason, it&apos;s usually easier to create a policy where you forbid
    everything except for what you explicitly allow.
   </p>
   

  