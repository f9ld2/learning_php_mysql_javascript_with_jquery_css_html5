---
layout: default
---

  <h2 class="title">Basic query monitoring</h2>
  <p class="para">
   Basic monitoring of a query statement is easy with PECL/mysqlnd_uh.
   Combined with <span class="function"><a href="function.debug-print-backtrace.html" class="function">debug_print_backtrace()</a></span> it can become a powerful
   tool, for example, to find the origin of certain statement. This may
   be desired when searching for slow queries but also after database
   refactoring to find code still accessing deprecated databases or
   tables. The latter may be a complicated matter to do otherwise, especially if
   the application uses auto-generated queries.
  </p>
  <p class="para">
   <div class="example" id="example-2121">
    <p><strong>Example #1 Basic Monitoring</strong></p>
        <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">class&#xA0;</span><span style="color: #0000BB">conn_proxy&#xA0;</span><span style="color: #007700">extends&#xA0;</span><span style="color: #0000BB">MysqlndUhConnection&#xA0;</span><span style="color: #007700">{<br>&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;</span><span style="color: #0000BB">debug_print_backtrace</span><span style="color: #007700">();<br>&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br>&#xA0;}<br>}<br>class&#xA0;</span><span style="color: #0000BB">stmt_proxy&#xA0;</span><span style="color: #007700">extends&#xA0;</span><span style="color: #0000BB">MysqlndUhPreparedStatement&#xA0;</span><span style="color: #007700">{<br>&#xA0;public&#xA0;function&#xA0;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&#xA0;{<br>&#xA0;&#xA0;</span><span style="color: #0000BB">debug_print_backtrace</span><span style="color: #007700">();<br>&#xA0;&#xA0;return&#xA0;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">,&#xA0;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br>&#xA0;}<br>}<br></span><span style="color: #0000BB">mysqlnd_uh_set_connection_proxy</span><span style="color: #007700">(new&#xA0;</span><span style="color: #0000BB">conn_proxy</span><span style="color: #007700">());<br></span><span style="color: #0000BB">mysqlnd_uh_set_statement_proxy</span><span style="color: #007700">(new&#xA0;</span><span style="color: #0000BB">stmt_proxy</span><span style="color: #007700">());<br><br></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;Proxies&#xA0;installed...\n&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$pdo&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;mysql:host=localhost;dbname=test&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;root&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$pdo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;1&#xA0;AS&#xA0;_one&#xA0;FROM&#xA0;DUAL&quot;</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">FETCH_ASSOC</span><span style="color: #007700">));<br><br></span><span style="color: #0000BB">$mysqli&#xA0;</span><span style="color: #007700">=&#xA0;new&#xA0;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;localhost&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;root&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;&quot;</span><span style="color: #007700">,&#xA0;</span><span style="color: #DD0000">&quot;test&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">&quot;SELECT&#xA0;1&#xA0;AS&#xA0;_two&#xA0;FROM&#xA0;DUAL&quot;</span><span style="color: #007700">);<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
#0  conn_proxy-&gt;query(Resource id #19, SELECT 1 AS _one FROM DUAL)
#1  PDO-&gt;query(SELECT 1 AS _one FROM DUAL) called at [example.php:19]
array(1) {
  [0]=&gt;
  array(1) {
    [&quot;_one&quot;]=&gt;
    string(1) &quot;1&quot;
  }
}
#0  stmt_proxy-&gt;prepare(Resource id #753, SELECT 1 AS _two FROM DUAL)
#1  mysqli-&gt;prepare(SELECT 1 AS _two FROM DUAL) called at [example.php:22]
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   For basic query monitoring you should install a connection and a prepared statement
   proxy. The connection proxy should subclass <span class="function"><a href="mysqlnduhconnection.query.html" class="function">MysqlndUhConnection::query()</a></span>.
   All database queries not using native prepared statements will call this method.
   In the example the <em>query</em> function is invoked by a PDO call.
   By default, <em>PDO_MySQL</em> is using prepared statement emulation.
  </p>
  <p class="para">
   All native prepared statements are prepared with the <em>prepare</em>
   method of <em>mysqlnd</em> exported through
   <span class="methodname"><a href="mysqlnduhpreparedstatement.prepare.html" class="methodname">MysqlndUhPreparedStatement::prepare()</a></span>. Subclass
   <a href="class.mysqlnduhpreparedstatement.html" class="classname">MysqlndUhPreparedStatement</a> and overwrite <em>prepare</em>
   for native prepared statement monitoring.
  </p>
 